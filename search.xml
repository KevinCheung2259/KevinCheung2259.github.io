<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>EP06-vLLMæºç è®²è§£ç›´æ’­ç¬”è®°-vLLM v1 ä»™äººæŒ‡è·¯</title>
      <link href="/2025/04/21/vLLM-EP06/"/>
      <url>/2025/04/21/vLLM-EP06/</url>
      
        <content type="html"><![CDATA[<h1 id="FIXME-EP06-vLLM-æºç è®²è§£ç›´æ’­ç¬”è®°"><a href="#FIXME-EP06-vLLM-æºç è®²è§£ç›´æ’­ç¬”è®°" class="headerlink" title="[FIXME][EP06] vLLM æºç è®²è§£ç›´æ’­ç¬”è®°"></a>[FIXME][EP06] vLLM æºç è®²è§£ç›´æ’­ç¬”è®°</h1><h2 id="EP06-vLLM-v1-ä»™äººæŒ‡è·¯"><a href="#EP06-vLLM-v1-ä»™äººæŒ‡è·¯" class="headerlink" title="EP06: vLLM v1 ä»™äººæŒ‡è·¯"></a>EP06: vLLM v1 ä»™äººæŒ‡è·¯</h2><p>ç›´æ’­å›çœ‹é“¾æ¥ï¼š<a href="https://www.youtube.com/watch?v=6AcgEPmpHIc">https://www.youtube.com/watch?v=6AcgEPmpHIc</a></p><p>ç‰¹åˆ«é¸£è°¢ï¼šç»„ç»‡è€…@æœˆçƒå¤§å”, ä¸»è®²äºº@Du Kuntai, é£è¡Œå˜‰å®¾@YM</p><p>vLLMå®˜æ–¹åšå®¢ï¼š<a href="https://blog.vllm.ai/2025/01/27/v1-alpha-release.html">https://blog.vllm.ai/2025/01/27/v1-alpha-release.html</a></p><h3 id="ğŸ’¥-1-Why-v1-Motivation"><a href="#ğŸ’¥-1-Why-v1-Motivation" class="headerlink" title="ğŸ’¥ 1. Why v1 ? (Motivation)"></a>ğŸ’¥ 1. Why v1 ? (Motivation)</h3><ul><li><p>vLLM v0 è¿è¡Œèµ·æ¥æœ‰ç‚¹æ…¢ (CPU overhead)</p></li><li><p>vLLM v0 çš„ä»£ç å¯è¯»æ€§å’Œå¯äºŒæ¬¡å¼€å‘çš„èƒ½åŠ›è¾ƒå·®</p><ul><li>æ¯”å¦‚v0çš„Schedulerä»£ç æœ‰2kè¡Œï¼Œæ”¹è¿›åçš„v1ä»£ç åªæœ‰800è¡Œ</li><li>ä»£ç æ”¹åŠ¨ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«</li></ul></li><li><p>å¦‚ä½•æ¨è¿›ä»£ç é‡æ„?</p><ul><li>YM: åœ¨ç¨³å®šä¹‹åå®Œæˆåˆ‡æ¢</li><li>å¼€å‘å®Œæˆååˆ‡æ¢çš„é—®é¢˜ï¼šä¸åˆ‡å®é™…ï¼Œæ–°åŠŸèƒ½ &amp; æ–°æ¨¡å‹çš„ä¸æ–­æ¶Œç°</li><li>vLLM æœ€é‡è¦çš„ç‰¹æ€§: å¯¹æ–°æ¨¡å‹çš„æ”¯æŒ!!!<ul><li>æ˜“ç”¨</li><li>æ€§èƒ½</li><li>day0 support(åœ¨æ–°æ¨¡å‹åˆšå‘å¸ƒå°±é€‚é…) â€“&gt; tech debt(æŠ€æœ¯å€ºï¼Œ<br>  ç”±äºç€æ€¥ä¸ºæ–°åŠŸèƒ½æä¾›æ”¯æŒè€Œå¯¼è‡´å·¥ç¨‹ä¸Šçš„ä¸ä¼˜é›…ï¼Œå¯èƒ½ä¼šå½±å“åç»­æ–°åŠŸèƒ½çš„æ”¯æŒ)</li></ul></li></ul></li><li><p>vLLMé‡æ„ä»£ç çš„å‡ ä¸ªé˜¶æ®µ</p><ul><li>Stage 1: v1 çš„å¼€å‘</li><li>Stage 2: v0 &amp; v1 å…±å­˜</li><li>Stage 3: é»˜è®¤å¼€å¯ v1 (ç°åœ¨)</li><li>Stage 4: v1 æ¯” v0 å…·æœ‰æ›´å¤šå¯æ”¯æŒçš„åŠŸèƒ½</li><li>Stage 5: ç§»é™¤ v0 çš„ä»£ç </li></ul></li><li><p>ä¸ºä»€ä¹ˆPytorchèµ¢äº†Tensorflow? è¿™ä¹Ÿæ˜¯vLLMéœ€è¦é‡æ„çš„åŸå› </p><ul><li>Tensorflowæ›¾ç»è¯´è¿‡ï¼šæˆ‘ä»¬æœ‰æ›´å¤šçš„åŠŸèƒ½ï¼Œæ›´å¥½çš„æ€§èƒ½å’Œæ›´å¤šçš„ç¡¬ä»¶æ”¯æŒ</li><li>åŸå› ï¼šç ”ç©¶å‘˜æ›´å–œæ¬¢pytorchï¼Œç„¶åä»–ä»¬æ¯•ä¸šäº†â€¦</li><li>vLLM v0 å¯¹ç ”ç©¶å‘˜ä»¬ä¸å¤Ÿå‹å¥½</li></ul></li></ul><h3 id="ğŸ“Œ-2-Scheduler"><a href="#ğŸ“Œ-2-Scheduler" class="headerlink" title="ğŸ“Œ 2. Scheduler"></a>ğŸ“Œ 2. Scheduler</h3><p>ä»£ç ï¼š<code>vllm/v1/core/sched/scheduler.py</code></p><ul><li>è°ƒåº¦ï¼šç»Ÿä¸€ä¸åŒæ–¹æ³•ä¸‹è°ƒåº¦tokensçš„é€»è¾‘<ul><li>æ¯”å¦‚ä¸€ä¸ªé•¿åº¦ä¸º500 tokensçš„è¯·æ±‚<ul><li>Prefill: {r: 500}</li><li>Decode: {r: 1}</li><li>Chunk prefill: 256, {r: 256}, {r: 244}</li><li>Prefix caching: r å‘½ä¸­äº†200ä¸ªå‰ç¼€token: {r: 300}</li></ul></li><li>Speculative decoding: æ¯ä¸ªè¯·æ±‚5ä¸ªtoken {r: 5}</li><li>Multi-modality: r: 100ä¸ªæ–‡æœ¬tokens, 500ä¸ªå›¾åƒtokens, 100ä¸ªæ–‡æœ¬tokens:<ul><li>{r: 100}, {r: 500}, {r: 100}</li></ul></li></ul></li><li>ç®€åŒ–è°ƒåº¦é€»è¾‘ï¼Œé»˜è®¤ä½¿ç”¨chunk prefillï¼Œä¸ä¸¥æ ¼åŒºåˆ†prefillå’Œdecode</li><li>åŒæ­¥è°ƒåº¦</li></ul><h3 id="ğŸ””-3-General-architecture"><a href="#ğŸ””-3-General-architecture" class="headerlink" title="ğŸ”” 3. General architecture"></a>ğŸ”” 3. General architecture</h3><ul><li>å‰åç«¯è§£è€¦ï¼ŒScheduler, API Server, (de) tokenizeråˆ†åœ¨ä¸åŒçš„è¿›ç¨‹ä¸Š<br>  <img src="/posts_img/vLLM-EP06/v1_server_architecture.png?60">  <!-- <img src="posts_img/vLLM-EP06/v1_server_architecture.png" alt="v1 server architecture" width="600"> --></li><li>Scheduler &amp; Worker åœ¨ä¸åŒçš„è¿›ç¨‹ä¸­<ul><li>Scheduler, Rank 0 workeråœ¨åŒä¸€ä¸ªprocessä¸­å¹¶å­˜ï¼ˆåœ¨ä¹‹å‰çš„v0ç‰ˆæœ¬ä¸Šï¼‰<br>  <img src="/posts_img/vLLM-EP06/v1_tp_architecture.png?50">  <!-- <img src="posts_img/vLLM-EP06/v1_tp_architecture.png" alt="v1 tp architecture" width="500"> --></li></ul></li></ul><p>è¦è·å–æœ€æ–°çš„vLLMæ›´æ–°çš„å¹²è´§ï¼Œå¯ä»¥æŸ¥çœ‹githubä»“åº“é‡Œmeetupçš„slices</p><ul><li>ä¾‹å¦‚ï¼š<a href="https://docs.google.com/presentation/d/19cp6Qu8u48ihB91A064XfaXruNYiBOUKrBxAmDOllOo/edit?usp=sharing">https://docs.google.com/presentation/d/19cp6Qu8u48ihB91A064XfaXruNYiBOUKrBxAmDOllOo/edit?usp=sharing</a></li></ul><h3 id="âš¡-3-Worker"><a href="#âš¡-3-Worker" class="headerlink" title="âš¡ 3. Worker"></a>âš¡ 3. Worker</h3><ul><li>Persistent batching<ul><li>å¯¹äºä»CPUåˆ°GPUä¹‹é—´çš„æ•°æ®ä¼ è¾“ï¼Œæˆ‘ä»¬åªéœ€è¦ä¼ ä¸Šä¸€ä¸ªbatchçš„tensorå¢é‡å³å¯</li><li>è¿™ä¸ªæŠ€æœ¯ä¸æ–°</li><li>ç›¸å…³ä»£ç ä½äº: <code>vllm/v1/worker/gpu_input_batch.py</code>, <code>vllm/v1/worker/gpu_worker.py</code></li></ul></li><li>Piecewise cudagraph<ul><li>Cudagraph<ul><li>è®°å½•äº†ä¸€ç³»åˆ—CUDA kernel operationç„¶ååœ¨ä¹‹åé‡æ”¾</li><li>CPU å¯åŠ¨ CUDA kernel æ˜¯å¾ˆæ…¢çš„, ä½†æ˜¯è¿è¡Œä¸€ä¸ªCUDA kernelæ˜¯éå¸¸å¿«çš„</li><li>CUDAGraph: å¯¹äºä¸€ç³»åˆ—çš„CUDA kernel, CPUåªéœ€è¦å¯åŠ¨ä¸€æ¬¡<ul><li>ä¸ä¼šè®°å½•CPU operation, ä¸§å¤±äº†çµæ´»æ€§</li></ul></li></ul></li><li>CUDAGraphçš„ç¼ºç‚¹ï¼š ä¸§å¤±äº†çµæ´»æ€§</li><li>Observation: çµæ´»æ€§éœ€æ±‚é€šå¸¸å‘ç”Ÿåœ¨attention layerè€Œä¸åœ¨MLP layer</li><li>è§£å†³æ–¹æ³•ï¼špiece-wise cudagraph, åªåœ¨MLPå±‚è®°å½•cuda graphï¼Œattentionçš„éƒ¨åˆ†ä½¿ç”¨pytorch eager mode</li></ul></li></ul><h3 id="ğŸ’¡-4-Attention-kernel"><a href="#ğŸ’¡-4-Attention-kernel" class="headerlink" title="ğŸ’¡ 4. Attention kernel"></a>ğŸ’¡ 4. Attention kernel</h3><ul><li>ç®€åŒ–äº†è®¾ç½®<ul><li>Key observation: å¯¹äºæ¯ä¸ªattention kernel, æœ€åŸºæœ¬çš„ä¿¡æ¯æ¥æºäºå¤§æ¦‚6-7ä¸ªtensors</li></ul></li><li>Cascade inference (çº§è”æ¨ç†)<ul><li>å‡è®¾æœ‰è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯<ul><li>System prompt: 10,000 tokens</li><li>10 user chat, each chat 100 tokens</li></ul></li><li>å¸¸è§„çš„attentionéœ€è¦è¯»å–çš„å†…å­˜å¤§å°<ul><li>ï¼ˆ10ï¼Œ000 + 100ï¼‰ * 10 tokens</li></ul></li><li>Cascade inference<ul><li>10,000 + 100 * 10 tokens</li></ul></li><li>vLLM: ä½¿ç”¨performance modelå»å†³å®šä»€ä¹ˆæ—¶å€™ä½¿ç”¨cascade inference<ul><li><code>vllm/v1/attention/backends/flash_attn.py: use_cascade attention</code></li></ul></li></ul></li></ul><h3 id="ğŸ”-6-Multi-model"><a href="#ğŸ”-6-Multi-model" class="headerlink" title="ğŸ” 6. Multi-model"></a>ğŸ” 6. Multi-model</h3><ul><li>Embedding as the KV cache reference</li><li>KV cache ç®¡ç†ï¼ˆincomingï¼‰<ul><li>Hybrid memory allocatorâ€¦</li></ul></li><li>è¿™éƒ¨åˆ†å†…å®¹å¤ªå¤šï¼Œå€¼å¾—å¼€ä¸ªä¸“é¢˜æ¥è®²è®²ï¼Œä¸‹æ¬¡è§ï¼</li></ul>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLM </tag>
            
            <tag> Inference </tag>
            
            <tag> vLLM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EP05-vLLMæºç è®²è§£ç›´æ’­ç¬”è®°-Prefix Caching</title>
      <link href="/2025/04/16/vLLM-EP05/"/>
      <url>/2025/04/16/vLLM-EP05/</url>
      
        <content type="html"><![CDATA[<h1 id="FIXME-EP05-vLLM-æºç è®²è§£ç›´æ’­ç¬”è®°"><a href="#FIXME-EP05-vLLM-æºç è®²è§£ç›´æ’­ç¬”è®°" class="headerlink" title="[FIXME][EP05] vLLM æºç è®²è§£ç›´æ’­ç¬”è®°"></a>[FIXME][EP05] vLLM æºç è®²è§£ç›´æ’­ç¬”è®°</h1><h2 id="EP05-Prefix-Caching"><a href="#EP05-Prefix-Caching" class="headerlink" title="EP05: Prefix Caching"></a>EP05: Prefix Caching</h2><p>ç›´æ’­å›çœ‹é“¾æ¥ï¼š<a href="https://www.youtube.com/watch?v=mWvqA_BNtsU">https://www.youtube.com/watch?v=mWvqA_BNtsU</a></p><p>ç‰¹åˆ«é¸£è°¢ï¼šæœˆçƒå¤§å”, Cheng Yihua, Kaz å¤§ä½¬å¸¦æ¥çš„ç²¾å½©è®²è§£</p><h3 id="ğŸ“Œ-1-LLMä½¿ç”¨KVCacheè¿›è¡Œæ¨ç†çš„åŸºæœ¬å®ç°"><a href="#ğŸ“Œ-1-LLMä½¿ç”¨KVCacheè¿›è¡Œæ¨ç†çš„åŸºæœ¬å®ç°" class="headerlink" title="ğŸ“Œ 1. LLMä½¿ç”¨KVCacheè¿›è¡Œæ¨ç†çš„åŸºæœ¬å®ç°"></a>ğŸ“Œ 1. LLMä½¿ç”¨KVCacheè¿›è¡Œæ¨ç†çš„åŸºæœ¬å®ç°</h3><p>è¾“å…¥: tokens, å·²æœ‰çš„kvcache</p><p>è¾“å‡º: tokens, æ›´æ–°åçš„kvcache</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">llm.interence(</span><br><span class="line">    input_tokens: <span class="built_in">list</span>[<span class="built_in">int</span>],  <span class="comment"># N tokens</span></span><br><span class="line">    previous_kv_cache: <span class="built_in">list</span>[Tensor],  <span class="comment"># N tokens&#x27; kv cache M &lt; N</span></span><br><span class="line">) -&gt; output_tokens, new_kv_cache</span><br><span class="line"></span><br><span class="line">output_tokens: <span class="comment"># N&#x27; new token</span></span><br><span class="line">new_kv_cache: <span class="comment"># kv cache of N + N&#x27; tokens</span></span><br></pre></td></tr></table></figure><p>æŠ›å¼€vllmè¿˜æ˜¯sglangç­‰ä¸»æµæ¡†æ¶çš„å…·ä½“å®ç°ç»†èŠ‚ä¸è°ˆï¼Œå¤§å®¶å¯ä»¥æ€è€ƒä¸‹ï¼ŒKVCacheçš„ç®¡ç†æœ‰å“ªäº›ç‰¹ç‚¹ï¼Œåº”è¯¥æ€ä¹ˆå»å®ç°å®ƒçš„å…·ä½“åŠŸèƒ½ï¼Ÿ</p><h3 id="âš¡-2-Prefix-Matching-å‰ç¼€åŒ¹é…"><a href="#âš¡-2-Prefix-Matching-å‰ç¼€åŒ¹é…" class="headerlink" title="âš¡ 2. Prefix Matching (å‰ç¼€åŒ¹é…)"></a>âš¡ 2. Prefix Matching (å‰ç¼€åŒ¹é…)</h3><p>KVCacheçš„å­˜å–æœ¬è´¨ä¸Šä¸ä¼ ç»Ÿçš„é”®-å€¼å¯¹æ•°æ®åº“æ˜¯ç±»ä¼¼çš„ï¼Œå¦‚Redisç­‰ï¼ŒKey: [tokens]ï¼ŒValue: [KV cache tensors]ã€‚</p><p>åŸºæœ¬çš„åŠŸèƒ½åŒ…æ‹¬KVçš„å­˜å‚¨ä¸è·å–ï¼Œå¯ä»¥æŠ½è±¡æˆä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">KVCacheStore</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">tokens, kv_cache_tensors</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve</span>(<span class="params">tokens</span>) -&gt; kkv_cache_tensors</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>ä¸æ™®é€šçš„é”®-å€¼å¯¹æ•°æ®åº“åŠŸèƒ½ä¸åŒï¼ŒKVCacheå…·æœ‰å‰ç¼€åŒ¹é…çš„ç‰¹ç‚¹ï¼š</p><ul><li><p>å‡è®¾æˆ‘ä»¬æœ‰Tokens 1å’ŒTokens 2: </p><p>Tokens 1: ABCD<code>E</code> -&gt; [KV1, KV2, KV3, KV4, <code>KV5</code>]</p><p>Tokens 2: ABCD<code>F</code> -&gt; [KV1, KV2, KV3, KV4, <code>KV6</code>]</p></li><li><p>å­˜å…¥Tokens 1çš„KV:</p><p>  kv_cache_store.store(â€œABCDEâ€, [KV1, KV2, KV3, KV4, KV5])</p></li><li><p>å–å‡ºTokens 2çš„KV: </p><p>  kv_cache_store.retrieve(â€œABCDFâ€) -&gt; [KV1, KV2, KV3, KV4]</p><p>  ç”±äºæœ€åä¸€ä¸ªtokenä¸åŒï¼Œå› æ­¤åªèƒ½è¿”å›å‰ç¼€ç›¸åŒéƒ¨åˆ†çš„å¯¹åº”çš„KV</p></li><li><p><strong>Trie</strong>ï¼Œä¹Ÿç§°ä¸ºå‰ç¼€æ ‘æˆ–å­—å…¸æ ‘ï¼Œæ˜¯ä¸€ç§é«˜æ•ˆçš„æ ‘å½¢æ•°æ®ç»“æ„ï¼Œå¸¸ç”¨äºå­˜å‚¨å’Œæ£€ç´¢å­—ç¬¦ä¸²é›†åˆã€‚<br>å¯ä»¥è®©Trieçš„æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªtokenï¼Œä»æ ¹èŠ‚ç‚¹åˆ°æŸä¸ªèŠ‚ç‚¹çš„è·¯å¾„è¡¨ç¤ºä¸€ä¸ªtokenåºåˆ—ï¼Œç‰¹åˆ«é€‚åˆå¤„ç†å‰ç¼€åŒ¹é…é—®é¢˜ã€‚</p></li></ul><h3 id="ğŸ’¡-3-vLLMä¸­KVCacheçš„è®¾è®¡"><a href="#ğŸ’¡-3-vLLMä¸­KVCacheçš„è®¾è®¡" class="headerlink" title="ğŸ’¡ 3. vLLMä¸­KVCacheçš„è®¾è®¡"></a>ğŸ’¡ 3. vLLMä¸­KVCacheçš„è®¾è®¡</h3><ul><li><p>é¦–å…ˆï¼Œä¼šå°†tokensæ ¹æ®chunk_sizeè¿›è¡Œåˆ†å—ï¼Œå‡è®¾chunk_size&#x3D;2</p><p>  â€œABCDEFâ€ -&gt; â€œABâ€, â€œCDâ€, â€œEFâ€ -&gt; list of chunked prefix hashes</p><p>  chunk_sizeçš„å¤§å°æ˜¯ä¸€ä¸ªtrade-offï¼Œsizeå¤ªå¤§ï¼ŒåŒ¹é…çš„ç²¾ç¡®åº¦ä½ï¼Œsizeå¤ªå°ï¼ŒI&#x2F;Oçš„æ•ˆç‡å·®ã€‚<br>  åœ¨vLLMä¸­ï¼Œchunk_sizeé»˜è®¤ä¸º16, sglangå¯ä»¥ä¸º1ã€‚</p><p>  ï¼ˆè¿™é‡Œè¯´çš„chunk_sizeå¯¹åº”vllmä»£ç ä¸­çš„block_sizeï¼Œæ³¨æ„åŒºåˆ†ä¸chunk prefillä¸­chunk_sizeçš„æ¦‚å¿µã€‚ï¼‰</p></li><li><p>ç„¶åï¼Œå¯¹chunksè¿›è¡Œå“ˆå¸Œï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œæ¯ä¸ªchunkçš„å“ˆå¸Œå€¼éƒ½åŒ…å«äº†è¯¥chunkå‰ç¼€çš„ä¿¡æ¯ï¼Œ<br>ç”¨äºæ¨¡æ‹Ÿå‰ç¼€æ ‘çš„å®ç°  </p>  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">prefix_hash = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> chunk <span class="keyword">in</span> chunk_tokens:  <span class="comment"># [&quot;AB&quot;, &quot;CD&quot;, &quot;EF&quot;]</span></span><br><span class="line">    chunk_hash = <span class="built_in">hash</span>(prefix + chunk)</span><br><span class="line">    prefix_hash = chunk_hash</span><br></pre></td></tr></table></figure></li><li><p>æ¥ç€æ˜¯å­˜å–çš„åŸºæœ¬å®ç°</p>  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Given chunked prefix hashes, chunk kv cache</span></span><br><span class="line"><span class="comment"># store</span></span><br><span class="line"><span class="keyword">for</span> chunk_hash, chunk_kv <span class="keyword">in</span> <span class="built_in">zip</span>(...):</span><br><span class="line">    redis.put(chunk_hash, chunk_kv)</span><br><span class="line"></span><br><span class="line"><span class="comment"># retrieve</span></span><br><span class="line"><span class="keyword">for</span> chunk_hash <span class="keyword">in</span> ...:</span><br><span class="line">    kv_chunk = redis.get(chunk_hash)</span><br><span class="line">    <span class="keyword">if</span> kv_chunk <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure></li><li><p>Evictionï¼ˆé©±é€ï¼‰</p><p>  éšç€æ¨ç†çš„ä¸æ–­è¿›è¡Œï¼Œå½“å†…å­˜ä¸å¤Ÿç”¨äº†ï¼Œéœ€è¦å¯¹æŸäº›KVè¿›è¡Œé©±é€ã€‚</p><p>  Evictionçš„è§„åˆ™ï¼šå¯¹äºrequestä»åå¾€å‰é©±é€ï¼Œå°½å¯èƒ½å¤ç”¨prefix cache</p><ul><li>â€œABCDEFâ€ â€“&gt; [â€œABâ€, KV1], [â€œCDâ€, KV2], [â€œEFâ€, KV3]</li><li>ä»KV3ï¼ŒKV2ï¼ŒKV1çš„é¡ºåºä»åå¾€å‰é©±é€</li></ul><p>  å¯ä»¥ä½¿ç”¨LRU, LFUç­‰é©±é€ç­–ç•¥</p></li></ul><h3 id="ğŸ”-4-vLLMä¸­KVCacheçš„å…·ä½“å®ç°"><a href="#ğŸ”-4-vLLMä¸­KVCacheçš„å…·ä½“å®ç°" class="headerlink" title="ğŸ” 4. vLLMä¸­KVCacheçš„å…·ä½“å®ç°"></a>ğŸ” 4. vLLMä¸­KVCacheçš„å…·ä½“å®ç°</h3><h4 id="Retrevie"><a href="#Retrevie" class="headerlink" title="Retrevie"></a>Retrevie</h4><p>â€œvllm&#x2F;v1&#x2F;core&#x2F;sched&#x2F;scheduler.pyâ€</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Get already-cached tokens.</span></span><br><span class="line">computed_blocks, num_computed_tokens = \</span><br><span class="line">    <span class="variable language_">self</span>.kv_cache_manager.get_computed_blocks(request)</span><br></pre></td></tr></table></figure><p>get_computed_blocksçš„å‡½æ•°å®šä¹‰</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_computed_blocks</span>(<span class="params"></span></span><br><span class="line"><span class="params">            self, request: Request</span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">list</span>[KVCacheBlock], <span class="built_in">int</span>]:</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment"># The block hashes for the request may already be computed</span></span><br><span class="line">        <span class="comment"># if the scheduler has tried to schedule the request before.</span></span><br><span class="line">        block_hashes = <span class="variable language_">self</span>.req_to_block_hashes[request.request_id]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> block_hashes:</span><br><span class="line">            <span class="comment"># è®¡ç®—æ¯ä¸ªblockçš„hash</span></span><br><span class="line">            block_hashes = hash_request_tokens(<span class="variable language_">self</span>.caching_hash_fn,</span><br><span class="line">                                               <span class="variable language_">self</span>.block_size, request)</span><br><span class="line">            <span class="variable language_">self</span>.req_to_block_hashes[request.request_id] = block_hashes</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment"># æ‰¾åˆ°æœ€é•¿å‰ç¼€åŒ¹é…</span></span><br><span class="line">        computed_blocks = (</span><br><span class="line">            <span class="variable language_">self</span>.specialized_manager.find_longest_cache_hit(block_hashes))</span><br><span class="line">        <span class="variable language_">self</span>.prefix_cache_stats.queries += <span class="built_in">len</span>(block_hashes)</span><br><span class="line">        <span class="variable language_">self</span>.prefix_cache_stats.hits += <span class="built_in">len</span>(computed_blocks)</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> computed_blocks, num_computed_tokens</span><br></pre></td></tr></table></figure><h4 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h4><p>â€œvllm&#x2F;v1&#x2F;core&#x2F;block_pool.pyâ€</p><p>åœ¨â€BlockPoolâ€ç±»ä¸­å®šä¹‰äº†KVCacheBlocksçš„ç®¡ç†æ–¹æ³•</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¼ å…¥Requestå’Œç®—å¥½çš„blockï¼Œå­˜å…¥BlockPoolä¸­</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cache_full_blocks</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        request: Request,</span></span><br><span class="line"><span class="params">        blocks: <span class="built_in">list</span>[KVCacheBlock],</span></span><br><span class="line"><span class="params">        block_hashes: <span class="built_in">list</span>[BlockHashType],</span></span><br><span class="line"><span class="params">        num_cached_blocks: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        num_full_blocks: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        block_size: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        hash_fn: <span class="type">Callable</span>,</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Cache a list of full blocks for prefix caching.</span></span><br><span class="line"><span class="string">        This function takes a list of blocks that will have their block hash</span></span><br><span class="line"><span class="string">        metadata to be updated and cached. Given a request, it computes the</span></span><br><span class="line"><span class="string">        block hashes for the blocks starting from `num_cached_blocks` to</span></span><br><span class="line"><span class="string">        `num_full_blocks`, updating the metadata for each block</span></span><br><span class="line"><span class="string">        and caching them in the `cached_block_hash_to_block`.</span></span><br></pre></td></tr></table></figure><h4 id="Eviction"><a href="#Eviction" class="headerlink" title="Eviction"></a>Eviction</h4><p>å‘ç”Ÿåœ¨â€BlockPoolâ€ç±»ä¸­çš„<code>get_new_blocks</code>å‡½æ•°ä¸­</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_new_blocks</span>(<span class="params">self, num_blocks: <span class="built_in">int</span></span>) -&gt; <span class="built_in">list</span>[KVCacheBlock]:</span><br><span class="line">        ...</span><br><span class="line">            curr_block = <span class="variable language_">self</span>.free_block_queue.popleft()</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment"># å¼€å¯äº†enable_cachingä¸”å¦‚æœæ²¡æœ‰ç©ºé—²çš„blockï¼Œéœ€è¦evictæ‰æ—§çš„block</span></span><br><span class="line">            <span class="comment"># If the block is cached, evict it.</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.enable_caching:</span><br><span class="line">                <span class="variable language_">self</span>._maybe_evict_cached_block(curr_block)</span><br><span class="line"></span><br><span class="line">            curr_block.incr_ref()</span><br><span class="line">            ret.append(curr_block)</span><br><span class="line">            idx += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_maybe_evict_cached_block</span>(<span class="params">self, block: KVCacheBlock</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        If a block is cached in `cached_block_hash_to_block`, we reset its hash</span></span><br><span class="line"><span class="string">        metadata and evict it from the cache.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            block: The block to evict.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            True if the block is evicted, False otherwise.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        block_hash = block.block_hash</span><br><span class="line">        <span class="keyword">if</span> block_hash <span class="keyword">and</span> block_hash <span class="keyword">in</span> <span class="variable language_">self</span>.cached_block_hash_to_block:</span><br><span class="line">            block.reset_hash()</span><br><span class="line">            <span class="keyword">del</span> <span class="variable language_">self</span>.cached_block_hash_to_block[block_hash][block.block_id]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.cached_block_hash_to_block[block_hash]) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">del</span> <span class="variable language_">self</span>.cached_block_hash_to_block[block_hash]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><p><code>free_block_queue.popleft()</code>æ˜¯åœ¨â€vllm&#x2F;v1&#x2F;core&#x2F;kv_cache_utilsâ€çš„<code>FreeKVCacheBlockQueue</code>ç±»ä¸­ä½¿ç”¨åŒå‘é“¾è¡¨å®ç°LRUçš„ï¼ˆç»å…¸leetcodeé¢˜ï¼‰</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FreeKVCacheBlockQueue</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">popleft</span>(<span class="params">self</span>) -&gt; KVCacheBlock:</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">self, block: KVCacheBlock</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">append</span>(<span class="params">self, block: KVCacheBlock</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_all_free_blocks</span>(<span class="params">self</span>) -&gt; <span class="built_in">list</span>[KVCacheBlock]:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><h3 id="ğŸ”‹-5-KVCacheæ„ŸçŸ¥çš„å¤šå®ä¾‹è·¯ç”±"><a href="#ğŸ”‹-5-KVCacheæ„ŸçŸ¥çš„å¤šå®ä¾‹è·¯ç”±" class="headerlink" title="ğŸ”‹ 5. KVCacheæ„ŸçŸ¥çš„å¤šå®ä¾‹è·¯ç”±"></a>ğŸ”‹ 5. KVCacheæ„ŸçŸ¥çš„å¤šå®ä¾‹è·¯ç”±</h3><h4 id="æ–¹æ¡ˆä¸€"><a href="#æ–¹æ¡ˆä¸€" class="headerlink" title="æ–¹æ¡ˆä¸€"></a>æ–¹æ¡ˆä¸€</h4><p>ä½¿ç”¨å­—ç¬¦ä¸²åŒ¹é…è€Œä¸æ˜¯åŸºäº token-ID çš„åŒ¹é…ã€‚</p><ul><li>tokenizationï¼ˆåˆ†è¯ï¼‰æœ¬èº«ç›¸å½“æ…¢ï¼ˆéœ€è¦å‡ å¾®ç§’ï¼‰ï¼Œæ‰€ä»¥å¯¹æ¯ä¸ªè¯·æ±‚éƒ½æ‰§è¡Œä¼šå¸¦æ¥å·¨å¤§çš„å¼€é”€ã€‚</li><li>å®ç°å­—ç¬¦ä¸²æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ä½¿ç”¨ Redisï¼‰ä½œä¸ºå­˜å‚¨åç«¯ã€‚</li></ul><h4 id="æ–¹æ¡ˆäºŒ"><a href="#æ–¹æ¡ˆäºŒ" class="headerlink" title="æ–¹æ¡ˆäºŒ"></a>æ–¹æ¡ˆäºŒ</h4><p>è·¯ç”±å™¨å¯ä»¥å‘ KV ç¼“å­˜ç®¡ç†ç³»ç»Ÿå‘é€è¯·æ±‚ï¼šå“ªä¸ªæœåŠ¡å™¨æœ‰æœ€é•¿çš„åŒ¹é…å‰ç¼€ï¼Ÿ<br>vLLM production stack å›¢é˜Ÿçš„è§£å†³æ–¹æ¡ˆï¼š<br><a href="https://github.com/vllm-project/production-stack/issues/59">https://github.com/vllm-project/production-stack/issues/59</a></p><h4 id="KVcache-aware-VS-Load-balance"><a href="#KVcache-aware-VS-Load-balance" class="headerlink" title="KVcache aware VS Load balance"></a>KVcache aware VS Load balance</h4><p>è¿™é‡Œæœ‰ä¸ªtrade-off, KV ç¼“å­˜æ„ŸçŸ¥è·¯ç”±å¯èƒ½ä¼šå°†è¯·æ±‚è·¯ç”±åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™å¯¹è´Ÿè½½å‡è¡¡ä¸åˆ©ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLM </tag>
            
            <tag> Inference </tag>
            
            <tag> vLLM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EP04-vLLMæºç è®²è§£ç›´æ’­ç¬”è®°-Speculative Decoding</title>
      <link href="/2025/04/05/vLLM-EP04/"/>
      <url>/2025/04/05/vLLM-EP04/</url>
      
        <content type="html"><![CDATA[<h1 id="FIXME-EP04-vLLM-æºç è®²è§£ç›´æ’­ç¬”è®°"><a href="#FIXME-EP04-vLLM-æºç è®²è§£ç›´æ’­ç¬”è®°" class="headerlink" title="[FIXME][EP04] vLLM æºç è®²è§£ç›´æ’­ç¬”è®°"></a>[FIXME][EP04] vLLM æºç è®²è§£ç›´æ’­ç¬”è®°</h1><h2 id="EP04-Speculative-Decoding"><a href="#EP04-Speculative-Decoding" class="headerlink" title="EP04: Speculative Decoding"></a>EP04: Speculative Decoding</h2><p>ç›´æ’­å›çœ‹é“¾æ¥ï¼š<a href="https://www.youtube.com/watch?v=WF5xaQqtKUE">https://www.youtube.com/watch?v=WF5xaQqtKUE</a></p><p>ç‰¹åˆ«é¸£è°¢ï¼šæœˆçƒå¤§å”ï¼ŒDu Kuntai, Cheng Yihua å¤§ä½¬å¸¦æ¥çš„ç²¾å½©è®²è§£</p><h3 id="ğŸ“Œ-1-ä¸ºä»€ä¹ˆéœ€è¦-Speculative-decodingï¼ˆæ¨æµ‹è§£ç ï¼‰"><a href="#ğŸ“Œ-1-ä¸ºä»€ä¹ˆéœ€è¦-Speculative-decodingï¼ˆæ¨æµ‹è§£ç ï¼‰" class="headerlink" title="ğŸ“Œ 1. ä¸ºä»€ä¹ˆéœ€è¦ Speculative decodingï¼ˆæ¨æµ‹è§£ç ï¼‰"></a>ğŸ“Œ 1. ä¸ºä»€ä¹ˆéœ€è¦ Speculative decodingï¼ˆæ¨æµ‹è§£ç ï¼‰</h3><ul><li><p>LLMçš„decodeè¿‡ç¨‹æ˜¯GPU-Memory-Bound (GPUå†…å­˜å—é™) çš„</p><ul><li>å¯»æ‰¾ä¸€ç§æ–¹æ³•èƒ½å¤Ÿå¢åŠ è®¡ç®—æ¬¡æ•°ï¼Œä½†ä¸æ˜¾è‘—å¢åŠ å¯¹GPUå†…å­˜çš„è®¿é—®æ¬¡æ•°</li></ul></li><li><p>è§£å†³æ–¹æ³•ï¼šåœ¨decodeç”Ÿæˆtokençš„æ—¶å€™ â€“&gt; ç”¨å°æ¨¡å‹çŒœå¤šå‡ ä¸ªtokenå¹¶éªŒè¯</p><ul><li>åœ¨ token ç”Ÿæˆçš„æ¯1æ¬¡è¿­ä»£ä¸­<ul><li>çŒœ3ä¸ªtokenï¼Œæ¥å—ç‡ä¸º2&#x2F;3</li><li>2ä¸ªtokenæ˜¯çŒœæµ‹æ­£ç¡®çš„ï¼ŒLLMæ¨ç†æ¯æ¬¡è¿˜ä¼šç”Ÿæˆ1ä¸ªæ–°çš„token â€“&gt; 3 tokens</li></ul></li><li>ä¸€æ¬¡çš„è¿­ä»£æ‰€éœ€è¦çš„æ—¶é—´<ul><li>è®¡ç®—é‡ï¼š(1 + 3)x</li><li>å†…å­˜é‡<ul><li>æ²¡æœ‰ Speculative decoding æ—¶ï¼šæ¨¡å‹å‚æ•°ï¼ˆ8x2 GBï¼‰+ KVCacheï¼ˆn * 100 KBï¼‰</li><li>æœ‰ Speculative decoding æ—¶ï¼šæ¨¡å‹å‚æ•°ï¼ˆ8x2 GBï¼‰+ KVCacheï¼ˆï¼ˆn+3ï¼‰ * 100 KBï¼‰</li></ul></li><li>ä¸€æ¬¡è¿­ä»£çš„æ—¶é—´ä¸å˜ï¼Œååé‡å¢åŠ 3å€</li></ul></li></ul></li><li><p>è¡¡é‡ä¸€ä¸ªæ“ä½œæ˜¯ computation-boundï¼ˆè®¡ç®—å—é™å‹ï¼‰è¿˜æ˜¯ memory-boundï¼ˆå†…å­˜å—é™å‹ï¼‰çš„æŒ‡æ ‡æ˜¯ arithmetic intensityï¼ˆè®¡ç®—å¼ºåº¦ï¼‰ï¼š</p><ul><li>å®šä¹‰ï¼šFLOPSï¼ˆæ¯ç§’æµ®ç‚¹è¿ç®—æ¬¡æ•°ï¼‰&#x2F; MIPsï¼ˆå†…å­˜æŒ‡ä»¤æ¬¡æ•°ï¼‰</li></ul></li><li><p>Speculative decodingè™½ç„¶æ˜¯ä¸ªå¾ˆå¥½çš„ä¼˜åŒ–ç‚¹ï¼Œä½†åœ¨å®é™…è½åœ°çš„è¿‡ç¨‹ä¸­è¿˜é¢ä¸´å¾ˆå¤šå·¥ç¨‹ä¸Šçš„å›°éš¾</p></li></ul><h3 id="âš¡-2-æ€ä¹ˆçŒœæµ‹-token"><a href="#âš¡-2-æ€ä¹ˆçŒœæµ‹-token" class="headerlink" title="âš¡ 2. æ€ä¹ˆçŒœæµ‹ token?"></a>âš¡ 2. æ€ä¹ˆçŒœæµ‹ token?</h3><ul><li><p>N-gram</p><ul><li><p>æ„é€ ä¸€ä¸ªmappingï¼šå¦‚æœå‰3ä¸ªtokensæ˜¯A, B, Cï¼Œæ¥ä¸‹æ¥ä¸¤ä¸ªtokensæ˜¯D, E</p></li><li><p>ç¤ºä¾‹ï¼š</p><ul><li>å¦‚æœå‰3ä¸ªtokensæ˜¯ <code>To be or</code>ï¼Œæ¥ä¸‹æ¥ä¸¤ä¸ªtokensæ˜¯ <code>not to</code></li><li>å¦‚æœå‰3ä¸ªtokensæ˜¯ <code>be or not</code>ï¼Œæ¥ä¸‹æ¥ä¸¤ä¸ªtokensæ˜¯ <code>to be</code></li><li>â€¦</li><li>å¦‚æœå‰3ä¸ªtokensæ˜¯ <code>, this is</code>ï¼Œæ¥ä¸‹æ¥ä¸¤ä¸ªtokensæ˜¯ <code>a question</code></li></ul></li><li><p>ä»è¯·æ±‚è¾“å…¥ä¸­æ„å»ºN-gramï¼Œä½¿ç”¨è¿™ä¸ªN-gramæ¥çŒœæµ‹tokensï¼š</p><ul><li><p>æ¥ä¸‹æ¥æ˜¯èå£«æ¯”äºšçš„ä¸€äº›åè¨€ï¼š</p><p>  â€¦<br>  <code>To be or not to be, this is a question</code><br>  â€¦</p></li></ul><p>  é‡Œé¢æœ€ç»å…¸çš„ä¸€å¥åè¨€æ˜¯ä»€ä¹ˆ?</p><ul><li>å‡è®¾LLMå·²ç»ç”Ÿæˆï¼š<ul><li><code>Sure! We recommend you this quote: &quot;To be or</code></li><li>çŒœæµ‹ï¼šæ¥ä¸‹æ¥çš„ä¸¤ä¸ªtokensæ˜¯ <code>not to</code></li><li>éªŒè¯ï¼šæ­£ç¡®</li><li>è¾“å‡ºï¼š<code>Sure! We recommend you this quote: &quot;To be or not to be&quot;</code></li></ul></li></ul></li></ul></li><li><p>Model-basedï¼ˆdraft modelï¼‰</p><ul><li>Parallel guessingï¼ˆå¹¶è¡ŒçŒœæµ‹ï¼‰<ul><li>ä¼˜ç‚¹ï¼šå¿«</li><li>ç¼ºç‚¹ï¼šåœ¨çŒœæµ‹ç¬¬äºŒä¸ªtokençš„æ—¶å€™ä¸çŸ¥é“ç¬¬ä¸€ä¸ªtokenæ˜¯ä»€ä¹ˆ</li></ul></li><li>Autoregression guessingï¼ˆè‡ªå›å½’çŒœæµ‹ï¼‰<ul><li>ä¼˜ç‚¹ï¼šåœ¨çŒœæµ‹ç¬¬äºŒä¸ªtokençš„æ—¶å€™çŸ¥é“ç¬¬ä¸€ä¸ªtoken</li><li>ç¼ºç‚¹ï¼šæ…¢</li></ul></li></ul></li><li><p>Deploymentï¼ˆå°¤å…¶æ˜¯model-basedï¼‰å­˜åœ¨çš„é—®é¢˜</p><ul><li>å°æ¨¡å‹éœ€è¦KVCacheï¼Œåº”è¯¥æ€ä¹ˆæ”¾ç½®ï¼Ÿ</li><li>å°æ¨¡å‹å°ï¼Œéœ€è¦ä¸åŒçš„å¹¶è¡Œç­–ç•¥<ul><li>å‡è®¾å°æ¨¡å‹ä¸å¹¶è¡Œï¼Œå°æ¨¡å‹åœ¨0å·GPU + vLLMå¼ºåˆ¶ä¸åŒçš„GPUæœ‰ä¸€è‡´çš„GPUå†…å­˜åˆ©ç”¨ç‡ï¼ˆåŒä¸€ä¸ªå¹¶è¡Œç»„å†…ï¼‰â€“&gt; ä¼šé€ æˆå…¶ä»–GPUå†…å­˜çš„æµªè´¹</li></ul></li><li>è¦ä¸ºguessed tokensæå‰allocate KVCache<ul><li>å¦‚æœallocate KVCacheè¦è·¨è¶ŠvLLMçš„blockè¾¹ç•Œæ€ä¹ˆåŠ</li><li>éœ€è¦discardçš„token</li></ul></li><li>ä» Sampling â€“&gt; verification é˜¶æ®µçš„è½¬å˜</li><li>æœ€å°åŒ– overhead (Ngram)</li><li>æ€ä¹ˆç¡®å®šæ¯ä¸€æ¬¡åº”è¯¥guesså¤šå°‘ä¸ªtokens</li><li>æ€ä¹ˆåœ¨ä¸åŒrequestsä¹‹é—´åŒºåˆ†<ul><li>ä¸åŒçš„requestï¼šä¸åŒçš„tokenæ•°é‡ï¼Œå®ƒä»¬å…¶ä¸­çš„ä¸€éƒ¨åˆ†ä¸è¿›è¡Œspec decode</li></ul></li></ul></li></ul><h3 id="ğŸ“-3-æ€ä¹ˆéªŒè¯-token-çš„æ­£ç¡®æ€§"><a href="#ğŸ“-3-æ€ä¹ˆéªŒè¯-token-çš„æ­£ç¡®æ€§" class="headerlink" title="ğŸ“ 3. æ€ä¹ˆéªŒè¯ token çš„æ­£ç¡®æ€§?"></a>ğŸ“ 3. æ€ä¹ˆéªŒè¯ token çš„æ­£ç¡®æ€§?</h3><ul><li><p>Tree verificationï¼ˆæ ‘éªŒè¯ï¼‰</p><ul><li><code>To be or</code> â€“&gt; <code>not to</code>, <code>sleep in</code>, <code>go to</code></li><li><code>To be or</code> æœ‰å¾ˆå¤šç§çŒœæ³•: <code>not to</code>, <code>sleep in</code>, <code>go to</code></li></ul></li><li><p>LLMæ€ä¹ˆéªŒè¯é¢„æµ‹çš„æ˜¯æ­£ç¡®çš„?</p><ul><li>Deterministic samplingï¼ˆç¡®å®šæ€§é‡‡æ ·ï¼‰(spec decode bad case)</li><li>Random samplingï¼ˆéšæœºæ€§é‡‡æ ·ï¼‰ï¼Œå½“ guess probability &gt; threshold å°±æ­£ç¡®</li></ul></li><li><p>ç¤ºä¾‹ï¼š</p><ul><li><p>è¾“å…¥ï¼š<code>To be or</code> (already-decoded output) <code>not to</code> (guessed token)</p><ul><li><code>To be or not to</code></li><li><code>To -&gt; be</code></li><li><code>be -&gt; or</code></li><li><code>or -&gt; not</code> æˆ‘ä»¬çš„çŒœæµ‹ â€œnotâ€ æ˜¯æ­£ç¡®çš„</li><li><code>not -&gt; to</code> æˆ‘ä»¬çš„çŒœæµ‹ â€œtoâ€ æ˜¯æ­£ç¡®çš„</li><li><code>to -&gt; be</code> â€œbeâ€ æ˜¯æ­£ç¡®çš„ä¸‹ä¸€ä¸ªtoken</li></ul></li><li><p>è¾“å…¥ï¼š<code>To be or</code> (already-decoded output) <code>not be</code> (guessed token)</p><ul><li><code>To be or not be</code></li><li><code>To -&gt; be</code></li><li><code>be -&gt; or</code></li><li><code>or -&gt; not</code> æˆ‘ä»¬çš„çŒœæµ‹ â€œnotâ€ æ˜¯æ­£ç¡®çš„</li><li><code>not -&gt; be</code> æˆ‘ä»¬çš„çŒœæµ‹ â€œbeâ€ æ˜¯é”™è¯¯çš„ï¼Œåº”è¯¥æ˜¯ â€œtoâ€<br>  å‘ç°æœ‰é”™è¯¯çš„tokenåï¼Œåé¢çš„é¢„æµ‹ä¼šèˆå¼ƒ</li></ul></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLM </tag>
            
            <tag> Inference </tag>
            
            <tag> vLLM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EP03-vLLMæºç è®²è§£ç›´æ’­ç¬”è®°-PDåˆ†ç¦»</title>
      <link href="/2025/03/30/vLLM-EP03/"/>
      <url>/2025/03/30/vLLM-EP03/</url>
      
        <content type="html"><![CDATA[<h1 id="FIXME-EP03-vLLM-æºç è®²è§£ç›´æ’­ç¬”è®°"><a href="#FIXME-EP03-vLLM-æºç è®²è§£ç›´æ’­ç¬”è®°" class="headerlink" title="[FIXME][EP03] vLLM æºç è®²è§£ç›´æ’­ç¬”è®°"></a>[FIXME][EP03] vLLM æºç è®²è§£ç›´æ’­ç¬”è®°</h1><h2 id="EP03-PDåˆ†ç¦»"><a href="#EP03-PDåˆ†ç¦»" class="headerlink" title="EP03: PDåˆ†ç¦»"></a>EP03: PDåˆ†ç¦»</h2><p>ç›´æ’­å›çœ‹é“¾æ¥ï¼š<a href="https://www.youtube.com/watch?v=ih6fcJnhoJI">https://www.youtube.com/watch?v=ih6fcJnhoJI</a></p><p>ç‰¹åˆ«é¸£è°¢ï¼šæœˆçƒå¤§å”ï¼ŒCheng Yihua å¤§ä½¬å¸¦æ¥çš„ç²¾å½©è®²è§£</p><h3 id="ğŸ“Œ-1-ä¸Šå‘¨å›é¡¾ï¼ˆåˆ†å¸ƒå¼é€šä¿¡ä¸å¹¶è¡Œç­–ç•¥ï¼‰"><a href="#ğŸ“Œ-1-ä¸Šå‘¨å›é¡¾ï¼ˆåˆ†å¸ƒå¼é€šä¿¡ä¸å¹¶è¡Œç­–ç•¥ï¼‰" class="headerlink" title="ğŸ“Œ 1. ä¸Šå‘¨å›é¡¾ï¼ˆåˆ†å¸ƒå¼é€šä¿¡ä¸å¹¶è¡Œç­–ç•¥ï¼‰"></a>ğŸ“Œ 1. ä¸Šå‘¨å›é¡¾ï¼ˆåˆ†å¸ƒå¼é€šä¿¡ä¸å¹¶è¡Œç­–ç•¥ï¼‰</h3><ul><li>TPï¼Œall_gather<ul><li>Linear M x N x K -&gt; M x K</li><li>M * Nâ€™, Nâ€™ * K -&gt; M * K<br>  åœ¨MHAä¸­ï¼Œæ¯ä¸ªå¤´è¢«å‡åŒ€åœ°åˆ†åœ¨ä¸åŒçš„workerä¸Šï¼Œåœ¨è¿›å…¥ä¹‹åçš„çº¿æ€§å±‚å‰è¦åšä¸€æ¬¡all_gatherï¼ˆè¿™é‡Œä¸ç†è§£çš„å¯ä»¥çœ‹çœ‹-lmå¼ é‡å¹¶è¡Œçš„æ–¹æ³•ï¼‰</li><li>â€œvllm\model_executor\models\llama.pyâ€  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># llamaå‰å‘ä¼ æ’­çš„ä»£ç </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params"></span></span><br><span class="line"><span class="params">    self,</span></span><br><span class="line"><span class="params">    positions: torch.Tensor,</span></span><br><span class="line"><span class="params">    hidden_states: torch.Tensor,</span></span><br><span class="line"><span class="params"></span>) -&gt; torch.Tensor:</span><br><span class="line">    qkv, _ = <span class="variable language_">self</span>.qkv_proj(hidden_states)</span><br><span class="line">    q, k, v = qkv.split([<span class="variable language_">self</span>.q_size, <span class="variable language_">self</span>.kv_size, <span class="variable language_">self</span>.kv_size], dim=-<span class="number">1</span>)</span><br><span class="line">    q, k = <span class="variable language_">self</span>.rotary_emb(positions, q, k)</span><br><span class="line">    attn_output = <span class="variable language_">self</span>.attn(q, k, v)</span><br><span class="line">    output, _ = <span class="variable language_">self</span>.o_proj(attn_output)</span><br><span class="line">    <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="âš¡-2-PDåˆ†ç¦»"><a href="#âš¡-2-PDåˆ†ç¦»" class="headerlink" title="âš¡ 2. PDåˆ†ç¦»"></a>âš¡ 2. PDåˆ†ç¦»</h3><ul><li>ä»€ä¹ˆæ˜¯PDåˆ†ç¦»ï¼ˆPrefillå’ŒDecodeï¼‰<ul><li>prefill: å¤„ç†è¾“å…¥çš„promptï¼Œç”ŸæˆKVCache</li><li>decode: æ ¹æ®KVCacheè¿ç»­è‡ªå›å½’ç”Ÿæˆä¸€ä¸ªä¸€ä¸ªçš„token</li></ul></li><li>ä¸ºä»€ä¹ˆè¦PDåˆ†ç¦»<ul><li>prefill: attention N tokens QKVï¼Œä¸åºåˆ—é•¿åº¦nçš„å¹³æ–¹æˆæ­£æ¯”ï¼Œéœ€è¦ç›¸å½“å¤šæ—¶é—´</li><li>decode: attention N KV, 1Qï¼Œç”Ÿæˆæ–°çš„tokenï¼Œé€Ÿåº¦è¾ƒå¿«</li><li>æœ€åˆçš„é€»è¾‘ï¼šprefillä¼˜å…ˆ</li><li>é—®é¢˜ï¼šå½“æ–°çš„ä¸€ä¸ªrequeståˆ°æ¥æ—¶ï¼Œè¿›è¡Œçš„prefillä¼šä½¿å…¶ä»–æ­£åœ¨decodeçš„requeståœä½</li><li>è§£å†³æ–¹æ³•ï¼š<ul><li>PDåˆ†ç¦»ï¼ˆPD disaggregationï¼‰<ul><li>æŒ‘æˆ˜æ˜¯Pï¼ŒDçš„æ•°é‡</li></ul></li><li>åˆ†å—é¢„å¡«å……ï¼ˆchunked prefillï¼‰ï¼Œå·²åœ¨vllm v1ç‰ˆæœ¬ä¸­é»˜è®¤ä½¿ç”¨<ul><li>æŒ‘æˆ˜æ˜¯chunked_sizeçš„è®¾ç½®ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªprefillå’Œdecodeä¸­çš„trade-off</li></ul></li></ul></li></ul></li><li>PDåˆ†ç¦»çš„å…³é”®é—®é¢˜<ul><li>æ€ä¹ˆä¼ è¾“KVCache<ul><li>ä¸¤ç§æ¨¡å¼ï¼špoolingæ¨¡å¼ï¼ŒP2Pæ¨¡å¼</li><li>LMCacheéƒ½æ”¯æŒä¸Šé¢ä¸¤ç§æ¨¡å¼ï¼ŒMooncake(pooling)ï¼ŒNIXL(p2p)</li></ul></li><li>æ€ä¹ˆä»vllmæå–ï¼ˆæ³¨å…¥ï¼‰KVCache<ul><li>connector API<ul><li>åœ¨model_runnerä¸­è¢«è°ƒç”¨ï¼Œâ€vllm\worker\model_runner.pyâ€</li><li>åœ¨æ¨¡å‹forwardå‰ï¼šå°è¯•æ¥æ”¶KVCacheå¹¶æ³¨å…¥åˆ°åˆ°vllmçš„pages memoryä¸­</li><li>æ¨¡å‹æ‰§è¡Œ</li><li>åœ¨æ¨¡å‹forwardåï¼Œå°†KVCacheä»pages memoryä¸­å¹¶å°†å®ƒå‘é€å‡ºå»<br><img src="/posts_img/vLLM-EP03/1743330247803.png"><ul><li>ä¸¤ä¸ªå‡½æ•°çš„è¯¦ç»†è®¾è®¡åœ¨â€vllm\distributed\kv_transfer\kv_transfer_agent.pyâ€ä¸­  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æœ¬è´¨ä¸Šæ˜¯æ ¹æ®model inputè®¡ç®—å‡ºKVCacheæ”¾åœ¨page memoryä¸­çš„ä»€ä¹ˆåœ°æ–¹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recv_kv_caches_and_hidden_states</span>(<span class="params"></span></span><br><span class="line"><span class="params">    self, model_executable: torch.nn.Module,</span></span><br><span class="line"><span class="params">    model_input: <span class="string">&quot;ModelInputForGPUWithSamplingMetadata&quot;</span>,</span></span><br><span class="line"><span class="params">    kv_caches: <span class="type">List</span>[torch.Tensor]</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Tuple</span>[<span class="type">Union</span>[torch.Tensor, IntermediateTensors], <span class="built_in">bool</span>,</span><br><span class="line">        <span class="string">&quot;ModelInputForGPUWithSamplingMetadata&quot;</span>]:</span><br><span class="line">              </span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">self</span>.connector.recv_kv_caches_and_hidden_states(</span><br><span class="line">        model_executable, model_input, kv_caches)</span><br></pre></td></tr></table></figure>  è¿™é‡Œä¸æ‡‚çš„å¯ä»¥å»çœ‹â€vllm\distributed\kv_transfer\kv_connector\simple_connector.pyâ€</li></ul></li></ul></li></ul></li><li>ä»€ä¹ˆæ—¶å€™å°†requestä»P nodeä¼ è¾“åˆ°D node<ul><li>å…ˆPåDï¼ˆproduction stackï¼‰</li><li>å…ˆDåPï¼ˆD nodeæ”¶åˆ°åå…ˆæ£€æŸ¥æ˜¯å¦æœ‰KVCacheï¼Œæ²¡æœ‰çš„è¯å†è½¬ç»™P nodeå»åšï¼Œè¿™ä¸ªæ€è·¯ä¸»è¦è€ƒè™‘çš„æ˜¯TTFTï¼‰</li></ul></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLM </tag>
            
            <tag> Inference </tag>
            
            <tag> vLLM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CacheBlend-é«˜æ•ˆæé«˜KVCacheå¤ç”¨æ€§çš„æ–¹æ³•</title>
      <link href="/2025/03/29/CacheBlend/"/>
      <url>/2025/03/29/CacheBlend/</url>
      
        <content type="html"><![CDATA[<p>CacheBlendï¼Œä¸€ç§ç”¨äºåŠ é€Ÿ LLM æœåŠ¡çš„é«˜æ•ˆKVç¼“å­˜èåˆæ–¹æ¡ˆï¼Œç‰¹åˆ«é’ˆå¯¹æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰ç­‰éœ€è¦å¤šæ–‡æœ¬å—ä¸Šä¸‹æ–‡çš„åœºæ™¯ï¼Œèƒ½æœ‰æ•ˆæé«˜ KVCache çš„å¤ç”¨æ€§ã€‚</p><p>è®ºæ–‡ï¼š(EuroSys 2025)<a href="https://arxiv.org/abs/2405.16444">Fast Large Language Model Serving for RAG with Cached Knowledge Fusion</a></p><p>ä»£ç ï¼š<a href="https://github.com/YaoJiayi/CacheBlend">https://github.com/YaoJiayi/CacheBlend</a></p><h1 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h1><p>ä¸ºäº†ç¡®ä¿æ¨¡å‹é«˜è´¨é‡çš„ä¸€è‡´æ€§çš„å“åº”ï¼ŒRAGæŠ€æœ¯å¸¸è¢«åº”ç”¨äºLLMæœåŠ¡ä¸­ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¤šä¸ªä»æ•°æ®åº“æ£€ç´¢æ¥çš„æ–‡æœ¬ç‰‡æ®µä¼šå‰ç½®äºç”¨æˆ·çš„æŸ¥è¯¢ï¼Œå½¢æˆLLMè¾“å…¥ï¼Œè¿™äº›é•¿ä¸Šä¸‹æ–‡ç‰‡æ®µæ˜¾è‘—åœ°æé«˜äº†LLMçš„TTFTæ—¶é—´ã€‚</p><p>ä¸ºäº†æé«˜prefillçš„æ—¶é—´ï¼Œç°æœ‰çš„ä¼˜åŒ–é€šå¸¸é‡å¤ä½¿ç”¨å­˜å‚¨çš„ KVCacheï¼Œä»¥é¿å…é‡å¤çš„è®¡ç®—ã€‚ç›®å‰æœ‰ä»¥ä¸‹ä¸¤ç±» KVCacheé‡ç”¨çš„æ–¹æ³•ï¼Œä½†å®ƒä»¬éƒ½å­˜åœ¨å±€é™æ€§ã€‚</p><h2 id="å‰ç¼€ç¼“å­˜"><a href="#å‰ç¼€ç¼“å­˜" class="headerlink" title="å‰ç¼€ç¼“å­˜"></a>å‰ç¼€ç¼“å­˜</h2><p>ä»…èƒ½é‡ç”¨è¾“å…¥å‰ç¼€çš„KVç¼“å­˜ï¼Œæ— æ³•å¤„ç†å¤šæ–‡æœ¬å—åœºæ™¯ã€‚</p><h2 id="å…¨é‡KVé‡ç”¨"><a href="#å…¨é‡KVé‡ç”¨" class="headerlink" title="å…¨é‡KVé‡ç”¨"></a>å…¨é‡KVé‡ç”¨</h2><p>å½“é‡ç”¨çš„æ–‡æœ¬ä¸åœ¨è¾“å…¥å‰ç¼€ä¸­æ—¶ï¼Œä»ç„¶é€šè¿‡è°ƒæ•´å…¶ä½ç½®åµŒå…¥æ¥é‡ç”¨ KV ç¼“å­˜ï¼ˆè¿™é‡Œç”¨åˆ°äº† Rotary Position Embedding(RoPE) ç¼–ç ç›¸å¯¹ä½ç½®çš„ç‰¹æ€§ï¼‰ï¼Œä»è€Œä½¿ LLM ç”Ÿæˆæœ‰æ„ä¹‰çš„è¾“å‡ºï¼ˆPrompt cache 2023ï¼‰ã€‚ä½†è¿™æ ·ä¼šå¿½ç•¥ä¸ä¹‹å‰æ–‡æœ¬å—ä¹‹é—´çš„<strong>è·¨æ³¨æ„åŠ›</strong>ï¼ˆcross-attentionï¼‰ï¼Œå¯¼è‡´ç”Ÿæˆè´¨é‡æ˜¾è‘—ä¸‹é™ã€‚ï¼ˆå¦‚æœè¿™é‡Œä¸ç†è§£ä»€ä¹ˆæ˜¯cross-attentionçš„è¯ï¼Œå¯ä»¥é‡æ–°å›é¡¾ä¸€ä¸‹æ•´ä¸ªprefillé˜¶æ®µçš„è®¡ç®—æµï¼Œtensoråœ¨ä¸åŒçš„layerå‰å‘ä¼ é€’è¿‡ç¨‹ä¸­ï¼Œä¸Šä¸‹æ–‡çš„å†…å®¹ä¼šä¸æ–­èåˆï¼‰</p><p><img src="/posts_img/CacheBlend/2.png"></p><p>è¿™ä¸ªå›¾è¡¨æ˜äº†ï¼š</p><ol><li>éšç€é€‰æ‹©çš„æ–‡æœ¬ç‰‡æ®µæ•°é‡å¢åŠ ï¼Œç”Ÿæˆè´¨é‡æ˜¾è‘—æé«˜ï¼Œå°½ç®¡åŒ…æ‹¬åœ¨å¤ªå¤šç‰‡æ®µæ—¶ä¼šç”±äºlost-in-the-middleé—®é¢˜è€Œé™ä½è´¨é‡ã€‚</li><li>éšç€é€‰æ‹©çš„æ–‡æœ¬ç‰‡æ®µæ•°é‡å¢åŠ ï¼Œç”±äºäº¤å‰æ³¨æ„åŠ›ç¼ºå¤±é€ æˆçš„æ€§èƒ½æŸè€—å¢å¤§ã€‚</li></ol><table><thead><tr><th align="center"><img src="/posts_img/CacheBlend/3.png" alt="Image 1"></th><th align="center"><img src="/posts_img/CacheBlend/4.png" alt="Image 2"></th></tr></thead></table><p>å·¦å›¾è¡¨ç¤ºäº†ï¼Œç”±äºå¿½ç•¥äº¤å‰æ³¨æ„åŠ›å¯èƒ½å¯¼è‡´é”™è¯¯çš„å›ç­”ã€‚ä¸ºäº†ç†è§£è¿™ä¸€ç‚¹ï¼Œå¯ä»¥ä»”ç»†çœ‹ä¸€ä¸‹ä¸¤ä¸ªæ–‡æœ¬ç‰‡æ®µä¹‹é—´çš„äº¤å‰æ³¨æ„åŠ›ã€‚å¯ä»¥çœ‹åˆ°ï¼Œç›¸æ¯”äºå®Œæ•´prefillåçš„ç»“æœï¼Œå…¨é‡KVCacheå¤ç”¨æ—¶ä¸¤ä¸ªç‰‡æ®µä¹‹é—´çš„äº¤å‰æ³¨æ„åŠ›è¢«å¿½ç•¥äº†ã€‚</p><p>è¿™é‡Œè¦è¯´æ˜ä¸€ä¸ªç‚¹ï¼Œå½“å„ç‰‡æ®µä¹‹é—´çš„äº¤å‰æ³¨æ„åŠ›è¾ƒä½æ—¶ï¼Œç‰‡æ®µå†…è‡ªæ³¨æ„åŠ›å½±å“è¾ƒé«˜æ—¶ï¼Œå®Œå…¨é‡ç”¨ KV æ˜¯å¯ä»¥å¥æ•ˆçš„ã€‚è¿™ç§æƒ…å†µåœ¨ PromptCache çš„ä¸»è¦ç›®æ ‡åº”ç”¨ï¼ˆgim2023promptï¼‰çš„æç¤ºæ¨¡æ¿ä¸­è¾ƒä¸ºå¸¸è§ã€‚</p><h2 id="æŒ‘æˆ˜"><a href="#æŒ‘æˆ˜" class="headerlink" title="æŒ‘æˆ˜"></a>æŒ‘æˆ˜</h2><p>å¦‚ä½•åœ¨é‡ç”¨éå‰ç¼€æ–‡æœ¬å—çš„KVç¼“å­˜æ—¶ï¼Œä¿æŒç”Ÿæˆè´¨é‡ä¸å®Œå…¨é¢„å¡«å……ï¼ˆfull prefillï¼‰ä¸€è‡´ï¼ŒåŒæ—¶å‡å°‘è®¡ç®—å»¶è¿Ÿï¼Ÿ</p><p><img src="/posts_img/CacheBlend/1.png"></p><p>ä½œè€…åœ¨è¿™é‡Œåšäº†ä¸€ä¸ªtrade-offï¼Œçš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨ Full KV Reuse çš„åŸºç¡€ä¸Šå†è®¡ç®—å°‘é‡ token çš„æ³¨æ„åŠ›ä»¥æ¢å¤æ–‡æœ¬å—ä¹‹é—´çš„äº¤å‰æ³¨æ„åŠ›ã€‚</p><h1 id="æ ¸å¿ƒæ–¹æ³•ï¼šé€‰æ‹©æ€§KVé‡è®¡ç®—"><a href="#æ ¸å¿ƒæ–¹æ³•ï¼šé€‰æ‹©æ€§KVé‡è®¡ç®—" class="headerlink" title="æ ¸å¿ƒæ–¹æ³•ï¼šé€‰æ‹©æ€§KVé‡è®¡ç®—"></a>æ ¸å¿ƒæ–¹æ³•ï¼šé€‰æ‹©æ€§KVé‡è®¡ç®—</h1><h2 id="é€‰æ‹©æ€§KVé‡è®¡ç®—ï¼ˆSelective-KV-Recomputationï¼‰"><a href="#é€‰æ‹©æ€§KVé‡è®¡ç®—ï¼ˆSelective-KV-Recomputationï¼‰" class="headerlink" title="é€‰æ‹©æ€§KVé‡è®¡ç®—ï¼ˆSelective KV Recomputationï¼‰"></a>é€‰æ‹©æ€§KVé‡è®¡ç®—ï¼ˆSelective KV Recomputationï¼‰</h2><ul><li><strong>ç›®æ ‡</strong>ï¼šä»…æ›´æ–°å¯¹ç”Ÿæˆè´¨é‡å½±å“æœ€å¤§çš„éƒ¨åˆ†tokençš„KVç¼“å­˜ï¼Œé¿å…å…¨é‡é¢„å¡«å……çš„è®¡ç®—å¼€é”€ã€‚</li><li><strong>å®ç°æ­¥éª¤</strong>ï¼šåœ¨æ¯ä¸€å±‚ï¼ˆLayerï¼‰çš„è¾“å…¥ä¸­ï¼Œé€šè¿‡æ©ç ä»…ä¿ç•™éœ€è¦é‡è®¡ç®—çš„tokenï¼ˆHKVD tokensï¼‰ï¼Œè®¡ç®—æ‰€éœ€çš„QKVï¼Œå…¶ä½™tokençš„KVå€¼ç›´æ¥å¤ç”¨é¢„è®¡ç®—çš„ç¼“å­˜ã€‚</li></ul><p><img src="/posts_img/CacheBlend/5.png"></p><h2 id="é‡è®¡ç®—Tokensçš„ç­›é€‰"><a href="#é‡è®¡ç®—Tokensçš„ç­›é€‰" class="headerlink" title="é‡è®¡ç®—Tokensçš„ç­›é€‰"></a>é‡è®¡ç®—Tokensçš„ç­›é€‰</h2><p>çŸ¥é“äº†è¦é‡è®¡ç®—å…³é”®tokenï¼Œé‚£ä¹ˆå¦‚ä½•é€‰æ‹©è¿™äº›tokenå‘¢ï¼Ÿ</p><ul><li><strong>å®šä¹‰</strong>ï¼š<strong>é«˜KVåå·®ï¼ˆHigh KV Deviation, HKVDï¼‰Token</strong><br>æŒ‡å…¶é¢„è®¡ç®—KVå€¼ä¸å®Œå…¨é¢„å¡«å……ï¼ˆFull KV Recomputeï¼‰ç»“æœçš„å·®å¼‚è¶…è¿‡é˜ˆå€¼çš„tokenã€‚  <ul><li><strong>é‡åŒ–æŒ‡æ ‡</strong>ï¼š<br>$$\Delta_{\text{kv}}(KV_i[j], KV_i^{\text{full}}[j]) &#x3D; |KV_i[j] - KV_i^{\text{full}}[j]|$$<br>å…¶ä¸­ï¼Œ$KV_i[j]$ è¡¨ç¤ºç¬¬iå±‚ç¬¬jä¸ªtokençš„KVå€¼ã€‚</li></ul></li></ul><h2 id="ç­›é€‰ä¾æ®"><a href="#ç­›é€‰ä¾æ®" class="headerlink" title="ç­›é€‰ä¾æ®"></a>ç­›é€‰ä¾æ®</h2><h3 id="æ³¨æ„åŠ›ç¨€ç–æ€§"><a href="#æ³¨æ„åŠ›ç¨€ç–æ€§" class="headerlink" title="æ³¨æ„åŠ›ç¨€ç–æ€§"></a>æ³¨æ„åŠ›ç¨€ç–æ€§</h3><p>ä»…çº¦10-15%çš„tokençš„KVåå·®è¿œé«˜äºå…¶ä»–ä»¤ç‰Œï¼Œå¯¹è·¨æ–‡æœ¬å—æ³¨æ„åŠ›è´¡çŒ®æ˜¾è‘—ã€‚<br><img src="/posts_img/CacheBlend/6.png"></p><h3 id="å±‚é—´ç›¸å…³æ€§"><a href="#å±‚é—´ç›¸å…³æ€§" class="headerlink" title="å±‚é—´ç›¸å…³æ€§"></a>å±‚é—´ç›¸å…³æ€§</h3><p>å¦‚ä½•åœ¨ä¸çŸ¥é“çœŸå® KV å€¼æˆ–æ³¨æ„åŠ›çŸ©é˜µçš„æƒ…å†µä¸‹è¯†åˆ« HKVD ä»¤ç‰Œï¼Ÿç®€å•æ¥è¯´ï¼Œè¦è¯†åˆ« HKVD ä»¤ç‰Œï¼Œé¦–å…ˆå¿…é¡»çŸ¥é“æ¯ä¸€å±‚çš„å®Œå…¨é‡æ–°è®¡ç®—çš„ KVï¼Œä½†è¿™å¤ªè¿‡æ˜‚è´µä¸”è¿èƒŒäº†é€‰æ‹©æ€§ KV é‡æ–°è®¡ç®—çš„ç›®çš„ã€‚ç›¸åï¼Œä½œè€…è§‚å¯Ÿåˆ°ä¸åŒå±‚çš„ HKVD ä»¤ç‰Œå¹¶ä¸æ˜¯ç‹¬ç«‹çš„ï¼</p><p>é€šè¿‡Spearmanç§©ç›¸å…³æ€§åˆ†æï¼Œå‘ç°ç›¸é‚»å±‚çš„HKVD tokensé«˜åº¦é‡å ï¼Œå…è®¸è·¨å±‚æ¸è¿›ç­›é€‰ï¼Œè¿™æ˜¯å› ä¸ºå„å±‚ä¹‹é—´çš„ KV ç¼“å­˜å…·æœ‰ç›¸ä¼¼æ€§ã€‚</p><p><img src="/posts_img/CacheBlend/7.png"></p><h3 id="æ¸è¿›å¼ç­›é€‰æµç¨‹ï¼ˆGradual-Filteringï¼‰"><a href="#æ¸è¿›å¼ç­›é€‰æµç¨‹ï¼ˆGradual-Filteringï¼‰" class="headerlink" title="æ¸è¿›å¼ç­›é€‰æµç¨‹ï¼ˆGradual Filteringï¼‰"></a>æ¸è¿›å¼ç­›é€‰æµç¨‹ï¼ˆGradual Filteringï¼‰</h3><p>å¦‚æœå¹³å‡æ¯å±‚æƒ³è¦æŒ‘é€‰ $r$% ä¸ª HKVD æ ‡è®°ï¼š</p><ol><li><strong>é¦–å±‚ç­›é€‰</strong>ï¼šåœ¨ç¬¬ä¸€å±‚é¢„å¡«å……æ—¶ï¼Œè®¡ç®—æ‰€æœ‰tokençš„KVåå·®ï¼Œé€‰æ‹©åå·®æœ€é«˜çš„å‰$r_1$%ä½œä¸ºå€™é€‰ï¼Œä¾‹å¦‚20%ï¼‰ã€‚  </li><li><strong>é€å±‚è¿‡æ»¤</strong>ï¼š  <ul><li>å¯¹åç»­æ¯ä¸€å±‚ï¼Œä»…è®¡ç®—ä¸Šä¸€å±‚çš„å€™é€‰tokençš„KVåå·®ï¼Œä»ä¸­ç­›é€‰åå·®æ›´é«˜çš„(r_i%)ï¼ˆé€æ­¥é€¼è¿‘ç›®æ ‡æ¯”ä¾‹(r)ï¼‰ã€‚  </li><li>æœ€ç»ˆæ¯å±‚ä»…é‡è®¡ç®—çº¦10-15%çš„tokenï¼Œæ˜¾è‘—å‡å°‘è®¡ç®—é‡ã€‚</li></ul></li></ol><p><img src="/posts_img/CacheBlend/8.png"></p><h1 id="ç³»ç»Ÿä¼˜åŒ–ï¼šå»¶è¿Ÿéšè—ä¸åŠ¨æ€æ§åˆ¶"><a href="#ç³»ç»Ÿä¼˜åŒ–ï¼šå»¶è¿Ÿéšè—ä¸åŠ¨æ€æ§åˆ¶" class="headerlink" title="ç³»ç»Ÿä¼˜åŒ–ï¼šå»¶è¿Ÿéšè—ä¸åŠ¨æ€æ§åˆ¶"></a>ç³»ç»Ÿä¼˜åŒ–ï¼šå»¶è¿Ÿéšè—ä¸åŠ¨æ€æ§åˆ¶</h1><h2 id="ç³»ç»Ÿæ¶æ„"><a href="#ç³»ç»Ÿæ¶æ„" class="headerlink" title="ç³»ç»Ÿæ¶æ„"></a>ç³»ç»Ÿæ¶æ„</h2><p><img src="/posts_img/CacheBlend/10.png"></p><h2 id="æµæ°´çº¿å¹¶è¡Œï¼ˆPipeliningï¼‰"><a href="#æµæ°´çº¿å¹¶è¡Œï¼ˆPipeliningï¼‰" class="headerlink" title="æµæ°´çº¿å¹¶è¡Œï¼ˆPipeliningï¼‰"></a>æµæ°´çº¿å¹¶è¡Œï¼ˆPipeliningï¼‰</h2><ul><li><strong>KVåŠ è½½ä¸é‡è®¡ç®—å¹¶è¡Œ</strong>ï¼š  <ul><li>åœ¨GPUè®¡ç®—å½“å‰å±‚çš„é€‰æ‹©æ€§KVé‡è®¡ç®—æ—¶ï¼Œå¼‚æ­¥åŠ è½½ä¸‹ä¸€å±‚çš„é¢„è®¡ç®—KVç¼“å­˜ï¼ˆä»SSD&#x2F;å†…å­˜åˆ°GPUï¼‰ã€‚  </li><li>è‹¥åŠ è½½æ—¶é—´ â‰¥ é‡è®¡ç®—æ—¶é—´ï¼Œé¢å¤–å»¶è¿Ÿè¢«å®Œå…¨éšè—ã€‚</li></ul></li><li><strong>ä¼˜åŠ¿</strong>ï¼šæ”¯æŒå°†KVç¼“å­˜å­˜å‚¨åœ¨ä½é€Ÿè®¾å¤‡ï¼ˆå¦‚SSDï¼‰ä¸­ï¼ŒèŠ‚çœå†…å­˜æˆæœ¬ï¼ŒåŒæ—¶ä¸å½±å“å®æ—¶æ€§ã€‚</li></ul><p><img src="/posts_img/CacheBlend/11.png"></p><h2 id="åŠ¨æ€æ§åˆ¶å™¨ï¼ˆLoading-Controllerï¼‰"><a href="#åŠ¨æ€æ§åˆ¶å™¨ï¼ˆLoading-Controllerï¼‰" class="headerlink" title="åŠ¨æ€æ§åˆ¶å™¨ï¼ˆLoading Controllerï¼‰"></a>åŠ¨æ€æ§åˆ¶å™¨ï¼ˆLoading Controllerï¼‰</h2><ul><li><strong>åŠ¨æ€è°ƒæ•´é‡è®¡ç®—æ¯”ä¾‹</strong>ï¼š  <ul><li>æ ¹æ®å­˜å‚¨è®¾å¤‡é€Ÿåº¦ï¼ˆå¦‚SSDååé‡ï¼‰å’Œæ¨¡å‹è§„æ¨¡ï¼Œè®¡ç®—æœ€å¤§å¯å®¹å¿çš„é‡è®¡ç®—æ¯”ä¾‹(r%)ï¼Œä½¿å¾—ï¼š<br>$$T_{\text{recompute}}(r%) \leq T_{\text{load}}(storage_device)$$  </li><li>ç¡®ä¿æ€»å»¶è¿Ÿä¸å¢åŠ ï¼ŒåŒæ—¶è´¨é‡æŸå¤±å¯æ§ï¼ˆç»éªŒé»˜è®¤r &#x3D; 15%)ï¼‰ã€‚</li></ul></li><li><strong>å­˜å‚¨è®¾å¤‡é€‰æ‹©</strong>ï¼š<br>åœ¨æˆæœ¬ä¸å»¶è¿Ÿé—´æƒè¡¡ï¼Œä¼˜å…ˆé€‰æ‹©æ»¡è¶³å»¶è¿Ÿçº¦æŸçš„æœ€å»‰ä»·å­˜å‚¨è®¾å¤‡ï¼ˆå¦‚SSDè€ŒéGPUæ˜¾å­˜ï¼‰ã€‚</li></ul><p><img src="/posts_img/CacheBlend/9.png"></p><h1 id="å®éªŒç»“æœ"><a href="#å®éªŒç»“æœ" class="headerlink" title="å®éªŒç»“æœ"></a><strong>å®éªŒç»“æœ</strong></h1><ul><li><strong>æ€§èƒ½æå‡</strong>ï¼š  <ul><li><strong>æœåŠ¡è´¨é‡</strong>ï¼šç›¸æ¯”å®Œå…¨é¢„å¡«å……ï¼Œé¦–tokenæ—¶é—´ï¼ˆTTFTï¼‰å‡å°‘ <strong>2.2-3.3å€</strong>ï¼Œååé‡æå‡ <strong>2.8-5å€</strong>ã€‚  </li><li><strong>ç”Ÿæˆè´¨é‡</strong>ï¼šä¸å®Œå…¨é¢„å¡«å……ç›¸æ¯”ï¼ŒF1&#x2F;Rouge-Låˆ†æ•°ä¸‹é™å°äº <strong>0.02</strong>ï¼Œæ˜¾è‘—ä¼˜äºå®Œå…¨KVé‡ç”¨ï¼ˆè´¨é‡æå‡æœ€é«˜è¾¾0.35ï¼‰ã€‚</li></ul></li><li><strong>é€‚ç”¨æ€§</strong>ï¼šåœ¨å¤šä¸ªæ¨¡å‹ï¼ˆMistral-7Bã€Yi-34Bã€Llama-70Bï¼‰å’Œä»»åŠ¡ï¼ˆQAã€æ‘˜è¦ï¼‰ä¸­éªŒè¯æœ‰æ•ˆæ€§ï¼Œæ”¯æŒä¸åŒæ–‡æœ¬å—é•¿åº¦å’Œæ‰¹é‡å¤§å°ã€‚</li></ul><p><img src="/posts_img/CacheBlend/12.png"></p><h1 id="è´¡çŒ®ä¸æ„ä¹‰"><a href="#è´¡çŒ®ä¸æ„ä¹‰" class="headerlink" title="è´¡çŒ®ä¸æ„ä¹‰"></a><strong>è´¡çŒ®ä¸æ„ä¹‰</strong></h1><ul><li><strong>ç†è®ºä»·å€¼</strong>ï¼šæ­ç¤ºäº†æ³¨æ„åŠ›ç¨€ç–æ€§ä¸KVåå·®çš„å…³ç³»ï¼Œä¸ºé«˜æ•ˆç¼“å­˜å¤ç”¨æä¾›äº†æ–°è§†è§’ã€‚  </li><li><strong>å·¥ç¨‹ä»·å€¼</strong>ï¼šé€šè¿‡æµæ°´çº¿å’ŒåŠ¨æ€æ§åˆ¶ï¼Œå®ç°äº†ä½æˆæœ¬ã€é«˜è´¨é‡çš„KVç¼“å­˜å¤ç”¨ï¼Œå…¼å®¹ç°æœ‰LLMæœåŠ¡æ¡†æ¶ï¼ˆå¦‚vLLMï¼‰ã€‚  </li><li><strong>åº”ç”¨åœºæ™¯</strong>ï¼šé€‚ç”¨äºéœ€è¦å¤šä¸Šä¸‹æ–‡äº¤äº’çš„RAGã€é•¿æ–‡æœ¬ç”Ÿæˆç­‰ä»»åŠ¡ï¼Œæ˜¾è‘—é™ä½æœåŠ¡å»¶è¿Ÿä¸è®¡ç®—å¼€é”€ã€‚</li></ul><h1 id="å±€é™ä¸å±•æœ›"><a href="#å±€é™ä¸å±•æœ›" class="headerlink" title="å±€é™ä¸å±•æœ›"></a><strong>å±€é™ä¸å±•æœ›</strong></h1><ul><li>ç›®å‰ä»…éªŒè¯äº†Transformeræ¶æ„ï¼Œæœªæ¥éœ€é€‚é…Mambaç­‰æ–°å‹æ¨¡å‹ã€‚  </li><li>å¯è¿›ä¸€æ­¥ç»“åˆKVå‹ç¼©æŠ€æœ¯ï¼ˆå¦‚é‡åŒ–ã€å‰ªæï¼‰å‡å°‘å­˜å‚¨å¼€é”€ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Paper Report </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLM </tag>
            
            <tag> EuroSys 2025 </tag>
            
            <tag> Inference </tag>
            
            <tag> KVCache </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EP02-vLLMæºç è®²è§£ç›´æ’­ç¬”è®°-åˆ†å¸ƒå¼é€šä¿¡ä¸å¹¶è¡Œç­–ç•¥</title>
      <link href="/2025/03/25/vLLM-EP02/"/>
      <url>/2025/03/25/vLLM-EP02/</url>
      
        <content type="html"><![CDATA[<h1 id="FIXME-EP02-vLLM-æºç è®²è§£ç›´æ’­ç¬”è®°"><a href="#FIXME-EP02-vLLM-æºç è®²è§£ç›´æ’­ç¬”è®°" class="headerlink" title="[FIXME][EP02] vLLM æºç è®²è§£ç›´æ’­ç¬”è®°"></a>[FIXME][EP02] vLLM æºç è®²è§£ç›´æ’­ç¬”è®°</h1><h2 id="EP02-åˆ†å¸ƒå¼é€šä¿¡ä¸å¹¶è¡Œç­–ç•¥"><a href="#EP02-åˆ†å¸ƒå¼é€šä¿¡ä¸å¹¶è¡Œç­–ç•¥" class="headerlink" title="EP02: åˆ†å¸ƒå¼é€šä¿¡ä¸å¹¶è¡Œç­–ç•¥"></a>EP02: åˆ†å¸ƒå¼é€šä¿¡ä¸å¹¶è¡Œç­–ç•¥</h2><p>ç›´æ’­å›çœ‹é“¾æ¥ï¼š<a href="https://www.youtube.com/watch?v=W83Zgbg8SkE&t=4s">https://www.youtube.com/watch?v=W83Zgbg8SkE&amp;t=4s</a></p><p>ç‰¹åˆ«é¸£è°¢ï¼šæœˆçƒå¤§å”ï¼ŒDu Kuntaiï¼ŒCheng Yihua å¤§ä½¬å¸¦æ¥çš„ç²¾å½©è®²è§£</p><h3 id="ğŸ“Œ-1-GroupCoordinator-ç±»è§£æ"><a href="#ğŸ“Œ-1-GroupCoordinator-ç±»è§£æ" class="headerlink" title="ğŸ“Œ 1. GroupCoordinator ç±»è§£æ"></a>ğŸ“Œ 1. GroupCoordinator ç±»è§£æ</h3><p>â€˜vllm&#x2F;distributed&#x2F;parallel_state.pyâ€™</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¯ä»¥æŠŠGroupCoordinatoræƒ³è±¡æˆä¸€ä¸ªç¾¤èŠ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GroupCoordinator</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    # PyTorch ProcessGroup çš„å°è£…ï¼Œç®¡ç†è¿›ç¨‹ç»„é—´çš„é€šä¿¡</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    PyTorch ProcessGroup wrapper for a group of processes.</span></span><br><span class="line"><span class="string">    PyTorch ProcessGroup is bound to one specific communication backend,</span></span><br><span class="line"><span class="string">        e.g. NCCL, Gloo, MPI, etc.</span></span><br><span class="line"><span class="string">    GroupCoordinator takes charge of all the communication operations among</span></span><br><span class="line"><span class="string">        the processes in the group. It can route the communication to</span></span><br><span class="line"><span class="string">        a specific implementation (e.g. switch allreduce implementation</span></span><br><span class="line"><span class="string">        based on the tensor size and cuda graph mode).</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># available attributes:</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¿™ä¸ªç¾¤é‡Œè¡¨ç¤ºçš„æ˜¯æˆ‘æ˜¯è°</span></span><br><span class="line">    rank: <span class="built_in">int</span>  <span class="comment"># global rank</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åœ¨è¿™ä¸ªç¾¤é‡ŒåŠ ä¸Šæˆ‘è¿˜æœ‰å“ªäº›äºº</span></span><br><span class="line">    ranks: <span class="type">List</span>[<span class="built_in">int</span>]  <span class="comment"># global ranks in the group</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åœ¨ç¾¤é‡Œçš„äººæ•°</span></span><br><span class="line">    world_size: <span class="built_in">int</span>  <span class="comment"># size of the group</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># difference between `local_rank` and `rank_in_group`:</span></span><br><span class="line">    <span class="comment"># if we have a group of size 4 across two nodes:</span></span><br><span class="line">    <span class="comment"># Process | Node | Rank | Local Rank | Rank in Group</span></span><br><span class="line">    <span class="comment">#   0     |   0  |  0   |     0      |       0</span></span><br><span class="line">    <span class="comment">#   1     |   0  |  1   |     1      |       1</span></span><br><span class="line">    <span class="comment">#   2     |   1  |  2   |     0      |       2</span></span><br><span class="line">    <span class="comment">#   3     |   1  |  3   |     1      |       3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹åº”é€»è¾‘ä¸Šçš„GPU idï¼ˆæ¯”å¦‚ä¸€å°8å¡æœºä¸Šï¼Œ0å·GPUè¢«å ç”¨äº†çš„è¯ï¼ŒSET_CUDA_DEVICE=1-6ä¹‹åï¼Œå†…éƒ¨æ˜ å°„ä¸º0-5ï¼‰</span></span><br><span class="line">    local_rank: <span class="built_in">int</span>  <span class="comment"># local rank used to assign devices</span></span><br><span class="line"></span><br><span class="line">    rank_in_group: <span class="built_in">int</span>  <span class="comment"># rank inside the group</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># CPUçš„é€šä¿¡æ›´åŠ å¯æ§ï¼Œæ›´å¥½åšï¼Œç”¨äºä¸»æœºç«¯åŒæ­¥ï¼ˆå¦‚åˆå§‹åŒ–é˜¶æ®µï¼‰ï¼Œæ”¯æŒä»»æ„é€šä¿¡åç«¯ï¼ˆGloo/MPIï¼‰</span></span><br><span class="line">    cpu_group: ProcessGroup  <span class="comment"># group for CPU communication</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç”¨äºè®¾å¤‡é—´æ•°æ®ä¼ è¾“ï¼ˆå¿…é¡»ä½¿ç”¨æ”¯æŒGPUçš„åç«¯ï¼Œå¦‚NCCLï¼‰</span></span><br><span class="line">    device_group: ProcessGroup  <span class="comment"># group for device communication</span></span><br><span class="line"></span><br><span class="line">    use_pynccl: <span class="built_in">bool</span>  <span class="comment"># a hint of whether to use PyNccl</span></span><br><span class="line">    use_custom_allreduce: <span class="built_in">bool</span>  <span class="comment"># a hint of whether to use CustomAllreduce</span></span><br><span class="line">    <span class="comment"># communicators are only created for world size &gt; 1</span></span><br><span class="line">    pynccl_comm: <span class="type">Optional</span>[<span class="type">Any</span>]  <span class="comment"># PyNccl communicator</span></span><br><span class="line">    ca_comm: <span class="type">Optional</span>[<span class="type">Any</span>]  <span class="comment"># Custom allreduce communicator</span></span><br><span class="line">    mq_broadcaster: <span class="type">Optional</span>[<span class="type">Any</span>]  <span class="comment"># shared memory broadcaster</span></span><br></pre></td></tr></table></figure><h3 id="âš¡-2-å¹¶è¡Œç­–ç•¥è¯¦è§£"><a href="#âš¡-2-å¹¶è¡Œç­–ç•¥è¯¦è§£" class="headerlink" title="âš¡ 2. å¹¶è¡Œç­–ç•¥è¯¦è§£"></a>âš¡ 2. å¹¶è¡Œç­–ç•¥è¯¦è§£</h3><ul><li><p>TPï¼ˆå¼ é‡å¹¶è¡Œï¼‰</p><ul><li>éœ€è¦allreduceï¼Œé€šä¿¡é‡å¤§ï¼Œå¯¹äºé€šä¿¡éœ€æ±‚è¾ƒé«˜</li><li>Infraç«¯<ul><li>é€šä¿¡è®¾å¤‡<ul><li>NVLink: GPUä¹‹é—´çš„ç›´æ¥é€šä¿¡ï¼Œå¸¸ç”¨äºèŠ‚ç‚¹å†…é€šä¿¡</li><li>InfiniBand: æœ¬è´¨ä¸Šä¹Ÿæ˜¯ç¡¬ä»¶ï¼Œå¸¸ç”¨äºèŠ‚ç‚¹é—´é€šä¿¡</li><li>RDMA: RDMAç½‘å¡ï¼Œæœ€å¤§çš„å¥½å¤„æ˜¯è·³è¿‡æ“ä½œç³»ç»Ÿ &#x2F; zero copy, RoCE</li></ul></li><li>é€šä¿¡åº“ï¼šâ€™vllm&#x2F;distributed&#x2F;device_communicatorsâ€™<ul><li>PyNccl: Nvidia ä¹‹é—´çš„é€šä¿¡</li><li>Shared memory: æ“ä½œç³»ç»Ÿä¸­ä¸åŒè¿›ç¨‹ä¹‹é—´æ•°æ®å…±äº«</li><li>Custom allreduce: ä¸“ä¸ºall reduceæ“ä½œçš„kernel </li><li>torch.distributed: å¹¿æ³›æ”¯æŒä¸€ç³»åˆ—çš„é€šä¿¡åº“</li></ul></li></ul></li><li>ç®—æ³•ç«¯<ul><li>æƒ³äº†è§£ä»»ä½•é€šä¿¡æ–¹å¼å¯ä»¥äº†è§£ï¼šâ€™vllm&#x2F;model_executor&#x2F;models&#x2F;llama.pyâ€™ï¼Œllamaç³»æ¨¡å‹æ”¯æŒå„ç§å¹¶è¡Œæ–¹å¼ï¼Œé€‚åˆåˆå­¦è€…å­¦ä¹ æ¶æ„</li><li>â€˜get_tp_group()â€™</li></ul></li></ul></li><li><p>PPï¼ˆæµæ°´çº¿å¹¶è¡Œï¼‰</p><ul><li>é€šä¿¡é‡ç›¸å¯¹è¾ƒå°ï¼Œå¯¹deviceâ€“deviceé€šä¿¡éœ€æ±‚è¾ƒä½</li><li>ä¸èƒ½é™ä½å»¶è¿Ÿï¼Œä½†èƒ½æé«˜åå</li><li>ç®—æ³•ç«¯<ul><li>æ¯ä¸ªworkerè´Ÿè´£ä¸€ä¸ªlayersçš„å­é›†<ul><li>â€˜vllm&#x2F;model_executor&#x2F;models&#x2F;llama.pyâ€™ ä¸­ self.start_layer â€“&gt; self.end_layer</li><li>åœ¨workerä¹‹é—´: communicate IntermediateTensor</li><li>â€˜vllm&#x2F;worker&#x2F;model_runner.pyâ€™: æœç´¢ â€˜get_pp_group()â€™</li></ul></li></ul></li></ul></li><li><p>EPï¼ˆä¸“å®¶å¹¶è¡Œï¼‰&amp; DPï¼ˆæ•°æ®å¹¶è¡Œï¼‰</p><ul><li><p>ä¸ºä»€ä¹ˆè¦æœ‰EPï¼Ÿ</p><ul><li>Mistral &#x2F; Mixtral &#x2F; Deepseek éƒ½æ˜¯ç”¨MOE</li><li>MOEå…·æœ‰è®¡ç®—ç¨€ç–æ€§ï¼Œæ¯ä¸ªrequeståªæ¿€æ´»ä¸€å°éƒ¨åˆ†çš„expert</li></ul></li><li><p>å°†ä¸åŒçš„expertæ”¾åœ¨ä¸åŒçš„deviceä¸Šâ€“&gt;ä¸“å®¶å¹¶è¡Œ</p></li><li><p>ç®—æ³•ç«¯</p><ul><li>Shuffle (DeepEP communication kernel)</li><li>Forward</li><li>Shuffle back</li></ul></li><li><p>åœ¨Attentionæ¨¡å—åšTPï¼Œåœ¨FFNæ¨¡å—åšEP</p></li><li><p>share expertè´Ÿè½½è¾ƒé«˜ï¼Œè¦åšå†—ä½™</p></li><li><p>DP (æ•°æ®å¹¶è¡Œ)</p><ul><li>æœ€å¤§çš„TP &lt;&lt; æ‰€éœ€è¦çš„EPï¼ˆEP&#x3D;320ï¼‰</li><li>TP &lt; # attention head</li><li>TP * DP &#x3D;&#x3D; EPï¼ˆé€šè¿‡è¯·æ±‚å¹¶è¡Œçš„æ–¹å¼å»æ‹‰æ»¡è®¡ç®—èµ„æºï¼‰</li><li>åœ¨å®è·µä¸­éš¾ä»¥åº”ç”¨<ul><li>å¯¹è¯·æ±‚è¿›è¡Œpaddingé¿å…é€ æˆæ­»é”</li></ul></li></ul></li></ul></li></ul><p>â€‹    </p>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLM </tag>
            
            <tag> Inference </tag>
            
            <tag> vLLM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sarathi-Serve-PDèåˆçš„LLMæœåŠ¡è°ƒåº¦å™¨</title>
      <link href="/2025/03/19/Sarathi/"/>
      <url>/2025/03/19/Sarathi/</url>
      
        <content type="html"><![CDATA[<p>Sarathi-Serve æ˜¯ä¸€ä¸ªé«˜æ•ˆå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æ¨ç†è°ƒåº¦å™¨ï¼Œæ—¨åœ¨è§£å†³LLMæ¨ç†ä¸­<strong>ååé‡</strong>å’Œ<strong>å»¶è¿Ÿ</strong>ä¹‹é—´çš„æƒè¡¡é—®é¢˜ã€‚é€šè¿‡å¼•å…¥â€œåˆ†å—é¢„å¡«å……ï¼ˆchunked-prefillsï¼‰â€å’Œâ€œæ— åœé¡¿è°ƒåº¦ï¼ˆstall-free schedulingï¼‰â€æŠ€æœ¯ï¼ŒSarathi-Serveèƒ½å¤Ÿåœ¨ä¿æŒä½å»¶è¿Ÿçš„åŒæ—¶æ˜¾è‘—æé«˜æ¨ç†ååé‡ã€‚</p><p>è®ºæ–‡ï¼š(OSDI 2024)<a href="https://www.usenix.org/system/files/osdi24-agrawal.pdf">Taming Throughput-Latency Tradeoff in LLM Inference with Sarathi-Serve</a></p><p>ä»£ç ï¼š<a href="https://github.com/microsoft/sarathi-serve">microsoft&#x2F;sarathi-serve: A low-latency &amp; high-throughput serving engine for LLMs</a></p><p>è¯¥æ–‡ç« å‚è€ƒè‡ªï¼š<a href="https://zhuanlan.zhihu.com/p/12679786211">https://zhuanlan.zhihu.com/p/12679786211</a></p><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><h2 id="LLMæœåŠ¡ç‰¹æ€§"><a href="#LLMæœåŠ¡ç‰¹æ€§" class="headerlink" title="LLMæœåŠ¡ç‰¹æ€§"></a>LLMæœåŠ¡ç‰¹æ€§</h2><p>LLMæ¨ç†åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p><ul><li><strong>Prefillï¼ˆé¢„å¡«å……ï¼‰</strong>ï¼šå¤„ç†è¾“å…¥æç¤ºå¹¶ç”Ÿæˆé¦–ä¸ªè¾“å‡ºä»¤ç‰Œï¼Œè®¡ç®—å¯†é›†ä½†å»¶è¿Ÿé«˜ã€‚</li><li><strong>Decodeï¼ˆè§£ç ï¼‰</strong>ï¼šé€ä¸ªç”Ÿæˆåç»­ä»¤ç‰Œï¼Œå»¶è¿Ÿä½ä½†è®¡ç®—åˆ©ç”¨ç‡ä½ã€‚</li></ul><p>å½“å‰çš„LLMæ¨ç†è°ƒåº¦å™¨å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œå³æ ¹æ®å®ƒä»¬åœ¨æ‰¹å¤„ç†è¯·æ±‚æ—¶å¦‚ä½•è°ƒåº¦é¢„å¡«å……å’Œè§£ç é˜¶æ®µï¼Œåˆ†ä¸º<strong>é¢„å¡«å……ä¼˜å…ˆ</strong>å’Œ<strong>è§£ç ä¼˜å…ˆ</strong>ï¼š</p><ol><li><p><strong>ä¼ ç»Ÿçš„è¯·æ±‚çº§æ‰¹å¤„ç†ç³»ç»Ÿï¼Œå¦‚FasterTransformerï¼Œé‡‡ç”¨è§£ç ä¼˜å…ˆçš„è°ƒåº¦ç­–ç•¥ã€‚</strong></p><p> åªæœ‰æ‰¹å¤„ç†ä¸­çš„æ‰€æœ‰è¯·æ±‚éƒ½å®Œæˆäº†å®ƒä»¬çš„è§£ç é˜¶æ®µåï¼Œè¯¥æ‰¹å¤„ç†æ‰ç®—å®Œæˆï¼Œå³åªè¦æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªè¯·æ±‚æ­£åœ¨è¿›è¡Œè§£ç ï¼Œå°±ä¸ä¼šè°ƒåº¦æ–°çš„é¢„å¡«å……ã€‚</p></li><li><p><strong>ç°æœ‰è°ƒåº¦ç­–ç•¥ï¼ˆå¦‚vLLMã€Orcaï¼‰å¼•å…¥è¿­ä»£çº§è°ƒåº¦ï¼Œä½¿ç”¨è¿ç»­æ‰¹å¤„ç†æŠ€æœ¯ã€‚</strong></p><p> æ¯å½“GPUå†…å­˜å¯ç”¨æ—¶ï¼Œä¼˜å…ˆè°ƒåº¦é¢„å¡«å……é˜¶æ®µçš„è¯·æ±‚ã€‚é¢„å¡«å……ä¼˜å…ˆçš„è°ƒåº¦å™¨å…·æœ‰æ›´å¥½çš„ååé‡ï¼Œå› ä¸ºè¿™æ ·å…è®¸åç»­çš„è§£ç ä»¥é«˜æ‰¹æ¬¡å¤§å°è¿è¡Œã€‚ç„¶è€Œï¼Œä¼˜å…ˆå¤„ç†é¢„å¡«å……ä¼šå¹²æ‰°æ­£åœ¨è¿›è¡Œçš„è§£ç ï¼Œå¯¼è‡´é«˜å»¶è¿Ÿï¼ˆç”Ÿæˆåœæ»ï¼‰ã€‚</p></li></ol><p>æ€»çš„æ¥è¯´ï¼Œç°æœ‰LLMæœåŠ¡å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li>ååé‡ä¸å»¶è¿Ÿçš„å†²çªï¼šä¼˜å…ˆå¤„ç†Prefillï¼ˆæé«˜ååé‡ï¼‰ä¼šå¯¼è‡´è§£ç é˜¶æ®µçš„é«˜å»¶è¿Ÿï¼ˆç”Ÿæˆåœæ»ï¼‰ï¼Œè€Œä¼˜å…ˆå¤„ç†Decodeï¼ˆé™ä½å»¶è¿Ÿï¼‰åˆ™ä¼šç‰ºç‰²ååé‡ã€‚</li><li>ç®¡é“å¹¶è¡Œä¸­çš„æ°”æ³¡ï¼šæ··åˆPrefillå’ŒDecodeçš„æ‰¹æ¬¡å› è®¡ç®—æ—¶é—´å·®å¼‚å¯¼è‡´GPUèµ„æºæµªè´¹ã€‚</li><li>é•¿æç¤ºå¤„ç†æ•ˆç‡ä½ï¼šé•¿è¾“å…¥æç¤ºçš„Prefillé˜¶æ®µè€—æ—¶è¿‡é•¿ï¼ŒåŠ å‰§å»¶è¿Ÿæ³¢åŠ¨ã€‚</li></ul><h1 id="å­˜åœ¨çš„é—®é¢˜ä¸æŒ‘æˆ˜"><a href="#å­˜åœ¨çš„é—®é¢˜ä¸æŒ‘æˆ˜" class="headerlink" title="å­˜åœ¨çš„é—®é¢˜ä¸æŒ‘æˆ˜"></a>å­˜åœ¨çš„é—®é¢˜ä¸æŒ‘æˆ˜</h1><ul><li><p>é¢„å¡«å……å’Œè§£ç é˜¶æ®µçš„æˆæœ¬åˆ†æã€‚</p><p><img src="/posts_img/Sarathi/1.png"></p><p>LLMæ¨ç†çš„ä¸¤ä¸ªé˜¶æ®µâ€”â€”é¢„å¡«å……å’Œè§£ç â€”â€”è¡¨ç°å‡ºæˆªç„¶ç›¸åçš„è¡Œä¸ºï¼Œå…¶ä¸­æ‰¹é‡å¤„ç†å¯ä»¥æå¤§åœ°æé«˜è§£ç é˜¶æ®µçš„ååé‡ï¼Œä½†å¯¹é¢„å¡«å……ååé‡å‡ ä¹æ²¡æœ‰å½±å“ï¼›åºåˆ—é•¿åº¦æå¤§åœ°å½±å“é¢„å¡«å……çš„æ—¶é—´ï¼Œä½†æ‰¹é‡å¤§å°å‡ ä¹ä¸å½±å“è§£ç çš„å»¶è¿Ÿã€‚</p><p>è§£ç æ‰¹å¤„ç†åœ¨å†…å­˜å—é™çš„çŠ¶æ€ä¸‹è¿è¡Œï¼Œå¯¼è‡´è®¡ç®—æœªå¾—åˆ°å……åˆ†åˆ©ç”¨ã€‚è¿™æ„å‘³ç€å¯ä»¥åœ¨è§£ç æ‰¹å¤„ç†çš„åŒæ—¶å¤„ç†æ›´å¤šçš„ä»¤ç‰Œï¼Œè€Œä¸ä¼šæ˜¾è‘—å¢åŠ å…¶å»¶è¿Ÿã€‚</p></li><li><p>ä¼˜åŒ–çº¿æ€§æ“ä½œå¯¹äºæé«˜å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„æ¨ç†æ•ˆç‡è‡³å…³é‡è¦ã€‚</p><p><img src="/posts_img/Sarathi/2.png"></p><p>ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé¢„å¡«å……æ—¶é—´éšç€åºåˆ—é•¿åº¦å¢åŠ è€Œè¿‘ä¹äºŒæ¬¡å¢é•¿ï¼Œä¸”çº¿æ€§æ“ä½œå ç”¨äº†å¤§éƒ¨åˆ†çš„è¿è¡Œæ—¶é—´æˆæœ¬ã€‚è™½ç„¶æ³¨æ„åŠ›æˆæœ¬éšç€åºåˆ—é•¿åº¦çš„å¢åŠ è€Œå‘ˆäºŒæ¬¡å¢é•¿ï¼Œä½†åœ¨é«˜åºåˆ—é•¿åº¦ä¸‹ï¼Œçº¿æ€§æ“ä½œä»ç„¶è´¡çŒ®äº†è¶…è¿‡80%çš„æ€»æ—¶é—´ã€‚</p></li><li><p>é¢„å¡«å……å’Œè§£ç é˜¶æ®µçš„è®¡ç®—ç‰¹æ€§æ˜¯ä¸åŒçš„ã€‚</p></li></ul><table><thead><tr><th align="center"><img src="/posts_img/Sarathi/3.png" alt="Image 1"></th><th align="center"><img src="/posts_img/Sarathi/4.png" alt="Image 2"></th></tr></thead></table><p>  åœ¨ä¸Šå›¾ï¼ˆå·¦ï¼‰ä¸­ï¼Œç”¨ï¼ˆè®¡ç®—é‡&#x2F;è®¿å­˜é‡ï¼‰è¡¡é‡ä¸¤ä¸ªé˜¶æ®µçš„è®¡ç®—å¼ºåº¦ï¼ŒDecodeå¤„äºè®¿å­˜å—é™åŒºåŸŸï¼ŒPrifillå¤„äºè®¡ç®—å—é™åŒºåŸŸï¼Œæœ€ç†æƒ³çš„æ˜¯å¹³è¡¡ç‚¹æ˜¯æ“ä½œçš„ç®—æœ¯å¼ºåº¦ä¸è®¾å¤‡çš„FLOPS-to-Bandwidthæ¯”ç‡ç›¸åŒ¹é…ã€‚</p><p>  å³å›¾æ˜¾ç¤ºäº†LLaMA2-70Bä¸­<strong>çº¿æ€§å±‚</strong>è®¡ç®—åœ¨ä¸€æ¬¡è¿­ä»£ä¸­çš„æ€»æ‰§è¡Œæ—¶é—´éštokenæ•°é‡çš„å˜åŒ–ã€‚åœ¨å¼€å§‹æ—¶ï¼Œå½“æ‰¹æ¬¡å¤„äºå—å†…å­˜é™åˆ¶çš„çŠ¶æ€æ—¶ï¼Œæ‰§è¡Œæ—¶é—´ä»…ç•¥æœ‰å¢åŠ ï¼Œä½†éšåéšç€æ‰¹æ¬¡å˜ä¸ºå—è®¡ç®—é™åˆ¶çš„çŠ¶æ€ï¼Œæ‰§è¡Œæ—¶é—´å‘ˆçº¿æ€§å¢é•¿ã€‚</p><ul><li><p>ååé‡ä¸å»¶è¿Ÿçš„æƒè¡¡ã€‚</p><p><img src="/posts_img/Sarathi/5.png"></p><p>vLLMå’ŒOrcaéƒ½æ˜¯prefillä¼˜å…ˆï¼ŒvLLMæ— æ³•æ··åˆpdé˜¶æ®µçš„batchï¼ŒOrcaé€šè¿‡çº¿æ€§å±‚æ‰¹å¤„ç†åšåˆ°äº†pdæ··åˆbatchï¼Œä½†ç”±äºprefillé˜¶æ®µçš„Attentionç®—å­è€—æ—¶é•¿ï¼Œè¿˜æ˜¯ä¼šæ‹–ç´¯TBTã€‚FastTransformeræ˜¯decodingä¼˜å…ˆï¼Œæ— æ³•æ··åˆpdé˜¶æ®µçš„batchï¼Œstalläº†prefillé˜¶æ®µï¼Œå¯¼è‡´TTFTå¤§ã€‚</p><p>å½“ä»Šæœ€å…ˆè¿›çš„ç³»ç»Ÿä½¿ç”¨é¢„å¡«å……ä¼˜å…ˆçº§è°ƒåº¦ï¼Œæ‰¹è¶Šå¤§ï¼Œååé‡è¶Šé«˜ï¼Œå»¶è¿Ÿè¶Šé«˜ï¼Œè¦æ ¹æ®æ‰€éœ€çš„SLOåœ¨ååé‡å’Œå»¶è¿Ÿä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚</p></li><li><p>æµæ°´çº¿æ°”æ³¡ã€‚</p><p><img src="/posts_img/Sarathi/6.png"></p><p>æ¨ç†è¿‡ç¨‹ä¸­å­˜åœ¨çš„ä¸‰ç§ç±»å‹çš„æ°”æ³¡ï¼š</p><ol><li>ç”±äºè¿ç»­ä¸¤ä¸ªå¾®æ‰¹æ¬¡ä¸­prefillä»¤ç‰Œçš„æ•°é‡ä¸åŒè€Œäº§ç”Ÿï¼›</li><li>ç”±äºprefillå’Œdecodeé˜¶æ®µçš„è®¡ç®—æ—¶é—´ä¸åŒè€Œäº§ç”Ÿï¼›</li><li>ç”±äºå¾®æ‰¹æ¬¡ä¹‹é—´decodeè®¡ç®—æ—¶é—´çš„å·®å¼‚è€Œäº§ç”Ÿï¼Œå› ä¸ºæ³¨æ„åŠ›æˆæœ¬å–å†³äºç´¯ç§¯çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼ˆKVç¼“å­˜çš„å¤§å°ï¼‰ï¼Œå¹¶åœ¨ä¸åŒè¯·æ±‚ä¹‹é—´å˜åŒ–ã€‚</li></ol><p>æ€»çš„æ¥è¯´ï¼Œæ˜¯ç”±äºå¾®æ‰¹ä¹‹é—´çš„è®¡ç®—ä¸å‡åŒ€å¯¼è‡´ï¼Œæœ¬è´¨ä¸Šä¸»è¦è¿˜æ˜¯å› ä¸ºæ— æ³•å®Œç¾è€¦åˆprefillå’Œdecodeä¸¤ä¸ªè®¡ç®—ã€è°ƒåº¦ç‰¹æ€§çš„ä¸åŒçš„é˜¶æ®µã€‚</p></li></ul><h1 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h1><h2 id="åˆ†å—é¢„å¡«å……"><a href="#åˆ†å—é¢„å¡«å……" class="headerlink" title="åˆ†å—é¢„å¡«å……"></a>åˆ†å—é¢„å¡«å……</h2><p>å…è®¸åœ¨å¤šä¸ªè¿­ä»£ä¸­ä»¥å°å—å½¢å¼è®¡ç®—prefillã€‚åŸºäºå‰é¢çš„æŒ‘æˆ˜å¯ä»¥å‘ç°ï¼Œé€‚åº¦åºåˆ—é•¿åº¦çš„prefillè¯·æ±‚å¯ä»¥æœ‰æ•ˆåœ°ä½¿GPUè®¡ç®—èƒ½åŠ›è¾¾åˆ°é¥±å’Œï¼Œé‚£ä¹ˆåˆ©ç”¨è¿™ä¸€æœºåˆ¶å½¢æˆå…·æœ‰é€‚å½“tokenæ•°é‡çš„æ‰¹æ¬¡ï¼Œå°†åºåˆ—prefillçš„ä¸€éƒ¨åˆ†åŠ å…¥åˆ°decodeæ‰¹ä¸­æ¥ï¼Œä»¥å……åˆ†åˆ©ç”¨è®¡ç®—æ½œåŠ›ï¼ŒåŒæ—¶ä¸è¿åTBTï¼ˆæ€»æ‰¹å¤„ç†æ—¶é—´ï¼‰æœåŠ¡çº§åˆ«ç›®æ ‡ã€‚</p><h2 id="æ— åœé¡¿æ‰¹å¤„ç†"><a href="#æ— åœé¡¿æ‰¹å¤„ç†" class="headerlink" title="æ— åœé¡¿æ‰¹å¤„ç†"></a>æ— åœé¡¿æ‰¹å¤„ç†</h2><p>Sarathi-Serveè°ƒåº¦å™¨æ˜¯ä¸€ä¸ªè¿­ä»£çº§åˆ«çš„è°ƒåº¦å™¨ï¼Œå®ƒåˆ©ç”¨chunked prefillå’Œé¢„å¡«å……ä¸è§£ç çš„åˆå¹¶æ¥æé«˜ååé‡ï¼ŒåŒæ—¶æœ€å°åŒ–å»¶è¿Ÿï¼Œä½œè€…ç§°è¿™ç§æ–¹æ³•ä¸ºæ— åœé¡¿æ‰¹å¤„ç†ã€‚</p><p><img src="/posts_img/Sarathi/7.png"></p><p>Sarathi-Serveé¦–å…ˆæ ¹æ®ç”¨æˆ·æŒ‡å®šçš„æœåŠ¡çº§åˆ«ç›®æ ‡ï¼ˆSLOï¼‰è®¡ç®—æ¯æ‰¹å¯æ‰§è¡Œçš„æœ€å¤§ä»¤ç‰Œæ•°é¢„ç®—ã€‚ï¼ˆè¯¦è§ä¸‹ä¸€å°èŠ‚ï¼‰</p><p>ç®—æ³•æµç¨‹ï¼š</p><ol><li>åœ¨æ¯ä¸ªè°ƒåº¦è¿­ä»£ä¸­ï¼Œé¦–å…ˆå°†æ‰€æœ‰æ­£åœ¨decodeé˜¶æ®µçš„è¯·æ±‚æ”¾å…¥æ‰¹æ¬¡ä¸­ï¼ˆç¬¬6-8è¡Œï¼‰</li><li>å¯¹äºæœªå®Œæˆé¢„å¡«å……çš„è¯·æ±‚ï¼Œåˆ†å—åŠ å…¥ï¼ˆç¬¬9-12è¡Œï¼‰</li><li>åªæœ‰åœ¨æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„è¯·æ±‚éƒ½è¢«å®¹çº³åï¼Œæ‰æ¥å—æ–°è¯·æ±‚ï¼ˆç¬¬13-20è¡Œï¼‰</li></ol><p>æ³¨æ„ï¼šåœ¨å‘æ‰¹æ¬¡æ·»åŠ é¢„å¡«å……è¯·æ±‚æ—¶ï¼Œè¦è®¡ç®—åœ¨è¯¥æ‰¹æ¬¡çš„å‰©ä½™tokené¢„ç®—ä¸­å¯å®¹çº³çš„æœ€å¤§å—å¤§å°ï¼ˆç¬¬11ã€15è¡Œï¼‰</p><p>é€šè¿‡é™åˆ¶æ¯æ¬¡è¿­ä»£çš„è®¡ç®—è´Ÿè½½ï¼Œæ— åœé¡¿æ‰¹å¤„ç†ç¡®ä¿è§£ç ä¸ä¼šå› ä¸ºå¹¶è¡Œçš„é¢„å¡«å……å—è€Œç»å†ç”Ÿæˆåœé¡¿ã€‚</p><h2 id="ç¡®å®štokené¢„ç®—"><a href="#ç¡®å®štokené¢„ç®—" class="headerlink" title="ç¡®å®štokené¢„ç®—"></a>ç¡®å®štokené¢„ç®—</h2><p>Tokené¢„ç®—çš„ç¡®å®šéœ€å¹³è¡¡ä¸¤ä¸ªç›¸äº’åˆ¶çº¦çš„å› ç´ ï¼š</p><ul><li><p>å»¶è¿Ÿç›®æ ‡ï¼ˆTBT SLOï¼‰ï¼šè¾ƒå°çš„Tokené¢„ç®—ï¼ˆåˆ†å—æ›´ç»†ï¼‰å¯é™ä½å•æ¬¡è¿­ä»£å»¶è¿Ÿï¼Œä½†å¯èƒ½å¯¼è‡´ï¼š</p><ol><li>GPUåˆ©ç”¨ç‡ä¸‹é™ï¼Œé¢‘ç¹åˆ†å—å¢åŠ è°ƒåº¦å¼€é”€ï¼›</li><li>KVç¼“å­˜é‡å¤è®¿é—®ï¼šæ¯ä¸ªåˆ†å—éœ€è®¿é—®ä¹‹å‰æ‰€æœ‰åˆ†å—çš„KVç¼“å­˜ï¼Œå¯¼è‡´æ˜¾å­˜è¯»å–æ¬¡æ•°å¢åŠ ï¼ˆä¾‹å¦‚ï¼Œåˆ†å—æ•°ä¸ºNæ—¶ï¼Œé¦–ä¸ªåˆ†å—çš„KVç¼“å­˜è¢«åŠ è½½Nâˆ’1æ¬¡ï¼‰ã€‚</li></ol></li><li><p>åˆ†å—é¢„å¡«å……å¼€é”€ï¼š</p><ol><li>Tile-Quantizationæ•ˆåº”ï¼šGPUçŸ©é˜µä¹˜æ³•ï¼ˆMatmulï¼‰çš„ç¡¬ä»¶ä¼˜åŒ–è¦æ±‚åˆ†å—å¤§å°ä¸GPUçš„Tileå°ºå¯¸å¯¹é½ï¼ˆå¦‚256ï¼‰ã€‚è‹¥åˆ†å—å¤§å°ä¸åŒ¹é…ï¼ˆå¦‚257ï¼‰ï¼Œè®¡ç®—æ—¶é—´å¯èƒ½å¢åŠ 32%ã€‚</li><li>ç®¡é“å¹¶è¡Œæ°”æ³¡ï¼šè¾ƒå¤§çš„åˆ†å—å¯¼è‡´æ‰¹æ¬¡é—´è¿è¡Œæ—¶é—´å·®å¼‚å¤§ï¼Œäº§ç”ŸGPUé—²ç½®ï¼ˆæ°”æ³¡ï¼‰ï¼›è¿‡å°çš„åˆ†å—åˆ™å› ç®—æœ¯å¼ºåº¦ä½å’Œå›ºå®šå¼€é”€ï¼ˆå¦‚å†…æ ¸å¯åŠ¨ï¼‰é™ä½æ•ˆç‡ã€‚</li></ol></li></ul><p>ä¼˜åŒ–ç­–ç•¥ï¼š</p><ol><li>é€šè¿‡åˆ†æä¸åŒåˆ†å—å¤§å°çš„æ€§èƒ½ï¼ˆå¦‚é¢„å¡«å……æ—¶é—´ã€è§£ç å»¶è¿Ÿï¼‰ï¼Œæ‰¾åˆ°æ»¡è¶³TBT SLOçš„æœ€å¤§Tokené¢„ç®—ã€‚</li><li>æ ¹æ®GPUçš„Tileå°ºå¯¸è°ƒæ•´åˆ†å—å¤§å°ï¼Œé¿å…è®¡ç®—æµªè´¹ã€‚</li></ol><p>æ–‡ä¸­æ²¡æœ‰å…·ä½“è¯´æ˜ä¼˜åŒ–çš„ç­–ç•¥ï¼Œè€Œæ˜¯è¯´ä½¿ç”¨ Vidurï¼ˆLLMæ¨ç†æ€§èƒ½æ¨¡æ‹Ÿå™¨ï¼‰è¿›è¡Œåœºæ™¯åŒ–åˆ†æï¼Œç»“åˆæ¨¡å‹ã€ç¡¬ä»¶å’Œå¹¶è¡Œç­–ç•¥ï¼ˆå¦‚TP&#x2F;PPï¼‰åŠ¨æ€ä¼˜åŒ–Tokené¢„ç®—ã€‚</p><h1 id="ç®—æ³•å®ç°"><a href="#ç®—æ³•å®ç°" class="headerlink" title="ç®—æ³•å®ç°"></a>ç®—æ³•å®ç°</h1><p>åŸºäº vLLM è¿›è¡Œæ‰©å±•å’Œä¼˜åŒ–ã€‚é€šè¿‡ä½¿ç”¨ FlashAttention v2 å’Œ FlashInfer çš„å†…æ ¸ï¼ŒSarathi-Serve æ”¯æŒåˆ†å—é¢„å¡«å……ã€‚</p><h1 id="è¯„ä¼°"><a href="#è¯„ä¼°" class="headerlink" title="è¯„ä¼°"></a>è¯„ä¼°</h1><p>å®éªŒéƒ¨åˆ†è¯„ä¼°äº†Sarathi-Serveåœ¨ä¸åŒæ¨¡å‹å’Œç¡¬ä»¶é…ç½®ä¸‹çš„æ€§èƒ½ï¼ŒåŒ…æ‹¬Mistral-7Bã€Yi-34Bã€LLaMA2-70Bå’ŒFalcon-180Bæ¨¡å‹ï¼Œä»¥åŠå•ä¸ªA100 GPUã€ä¸¤ä¸ªA100 GPUï¼ˆTP2å¹¶è¡Œï¼‰ã€8ä¸ªA40 GPUï¼ˆTP4å’ŒPP2å¹¶è¡Œï¼‰ç­‰ç¡¬ä»¶é…ç½®ã€‚å®éªŒä½¿ç”¨äº†ä¸¤ä¸ªæ•°æ®é›†ï¼šopenchat_sharegpt4å’Œarxiv_summarizationï¼Œåˆ†åˆ«ä»£è¡¨å¤šè½®å¯¹è¯å’Œç§‘å­¦æ–‡çŒ®æ‘˜è¦ç”Ÿæˆçš„ä»»åŠ¡ã€‚</p><p><strong>å…³é”®ç»“è®º</strong></p><ol><li>ååé‡æå‡ï¼šSarathi-Serveåœ¨Mistral-7Bæ¨¡å‹ä¸Šå®ç°äº†2.6å€çš„æœåŠ¡å®¹é‡æå‡ï¼Œåœ¨Yi-34Bæ¨¡å‹ä¸Šå®ç°äº†3.7å€çš„æå‡ï¼ˆä¸vLLMç›¸æ¯”ï¼‰ã€‚åœ¨Falcon-180Bæ¨¡å‹ä¸Šï¼Œä½¿ç”¨æµæ°´çº¿å¹¶è¡Œæ—¶ï¼ŒSarathi-Serveæä¾›äº†é«˜è¾¾5.6å€çš„ç«¯åˆ°ç«¯æœåŠ¡å®¹é‡æå‡ã€‚</li><li>å»¶è¿Ÿä¼˜åŒ–ï¼šåœ¨Yi-34Bæ¨¡å‹ä¸Šï¼Œä¸ä¸ä½¿ç”¨åˆ†å—é¢„å¡«å……çš„æ··åˆæ‰¹æ¬¡ç›¸æ¯”ï¼ŒSarathi-Serveçš„å»¶è¿Ÿå¢åŠ ä»…ä¸º25%ï¼Œè€Œä½¿ç”¨å®Œæ•´é¢„å¡«å……çš„æ··åˆæ‰¹æ¬¡å»¶è¿Ÿå¢åŠ äº†28.3å€ã€‚</li><li>æµæ°´çº¿å¹¶è¡Œä¼˜åŒ–ï¼šSarathi-Serveé€šè¿‡åˆ›å»ºè®¡ç®—éœ€æ±‚å‡åŒ€çš„æ··åˆæ‰¹æ¬¡ï¼Œå‡å°‘äº†æµæ°´çº¿å¹¶è¡Œä¸­çš„æ°”æ³¡ï¼Œä»è€Œæé«˜äº†GPUåˆ©ç”¨ç‡ï¼Œä½¿å¾—åœ¨æ™®é€šä»¥å¤ªç½‘è¿æ¥çš„å¤šèŠ‚ç‚¹éƒ¨ç½²ä¸­ä¹Ÿèƒ½é«˜æ•ˆè¿è¡Œã€‚</li></ol><h1 id="ç›¸å…³å·¥ä½œ"><a href="#ç›¸å…³å·¥ä½œ" class="headerlink" title="ç›¸å…³å·¥ä½œ"></a>ç›¸å…³å·¥ä½œ</h1><p>å¦ä¸€ç§æ–°å…´çš„æ–¹æ³•æ˜¯å°†é¢„å¡«å……å’Œè§£ç é˜¶æ®µåœ¨ä¸åŒçš„å‰¯æœ¬ä¸Šè§£è€¦ï¼ˆPDåˆ†ç¦»ï¼‰ï¼Œå¦‚Mooncake, SplitWise, DistServeå’ŒTetriInfer æ‰€æå‡ºçš„é‚£æ ·ã€‚</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ol><li>è¿™äº›è§£å†³æ–¹æ¡ˆå®Œå…¨æ¶ˆé™¤äº†é¢„å¡«å……å’Œè§£ç ä¹‹é—´çš„å¹²æ‰°ï¼Œä¸åˆ†å—é¢„å¡«å……ç›¸æ¯”ï¼Œè§£è€¦æ–¹æ³•å¯ä»¥ä»¥æœ€å¤§æ•ˆç‡æ‰§è¡Œé¢„å¡«å……ï¼ˆå› æ­¤æä¾›æ›´å¥½çš„TTFTï¼‰ã€‚</li></ol><p><strong>ç¼ºç‚¹ï¼š</strong></p><ol><li>è§£è€¦éœ€è¦åœ¨é¢„å¡«å……é˜¶æ®µå®Œæˆåè¿ç§»æ¯ä¸ªè¯·æ±‚çš„KVç¼“å­˜ï¼Œè¿™åœ¨ç¼ºä¹é«˜å¸¦å®½äº’è¿çš„ä¸åŒå‰¯æœ¬ä¹‹é—´å…·æœ‰æŒ‘æˆ˜æ€§ã€‚</li><li>å¯¼è‡´å¤„ç†prefillçš„GPUå†…å­˜å®¹é‡æœªè¢«å……åˆ†åˆ©ç”¨ï¼Œè€Œdecodingéœ€è¦å­˜å‚¨å…¨é‡çš„KVç¼“å­˜ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> Paper Report </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLM </tag>
            
            <tag> Inference </tag>
            
            <tag> OSDI 2024 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Llumnix-å¤šå®ä¾‹LLMæœåŠ¡çš„è¯·æ±‚åŠ¨æ€è°ƒåº¦</title>
      <link href="/2025/03/13/Llumnix/"/>
      <url>/2025/03/13/Llumnix/</url>
      
        <content type="html"><![CDATA[<p>Llumnixæ­ç¤ºäº†LLMæœåŠ¡ä¸ä¼ ç»ŸDNNæ¨ç†çš„æ ¹æœ¬å·®å¼‚ï¼Œæå‡ºåŠ¨æ€è°ƒåº¦å¿…è¦æ€§ï¼Œè®¾è®¡äº†é¦–ä¸ªæ”¯æŒè·¨å®ä¾‹å®æ—¶è¿ç§»çš„LLMæœåŠ¡ç³»ç»Ÿï¼Œæ—¨åœ¨è§£å†³å¤§è§„æ¨¡è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æ¨ç†æœåŠ¡ä¸­çš„è¯·æ±‚é«˜æ•ˆè°ƒåº¦é—®é¢˜ã€‚é€šè¿‡åŠ¨æ€è¯·æ±‚è¿ç§»å’Œç»†ç²’åº¦è°ƒåº¦ç­–ç•¥ï¼ŒLlumnixåœ¨é™ä½å»¶è¿Ÿã€æé«˜ä¼˜å…ˆçº§æ”¯æŒå’Œé™ä½æˆæœ¬æ–¹é¢è¡¨ç°å‡ºè‰²ã€‚</p><p>è®ºæ–‡ï¼š(OSDI 2024)<a href="https://www.usenix.org/system/files/osdi24-sun-biao.pdf">Llumnix: Dynamic Scheduling for Large Language Model Serving</a></p><p>ä»£ç ï¼š<a href="https://github.com/AlibabaPAI/llumnix">https://github.com/AlibabaPAI/llumnix</a></p><p>è¯¥æ–‡ç« å‚è€ƒè‡ªï¼š</p><ol><li><a href="https://www.usenix.org/system/files/osdi24_slides-sun-biao.pdf">https://www.usenix.org/system/files/osdi24_slides-sun-biao.pdf</a></li><li><a href="https://19shuidiph.github.io/2024/12/30/paperreading-llumnix/#wechat">https://19shuidiph.github.io/2024/12/30/paperreading-llumnix/#wechat</a></li></ol><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><h2 id="LLMæœåŠ¡ç‰¹æ€§"><a href="#LLMæœåŠ¡ç‰¹æ€§" class="headerlink" title="LLMæœåŠ¡ç‰¹æ€§"></a>LLMæœåŠ¡ç‰¹æ€§</h2><ul><li><p><strong>å¼‚æ„æ€§</strong>ï¼šä¸åŒåº”ç”¨åœºæ™¯ï¼ˆå¦‚èŠå¤©ã€æ‘˜è¦ã€ä»£ç ç”Ÿæˆï¼‰å¯¼è‡´è¯·æ±‚çš„è¾“å…¥&#x2F;è¾“å‡ºé•¿åº¦ã€å»¶è¿Ÿéœ€æ±‚ï¼ˆGPT Plusï¼‰å·®å¼‚æ˜¾è‘—ã€‚<br>  <img src="/posts_img/Llumnix/1.png"></p></li><li><p><strong>ä¸å¯é¢„æµ‹æ€§</strong>ï¼šç”Ÿæˆtokenæ•°é‡æœªçŸ¥ï¼ŒGPUå†…å­˜å ç”¨åŠ¨æ€å¢é•¿ï¼Œä¼ ç»Ÿé™æ€è°ƒåº¦éš¾ä»¥åº”å¯¹ã€‚<br>  <img src="/posts_img/Llumnix/2.png"><br>  åœ¨æ¨ç†è¿‡ç¨‹ä¸­éµä»<a href="https://kevin-zhang-sysu.github.io/2024/09/14/Orca/">Orca</a>ä¸­æå‡ºçš„é€‰æ‹©æ€§æ‰¹å¤„ç†æœºåˆ¶ï¼Œä½¿ç”¨<a href="https://kevin-zhang-sysu.github.io/2024/09/14/vLLM/">vLLM</a>ä¸­æå‡ºçš„åŠ¨æ€å†…å­˜åˆ†é…æœºåˆ¶ä¸æ–­åœ°ä¸ºæ–°çš„KVcacheåˆ†é…æ–°çš„å†…å­˜ã€‚å½“GPUæ˜¾å­˜æ»¡è½½æ—¶ï¼Œä¼šå°†ä¸€éƒ¨åˆ†çš„è¯·æ±‚ï¼ˆè“è‰²çš„éƒ¨åˆ†ï¼‰ä»å†…å­˜ä¸­é©±é€ï¼Œé‡æ–°æ”¾å›è¯·æ±‚é˜Ÿåˆ—ã€‚</p></li></ul><h1 id="å­˜åœ¨çš„é—®é¢˜ä¸æŒ‘æˆ˜"><a href="#å­˜åœ¨çš„é—®é¢˜ä¸æŒ‘æˆ˜" class="headerlink" title="å­˜åœ¨çš„é—®é¢˜ä¸æŒ‘æˆ˜"></a>å­˜åœ¨çš„é—®é¢˜ä¸æŒ‘æˆ˜</h1><ul><li><p>ç”±äºæŠ¢å å¸¦æ¥çš„é¢å¤–å¼€é”€è¾ƒå¤§ï¼Œå¯¼è‡´P99å»¶è¿Ÿå¤§ï¼ŒæœåŠ¡çº§åˆ«ç›®æ ‡ï¼ˆSLOï¼‰éš¾ä»¥æ»¡è¶³ã€‚<br><img src="/posts_img/Llumnix/3.png"></p></li><li><p>è¯·æ±‚ä¹‹é—´çš„æ€§èƒ½å¹²æ‰°ã€‚<br><img src="/posts_img/Llumnix/4.png"><br>æ‰¹å¤„ç†çš„æ•°é‡è¶Šå¤šï¼Œæ¨¡å‹å‚æ•°é‡è¶Šå¤§ï¼Œå¹²æ‰°å°±è¶Šæ˜æ˜¾ã€‚</p></li><li><p>å†…å­˜ç¢ç‰‡ã€‚<br>è€ƒè™‘åˆ°å‰ä¸¤ä¸ªæŒ‘æˆ˜ï¼Œåº”è¯¥å°†è¯·æ±‚åˆ†æ•£åˆ°ä¸åŒçš„GPUï¼Œä½†è¿™æ ·å®¹æ˜“é€ æˆæ˜¾å­˜çš„å¤–éƒ¨ç¢ç‰‡åŒ–ã€‚å¯¼è‡´å¤–éƒ¨è¯·æ±‚ï¼ˆå°¤å…¶æ˜¯é•¿è¯·æ±‚ï¼‰çš„å»¶è¿Ÿå¾ˆé«˜ã€‚<br><img src="/posts_img/Llumnix/5.png"></p></li><li><p>æ»¡è¶³æ›´é«˜ä¼˜å…ˆçº§<br>ç°åœ¨çš„ç³»ç»Ÿä¸€èˆ¬éƒ½æ˜¯å¹³ç­‰å¯¹å¾…æ‰€æœ‰çš„è¯·æ±‚ï¼Œç¼ºä¹ä¼˜å…ˆçº§æ”¯æŒã€‚ï¼ˆè¿™é‡Œçš„å¹³ç­‰æ˜¯å¯¹æ¯ä¸ªè¯·æ±‚çš„ä¼˜å…ˆçº§éƒ½ä¸€è‡´ï¼Œå…³äºè¯·æ±‚å…¬å¹³æ€§æ–¹é¢çš„ç ”ç©¶å¯ä»¥å‚è€ƒFairnessLLMè¿™ç¯‡OSDI24çš„å·¥ä½œï¼‰</p></li></ul><h1 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h1><p>Llumnixé€šè¿‡è¿è¡Œæ—¶è·¨å¤šä¸ªæ¨¡å‹å®ä¾‹é‡æ–°è°ƒåº¦è¯·æ±‚æ¥åº”å¯¹ä¸Šè¿°æŒ‘æˆ˜ã€‚ç±»ä¼¼äºç°ä»£æ“ä½œç³»ç»Ÿä¸­çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œé€šè¿‡é«˜æ•ˆä¸”å¯æ‰©å±•çš„è¯·æ±‚å’Œå†…å­˜çŠ¶æ€å®æ—¶è¿ç§»æœºåˆ¶å®ç°é‡æ–°è°ƒåº¦ï¼Œä»¥æ”¹å–„è´Ÿè½½å‡è¡¡ã€å‡å°‘èµ„æºç¢ç‰‡åŒ–ã€åŒºåˆ†è¯·æ±‚ä¼˜å…ˆçº§å’ŒSLOï¼Œè¿˜èƒ½å®ç°å¼¹æ€§ä¼¸ç¼©(æ›´å¿«åœ°è€—å°½è¦ç»ˆæ­¢çš„å®ä¾‹æˆ–ä½¿æ–°å®ä¾‹é¥±å’Œ)ã€‚</p><p><img src="/posts_img/Llumnix/6.png"></p><h2 id="å®æ—¶è¿ç§»"><a href="#å®æ—¶è¿ç§»" class="headerlink" title="å®æ—¶è¿ç§»"></a>å®æ—¶è¿ç§»</h2><p><img src="/posts_img/Llumnix/7.png"></p><p>å¤šé˜¶æ®µè¿ç§»ï¼šå‡è®¾å¤åˆ¶ä¸€ä¸ªKVcacheæ˜¯0.5msï¼Œè®¡ç®—ä¸€ä¸ªKVcacheæ˜¯1msã€‚ç°åœ¨å·²ç»æœ‰äº†100ä¸ªKVcacheï¼Œä¸€è¾¹ç®—ä¸€è¾¹å¤åˆ¶è¿ç§»ï¼Œå½“æºå®ä¾‹è®¡ç®—åˆ°ç¬¬200ä¸ªKVcacheçš„æ—¶å€™ï¼Œç›®æ ‡å®ä¾‹ä¸Šä¹Ÿæœ‰199ä¸ªKVcacheäº†ã€‚ç„¶åè¦çœŸæ­£è¿›è¡Œåœç­‰çš„KVcacheå°±åªæœ‰ç¬¬200ä¸ªè¿™ä¸€ä¸ªäº†ï¼Œç­‰å¾…ç¬¬200ä¸ªè®¡ç®—å®Œæ¯•ï¼Œå¤åˆ¶è¿ç§»å³å¯ã€‚</p><p>ä¸ºäº†ä¿è¯è¿ç§»çš„å¯é æ€§ï¼ŒLlumnixè®¾è®¡äº†ä¸€å¥—handshakeæœºåˆ¶ã€‚</p><h2 id="åˆ†å¸ƒå¼è°ƒåº¦æ¶æ„"><a href="#åˆ†å¸ƒå¼è°ƒåº¦æ¶æ„" class="headerlink" title="åˆ†å¸ƒå¼è°ƒåº¦æ¶æ„"></a>åˆ†å¸ƒå¼è°ƒåº¦æ¶æ„</h2><p><img src="/posts_img/Llumnix/8.png"></p><p>Llumnixé‡‡ç”¨åˆ†å¸ƒå¼è°ƒåº¦æ¶æ„ï¼Œç»“åˆå…¨å±€è°ƒåº¦å™¨å’Œå®ä¾‹çº§è°ƒåº¦å™¨ï¼ˆllumletï¼‰ã€‚å…¨å±€è°ƒåº¦å™¨è´Ÿè´£æ ¹æ®å®ä¾‹è´Ÿè½½è¿›è¡Œæ–°è¯·æ±‚çš„åˆ†å‘ã€è§¦å‘è·¨å®ä¾‹è¿ç§»å’Œæ§åˆ¶è‡ªåŠ¨æ‰©ç¼©å®¹ï¼›llumletè´Ÿè´£æœ¬åœ°è°ƒåº¦ã€è¿ç§»åè°ƒå’Œæ‰§è¡Œã€‚è¿™ç§æ¶æ„é€šè¿‡åˆ†ç¦»å…³æ³¨ç‚¹ï¼Œæé«˜äº†è°ƒåº¦çš„å¯æ‰©å±•æ€§ã€‚</p><h2 id="åŠ¨æ€è°ƒåº¦ç­–ç•¥"><a href="#åŠ¨æ€è°ƒåº¦ç­–ç•¥" class="headerlink" title="åŠ¨æ€è°ƒåº¦ç­–ç•¥"></a>åŠ¨æ€è°ƒåº¦ç­–ç•¥</h2><p><img src="/posts_img/Llumnix/9.png"></p><p>å¼•å…¥â€œè™šæ‹Ÿä½¿ç”¨é‡â€æ¦‚å¿µï¼Œå°†ä¸åŒè°ƒåº¦ç›®æ ‡ï¼ˆå¦‚è´Ÿè½½å‡è¡¡ã€å»ç¢ç‰‡åŒ–ã€ä¼˜å…ˆçº§æ”¯æŒï¼‰ç»Ÿä¸€ä¸ºç®€å•çš„å®ä¾‹è´Ÿè½½åº¦é‡ã€‚è°ƒåº¦ç­–ç•¥åŸºäºè™šæ‹Ÿä½¿ç”¨é‡è¿›è¡Œå¯å‘å¼çš„è´Ÿè½½å‡è¡¡ï¼ŒåŒæ—¶é€šè¿‡è§„åˆ™è®¾ç½®ä¸åŒåœºæ™¯ä¸‹çš„è™šæ‹Ÿä½¿ç”¨é‡ï¼Œä¾‹å¦‚ä¸ºé«˜ä¼˜å…ˆçº§è¯·æ±‚åˆ†é…æ›´å¤šçš„è™šæ‹Ÿä½¿ç”¨é‡ï¼Œç¡®ä¿å…¶èƒ½å¤Ÿå¹³ç¨³æ— å¹²æ‰°åœ°è¿è¡Œã€‚</p><p>å¦‚æœéœ€è¦ç©ºå‡ºä¸€å°æœºå™¨æˆ–ä¸€ä¸ªæ¨¡å‹å®ä¾‹ï¼Œå¯ä»¥å°†å…¶è™šæ‹Ÿä½¿ç”¨é‡è®¾ç½®ä¸ºæœ€å¤§å€¼ã€‚è¿™æ ·ï¼Œè¯¥å®ä¾‹ä¸Šçš„ä»»åŠ¡ä¼šè¢«è°ƒåº¦åˆ°å…¶ä»–å®ä¾‹ä¸Šã€‚<br>è°ƒåº¦å†³ç­–åŸºäºå®ä¾‹çš„è‡ªç”±åº¦ï¼ˆFreenessï¼‰ï¼š</p><ul><li>è‡ªç”±åº¦è®¡ç®—å…¬å¼ï¼š<br><strong>F &#x3D; (M - âˆ‘V) &#x2F; B</strong><br>å…¶ä¸­ï¼š<ul><li>M &#x3D; æ€»å†…å­˜  </li><li>âˆ‘V &#x3D; å®ä¾‹ä¸Šæ‰€æœ‰è¯·æ±‚çš„è™šæ‹Ÿä½¿ç”¨é‡ä¹‹å’Œ  </li><li>B &#x3D; æ‰¹å¤§å°</li></ul></li></ul><p>è°ƒåº¦æ—¶ï¼Œä¼˜å…ˆå°†è¯·æ±‚åˆ†é…åˆ°è‡ªç”±åº¦æ›´é«˜çš„å®ä¾‹ä¸Šã€‚</p><h3 id="è¿ç§»ç­–ç•¥"><a href="#è¿ç§»ç­–ç•¥" class="headerlink" title="è¿ç§»ç­–ç•¥"></a>è¿ç§»ç­–ç•¥</h3><ul><li>å®šæœŸè§¦å‘è¿ç§»æ“ä½œï¼Œé€‰æ‹©è‡ªç”±åº¦æœ€ä½çš„å®ä¾‹ä½œä¸ºæºå®ä¾‹ï¼Œè‡ªç”±åº¦æœ€é«˜çš„å®ä¾‹ä½œä¸ºç›®æ ‡å®ä¾‹ã€‚</li><li>é€šè¿‡è¿ç§»è¯·æ±‚å®ç°è´Ÿè½½å‡è¡¡ã€‚</li></ul><h3 id="å¼¹æ€§ä¼¸ç¼©"><a href="#å¼¹æ€§ä¼¸ç¼©" class="headerlink" title="å¼¹æ€§ä¼¸ç¼©"></a>å¼¹æ€§ä¼¸ç¼©</h3><ul><li>å¦‚æœå®ä¾‹çš„è‡ªç”±åº¦æé«˜ï¼Œè€ƒè™‘å…³é—­è¯¥å®ä¾‹ä»¥èŠ‚çœèµ„æºã€‚</li><li>å¦‚æœå®ä¾‹çš„è‡ªç”±åº¦æä½ï¼Œè€ƒè™‘å¢åŠ ä¸€ä¸ªæ–°å®ä¾‹ä»¥åˆ†æ‹…è´Ÿè½½ã€‚</li></ul><h1 id="ç®—æ³•å®ç°"><a href="#ç®—æ³•å®ç°" class="headerlink" title="ç®—æ³•å®ç°"></a>ç®—æ³•å®ç°</h1><p>ç”¨3300è¡ŒPythonä»£ç å®ç°Llumnixï¼Œæ”¯æŒvLLMä½œä¸ºåç«¯ï¼Œåˆ©ç”¨Rayæ¡†æ¶å®ç°åˆ†å¸ƒå¼åè°ƒã€‚ä½¿ç”¨Glooè¿›è¡ŒKVcacheä¼ è¾“ï¼Œè€Œä¸æ˜¯NCCLï¼Œå› ä¸ºåè€…å¹¶å‘è°ƒç”¨ä¸å®‰å…¨ï¼Œå°†å¾ˆå¤šå°çš„KVcacheä»GPUå¤åˆ¶åˆ°CPUä¸­ï¼Œèåˆä¸ºä¸€ä¸ªå¤§çš„ï¼Œç»Ÿä¸€å‘é€åˆ°ç›®æ ‡å®ä¾‹ã€‚</p><h1 id="è¯„ä¼°"><a href="#è¯„ä¼°" class="headerlink" title="è¯„ä¼°"></a>è¯„ä¼°</h1><p>ä½œè€…åœ¨16-GPUé›†ç¾¤ä¸Šä½¿ç”¨çœŸå®ï¼ˆChatGPT-4 conversation datasets, ShareGPT (GPT4) and BurstGPT (GPT4-Conversation)ï¼‰å’Œåˆæˆå·¥ä½œè´Ÿè½½å¯¹Llumnixè¿›è¡Œäº†è¯„ä¼°ï¼Œå¯¹æ¯”åŸºçº¿åŒ…æ‹¬è½®è¯¢è°ƒåº¦ã€ä¼˜åŒ–ç‰ˆINFaaS++ç­‰ã€‚</p><p>ç»“æœè¡¨æ˜ï¼šLlumnixå°†å°¾å»¶è¿Ÿï¼ˆP99ï¼‰é™ä½äº†é«˜è¾¾15å€ï¼Œå°†é«˜ä¼˜å…ˆçº§è¯·æ±‚çš„å»¶è¿Ÿé™ä½äº†1.5å€ï¼Œå¹¶åœ¨ä¿æŒç±»ä¼¼å°¾å»¶è¿Ÿçš„æƒ…å†µä¸‹å®ç°äº†é«˜è¾¾36%çš„æˆæœ¬èŠ‚çº¦ã€‚</p><h1 id="æœªæ¥æ–¹å‘"><a href="#æœªæ¥æ–¹å‘" class="headerlink" title="æœªæ¥æ–¹å‘"></a>æœªæ¥æ–¹å‘</h1><ol><li>è¯·æ±‚åœ¨å¼‚æ„å®ä¾‹ä¹‹é—´çš„è°ƒåº¦ï¼ˆä¸åŒçš„TP, PPç­‰ï¼‰ã€‚</li><li>å®ä¾‹å†…è°ƒåº¦æŠ€æœ¯ï¼ˆå¦‚æŠ¢å å¼è°ƒåº¦ï¼‰ä¼˜åŒ–ï¼Œè®¾è®¡early rejecté¿å…èµ„æºçš„æµªè´¹ç­‰ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> Paper Report </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLM </tag>
            
            <tag> Inference </tag>
            
            <tag> OSDI 2024 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sia-è€ƒè™‘é›†ç¾¤å¼‚æ„æ€§å’Œä½œä¸šå¼¹æ€§çš„DLè®­ç»ƒç³»ç»Ÿ</title>
      <link href="/2025/01/16/Sia/"/>
      <url>/2025/01/16/Sia/</url>
      
        <content type="html"><![CDATA[<p>Sia è°ƒåº¦å™¨ç»“åˆ<strong>Gavel</strong>å’Œ<strong>Pollux</strong>è¿™ä¸¤ç¯‡æ–‡ç« çš„ä¼˜åŠ¿ï¼Œæå‡ºäº†ä¸€ç§ä¸º<strong>å¼‚æ„</strong>æ·±åº¦å­¦ä¹ é›†ç¾¤çš„<strong>å¼¹æ€§</strong>èµ„æºè‡ªé€‚åº”ä½œä¸šæä¾›é«˜æ•ˆèµ„æºåˆ†é…çš„æ–¹æ³•ï¼Œè§£å†³äº†ç°æœ‰è°ƒåº¦å™¨åœ¨å¼‚æ„æ€§å’Œèµ„æºé€‚åº”æ€§ä¸Šçš„ä¸è¶³ã€‚Sia ä½¿ç”¨<strong>Bootstrapping + åœ¨çº¿ä¼˜åŒ–</strong>çš„æ–¹æ³•ï¼Œä½å¼€é”€ã€å¿«é€Ÿè¯„ä¼°ä½œä¸šåœ¨ä¸åŒé…ç½®ä¸‹çš„æ€§èƒ½ï¼Œæ¥ç€ä½¿ç”¨<strong>ILPç®—æ³•</strong>è¿›è¡Œèµ„æºåˆ†é…ï¼Œèƒ½å¤Ÿåœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­é«˜æ•ˆæ‰©å±•ï¼Œå¹¶æ ¹æ®é›†ç¾¤è´Ÿè½½å’Œä½œä¸šéœ€æ±‚åŠ¨æ€è°ƒæ•´ã€‚Sia æ˜¯é¦–ä¸ªæ”¯æŒæ··åˆå¹¶è¡Œä½œä¸šå¼¹æ€§æ‰©å±•çš„é›†ç¾¤è°ƒåº¦å™¨ã€‚å¹¿æ³›çš„å®éªŒè¡¨æ˜ï¼ŒSia åœ¨å¤šä¸ªå·¥ä½œè´Ÿè½½ç¯å¢ƒä¸­æ˜¾è‘—æé«˜äº†ä½œä¸šå®Œæˆæ•ˆç‡å’Œèµ„æºåˆ©ç”¨ç‡ï¼Œå¹¶ä¸”å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§å’Œå…¬å¹³æ€§ï¼Œèƒ½å¤Ÿæ”¯æŒé«˜è¾¾ 2000 GPU çš„é›†ç¾¤ã€‚</p><p>è®ºæ–‡ï¼š(SOSP 2023)<a href="https://suhasjs.github.io/files/sia-sosp23.pdf">Sia: Heterogeneity-aware, goodput-optimized ML-cluster scheduling</a></p><p>ä»£ç ï¼š<a href="https://github.com/siasosp23/artifacts">https://github.com/siasosp23/artifacts</a></p><h1 id="ç ”ç©¶èƒŒæ™¯åŠå†…å®¹"><a href="#ç ”ç©¶èƒŒæ™¯åŠå†…å®¹" class="headerlink" title="ç ”ç©¶èƒŒæ™¯åŠå†…å®¹"></a>ç ”ç©¶èƒŒæ™¯åŠå†…å®¹</h1><p>æ·±åº¦å­¦ä¹ æ¨¡å‹çš„è®­ç»ƒå’Œæ¨ç†ï¼Œå¯¹è®¡ç®—èµ„æºçš„è¦æ±‚æä¸ºåºå¤§ï¼Œå¯¹äºæ™®é€šä¼ä¸šå’Œç”¨æˆ·è€Œè¨€éƒ¨ç½²çš„æˆæœ¬å·¨å¤§ï¼ŒåŸºäºæ­¤èƒŒæ™¯ï¼Œå„å¤§ä¼ä¸šçš„æ·±åº¦å­¦ä¹ äº‘è®¡ç®—å¹³å°åº”è¿è€Œç”Ÿã€‚</p><p><img src="/posts_img/Sia/1.png"></p><p>ç”¨æˆ·ä¼šå°†æ·±åº¦å­¦ä¹ æ¨¡å‹éƒ¨ç½²åˆ°äº‘ç«¯ï¼Œè¿›è¡Œè®­ç»ƒæˆ–æ¨ç†ä½œä¸šï¼Œé€šå¸¸ä¼šè¯·æ±‚ä¸€å®šçš„è®¡ç®—èµ„æºï¼Œä»¥ä¿è¯è‡ªå·±å¯¹ä»»åŠ¡åœ¨æ—¶é—´å’Œç²¾åº¦ä¸Šçš„çš„éœ€æ±‚ã€‚é›†ç¾¤è°ƒåº¦å™¨å†³å®šå¦‚ä½•å°†èµ„æºåˆ†é…ç»™ä»»åŠ¡ï¼Œä»¥å®ç°å…¬å¹³è°ƒåº¦ã€æœ€å°åŒ–ä»»åŠ¡å®Œæˆæ—¶é—´(JCT)ã€æé«˜é›†ç¾¤åˆ©ç”¨ç‡ç­‰ç›®æ ‡ã€‚</p><p><img src="/posts_img/Sia/2.png"></p><p>ç°æœ‰çš„è°ƒåº¦å™¨åœ¨ä¼˜åŒ–èµ„æºåˆ†é…ã€å‡å°‘ä½œä¸šå®Œæˆæ—¶é—´ (JCT) ä»¥åŠæé«˜ GPU åˆ©ç”¨ç‡æ–¹é¢å­˜åœ¨å±€é™æ€§ï¼š</p><p><img src="/posts_img/Sia/3.png"></p><p>åœ¨Siaè¿™ç¯‡è®ºæ–‡ä¸­ï¼Œä½œè€…è€ƒè™‘çš„åœºæ™¯æ˜¯DLä»»åŠ¡çš„è®­ç»ƒè°ƒåº¦ï¼Œçš„ä¼˜åŒ–ç›®æ ‡æ˜¯æœ€å°åŒ–ä½œä¸šçš„JCTã€‚è¿‡å»æœ‰å¾ˆå¤šå·¥ä½œè€ƒè™‘å¼¹æ€§è°ƒåº¦æˆ–è€…GPUèµ„æºçš„å¼‚æ„ï¼Œä½†æ˜¯æ²¡æœ‰ç»¼åˆä¸¤è€…è¿›è¡Œè€ƒè™‘ï¼Œå…¶ä¸­è€ƒè™‘èµ„æºå¼‚æ„çš„SOTAæ˜¯Gavelï¼Œè€ƒè™‘å¼¹æ€§è°ƒåº¦çš„SOTAæ˜¯Polluxã€‚ä½œè€…æå‡º Sia è°ƒåº¦å™¨ï¼Œç»“åˆå¼‚æ„æ€§ä¸å¼¹æ€§ï¼Œåœ¨å®é™…åœºæ™¯ä¸­ä¼˜åŒ–é›†ç¾¤èµ„æºè°ƒåº¦ã€‚</p><h1 id="ç ”ç©¶æ–¹æ³•åŠè¿‡ç¨‹"><a href="#ç ”ç©¶æ–¹æ³•åŠè¿‡ç¨‹" class="headerlink" title="ç ”ç©¶æ–¹æ³•åŠè¿‡ç¨‹"></a>ç ”ç©¶æ–¹æ³•åŠè¿‡ç¨‹</h1><p>Siaç‰¹ç‚¹ï¼š</p><ol><li><p>Siaæ˜¯ä¸€ä¸ªåŸºäºæŠ¢å å¼ã€è½®è¯¢çš„è°ƒåº¦å™¨ã€‚</p></li><li><p>ä½¿ç”¨ä½å¼€é”€çš„æ–¹æ³•æ¥å¼•å¯¼ï¼ˆbootstrapï¼‰æ¯ä¸ªæ–°ä½œä¸šçš„ååé‡æ¨¡å‹ï¼Œè¿™äº›æ¨¡å‹ç”¨äºè¯„ä¼°å¯èƒ½çš„èµ„æºåˆ†é…ã€‚</p></li><li><p>é€šè¿‡å¼•å…¥ä¸€ç§æ–°çš„è°ƒåº¦å…¬å¼æ¥è§£å†³å¤§è§„æ¨¡æœç´¢ç©ºé—´çš„é—®é¢˜ï¼Œå°†ä½œä¸šåŠå…¶é…ç½®ä¸ GPU ç±»å‹å’Œæ•°é‡åŒ¹é…ï¼ŒåŒæ—¶é€‚åº”é›†ç¾¤è´Ÿè½½å’Œä½œä¸šç»„åˆçš„å˜åŒ–ã€‚</p></li></ol><p><img src="/posts_img/Sia/4.png" alt="**Sia ä¸­ä½œä¸šçš„ç”Ÿå‘½å‘¨æœŸ**"></p><p>ä½œä¸šæäº¤åï¼Œå®ƒä¼šåœ¨æ¯ç§ GPU ç±»å‹ä¸Šå¯¹å‡ ä¸ªæ‰¹æ¬¡å¤§å°è¿›è¡Œä¸€æ¬¡profilingåˆ†æã€‚è·å¾—èµ„æºåˆ†é…åï¼Œä½œä¸šå¼€å§‹è¿›å…¥ä¸€ä¸ªæŒç»­ä¼˜åŒ–çš„å‘¨æœŸï¼ˆæ­¥éª¤ 5-8ï¼‰ï¼ŒæŒç»­è¿›è¡Œç›´åˆ°å®ƒåœ¨é›†ç¾¤ä¸­çš„ç”Ÿå‘½å‘¨æœŸç»“æŸã€‚<strong>Policy</strong> ç”¨äº ILP é—®é¢˜æ±‚è§£ï¼Œä¼šä¸æ–­ä¼˜åŒ–ä½œä¸šçš„åˆ†é…ï¼›<strong>Adaptive Executors</strong> æ”¯æŒåŠ¨æ€è°ƒæ•´ä½œä¸šè¿è¡Œé…ç½®ï¼Œå¦‚batch sizeï¼› <strong>Goodput Estimator</strong> æä¾›æœ€æ–°çš„æ€§èƒ½å’Œæ¢¯åº¦ç»Ÿè®¡æ•°æ®ï¼Œä»¥å¸®åŠ©å†³ç­–ã€‚</p><p>ä½œä¸šåœ¨æäº¤åè¿›è¡Œå¿«é€Ÿåˆå§‹é…ç½®å»ºæ¨¡ï¼Œå¹¶å‘¨æœŸæ€§åœ°é‡æ–°åˆ†é…èµ„æºä»¥å®ç°åŠ¨æ€ä¼˜åŒ–ã€‚</p><p>æˆ‘è®¤ä¸ºï¼ŒSiaè¿™ç¯‡æ–‡ç« ä¸»è¦å›ç­”äº†ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ã€‚</p><h2 id="Q1-å¼‚æ„é›†ç¾¤ä¸­ï¼Œä½œä¸šçš„æ€§èƒ½å› -GPU-ç±»å‹å’Œæ•°é‡å˜åŒ–è€Œå¼‚ï¼Œå¦‚ä½•é«˜æ•ˆå»ºæ¨¡ï¼Ÿ"><a href="#Q1-å¼‚æ„é›†ç¾¤ä¸­ï¼Œä½œä¸šçš„æ€§èƒ½å› -GPU-ç±»å‹å’Œæ•°é‡å˜åŒ–è€Œå¼‚ï¼Œå¦‚ä½•é«˜æ•ˆå»ºæ¨¡ï¼Ÿ" class="headerlink" title="Q1. å¼‚æ„é›†ç¾¤ä¸­ï¼Œä½œä¸šçš„æ€§èƒ½å›  GPU ç±»å‹å’Œæ•°é‡å˜åŒ–è€Œå¼‚ï¼Œå¦‚ä½•é«˜æ•ˆå»ºæ¨¡ï¼Ÿ"></a>Q1. å¼‚æ„é›†ç¾¤ä¸­ï¼Œä½œä¸šçš„æ€§èƒ½å›  GPU ç±»å‹å’Œæ•°é‡å˜åŒ–è€Œå¼‚ï¼Œå¦‚ä½•é«˜æ•ˆå»ºæ¨¡ï¼Ÿ</h2><p>ç­”ï¼šå¼•å…¥Goodput Estimatoræ¨¡å—ï¼Œä½¿ç”¨<strong>Bootstrapping + åœ¨çº¿ä¼˜åŒ–</strong>çš„æ–¹æ³•é«˜æ•ˆå»ºæ¨¡ã€‚</p><p><img src="/posts_img/Sia/5.png"></p><ul><li>åˆå§‹profilingå»ºæ¨¡æ—¶æœ€å¤§é™åº¦å‡å°‘å¼€é”€ã€‚</li><li>å¯å‘å¼æ¨æ–­æœªè¿è¡Œ GPU ç±»å‹çš„å¤š GPU é…ç½®æ€§èƒ½ã€‚</li><li>åœ¨çº¿å­¦ä¹ é€æ­¥ç²¾ç¡®ååé‡æ¨¡å‹ã€‚</li></ul><h2 id="Q2-ä½œä¸šçš„åŠ¨æ€å¼¹æ€§æ‰©å±•ï¼ˆGPU-æ•°é‡ï¼‰å¸¦æ¥å·¨å¤§æœç´¢ç©ºé—´ï¼Œå¦‚ä½•é™ä½è°ƒåº¦å¼€é”€ï¼Ÿ"><a href="#Q2-ä½œä¸šçš„åŠ¨æ€å¼¹æ€§æ‰©å±•ï¼ˆGPU-æ•°é‡ï¼‰å¸¦æ¥å·¨å¤§æœç´¢ç©ºé—´ï¼Œå¦‚ä½•é™ä½è°ƒåº¦å¼€é”€ï¼Ÿ" class="headerlink" title="Q2. ä½œä¸šçš„åŠ¨æ€å¼¹æ€§æ‰©å±•ï¼ˆGPU æ•°é‡ï¼‰å¸¦æ¥å·¨å¤§æœç´¢ç©ºé—´ï¼Œå¦‚ä½•é™ä½è°ƒåº¦å¼€é”€ï¼Ÿ"></a>Q2. ä½œä¸šçš„åŠ¨æ€å¼¹æ€§æ‰©å±•ï¼ˆGPU æ•°é‡ï¼‰å¸¦æ¥å·¨å¤§æœç´¢ç©ºé—´ï¼Œå¦‚ä½•é™ä½è°ƒåº¦å¼€é”€ï¼Ÿ</h2><p>ç­”ï¼šåœ¨Policyç®—æ³•ä¸­æ„é€ é…ç½®é›†åˆï¼Œå‡å°æœç´¢ç©ºé—´ã€‚</p><p><img src="/posts_img/Sia/6.png"></p><p>Sia å°†é…ç½®é›†åˆ ğ¶ åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ul><li>å•èŠ‚ç‚¹é…ç½®ï¼ˆSingle-node setï¼‰: åŒ…å«æ‰€æœ‰åœ¨å•ä¸ªèŠ‚ç‚¹ä¸Šçš„èµ„æºåˆ†é…ã€‚çº¦æŸä¸º GPU æ•°é‡å¿…é¡»æ˜¯ 2 çš„å¹‚ï¼Œä¸”æœ€å¤šä¸è¶…è¿‡æ¯èŠ‚ç‚¹çš„ GPU æ•°é‡ ğ‘…ã€‚å¦‚æœ ğ‘… ä¸æ˜¯ 2 çš„å¹‚ï¼Œå¯ä»¥å°†èŠ‚ç‚¹è§†ä¸ºå¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹ã€‚</li><li>å¤šèŠ‚ç‚¹é…ç½®ï¼ˆMulti-node setï¼‰: åŒ…å«è·¨å¤šä¸ªèŠ‚ç‚¹çš„èµ„æºåˆ†é…ã€‚çº¦æŸä¸º GPU æ•°é‡å¿…é¡»æ˜¯æ¯èŠ‚ç‚¹ GPU æ•°é‡ ğ‘… çš„æ•´æ•°å€ï¼ˆç¡®ä¿ä½¿ç”¨å®Œæ•´èŠ‚ç‚¹ï¼‰ã€‚</li></ul><p>Sia åˆ©ç”¨å­ç½‘å½¢çŠ¶è¦†ç›–å®šç†ï¼ˆ<a href="/2024/09/19/Alpa/" title="Alpa-è‡ªåŠ¨ç”ŸæˆDL&#x2F;LLMæ¨¡å‹å¹¶è¡Œç­–ç•¥">Alpa-è‡ªåŠ¨ç”ŸæˆDL&#x2F;LLMæ¨¡å‹å¹¶è¡Œç­–ç•¥</a>è¿™ç¯‡æ–‡ç« è¯æ˜çš„ï¼‰ï¼Œç¡®ä¿æ‰€æœ‰é…ç½®çš„èµ„æºåˆ†é…æ˜¯æœ‰æ•ˆçš„ï¼ŒåŒæ—¶é¿å…å¤šä¸ªä½œä¸šå…±äº«èŠ‚ç‚¹ï¼Œå‡å°‘ç½‘ç»œæ¥å£ï¼ˆNICï¼‰çš„èµ„æºäº‰ç”¨ã€‚</p><p>ä¸ Pollux çš„å¯¹æ¯”</p><ul><li><strong>Pollux</strong>: åœ¨èµ„æºåˆ†é…ä¸­ä¼˜åŒ–æ•´ä¸ªæœç´¢ç©ºé—´ï¼ˆå³ GPU æ•°é‡ Ã— GPU æ”¾ç½®ç»„åˆï¼‰ï¼Œå…¶å¤æ‚åº¦ä¸º O(N^R)ï¼Œå…¶ä¸­ N æ˜¯èŠ‚ç‚¹æ•°ï¼ŒR æ˜¯æ¯èŠ‚ç‚¹ GPU æ•°é‡ã€‚</li><li><strong>Sia</strong>: é™åˆ¶é…ç½®é›†åˆå¤§å°ï¼Œå•èŠ‚ç‚¹é…ç½®æ•°é‡ä¸º logâ‚‚ Rï¼Œå¤šèŠ‚ç‚¹é…ç½®æ•°é‡ä¸º Nï¼Œå› æ­¤æ€»ä½“å¤æ‚åº¦ä¸º N + logâ‚‚ Rã€‚é€šè¿‡é™åˆ¶æœç´¢ç©ºé—´ï¼Œæ˜¾è‘—å‡å°‘äº†é—®é¢˜å¤æ‚åº¦ï¼ŒåŒæ—¶æ€§èƒ½ä¸ Pollux ç›¸å½“ã€‚</li></ul><h2 id="Q3-å¦‚ä½•è®¾è®¡è°ƒåº¦ç®—æ³•æé«˜é›†ç¾¤æ•ˆç‡ï¼ˆä½œä¸šå®Œæˆæ—¶é—´ï¼‰ï¼Ÿ"><a href="#Q3-å¦‚ä½•è®¾è®¡è°ƒåº¦ç®—æ³•æé«˜é›†ç¾¤æ•ˆç‡ï¼ˆä½œä¸šå®Œæˆæ—¶é—´ï¼‰ï¼Ÿ" class="headerlink" title="Q3. å¦‚ä½•è®¾è®¡è°ƒåº¦ç®—æ³•æé«˜é›†ç¾¤æ•ˆç‡ï¼ˆä½œä¸šå®Œæˆæ—¶é—´ï¼‰ï¼Ÿ"></a>Q3. å¦‚ä½•è®¾è®¡è°ƒåº¦ç®—æ³•æé«˜é›†ç¾¤æ•ˆç‡ï¼ˆä½œä¸šå®Œæˆæ—¶é—´ï¼‰ï¼Ÿ</h2><p>ç­”ï¼š<strong>æœ‰æ•ˆååé‡è¯„ä¼° + æ•´æ•°çº¿æ€§è§„åˆ’</strong>ã€‚</p><p>Sia ä½¿ç”¨ goodput æ¥è¡¡é‡ä½œä¸šåœ¨ç‰¹å®šé…ç½®ä¸‹çš„æ•ˆç‡ï¼Œä½¿å¾—ä½œä¸šåœ¨ä¸åŒ GPU ç±»å‹å’Œæ•°é‡ä¸Šçš„æ•ˆèƒ½å…·æœ‰å¯æ¯”æ€§ã€‚</p><p><img src="/posts_img/Sia/7.png"></p><p>Goodputæ ¹æ®ååé‡å’Œç»Ÿè®¡æ•ˆç‡å¾—åˆ°ï¼Œç”¨æ¥è¡¡é‡ä½œä¸šæ¯ç§’çš„è¿›åº¦ã€‚å®šä¹‰è¯¦è§Polluxè¿™ç¯‡æ–‡ç« ã€‚</p><h3 id="Goodput-çŸ©é˜µ-G"><a href="#Goodput-çŸ©é˜µ-G" class="headerlink" title="Goodput çŸ©é˜µ G"></a>Goodput çŸ©é˜µ G</h3><p>åŸºäºæœ€å° goodput å€¼å½’ä¸€åŒ– Goodput çŸ©é˜µï¼šè¡Œå†…å€¼å¯ç›´æ¥æ¯”è¾ƒï¼Œåæ˜ æ¯ä¸ªä½œä¸šåœ¨ä¸åŒé…ç½®ä¸‹çš„æ•ˆç”¨ã€‚åˆ—é—´å€¼ä¹Ÿå¯æ¯”è¾ƒï¼Œç”¨äºè¯„ä¼°é…ç½®å¯¹ä¸åŒä½œä¸šçš„ä¼˜å…ˆçº§ã€‚</p><p><img src="/posts_img/Sia/8.png"></p><p>Sia ä¸ºæ¯ä¸ªä½œä¸šçš„æ¯ç§é…ç½®è®¡ç®—å‡ºç›¸åº”çš„ goodput ï¼Œå¹¶é€šè¿‡å½’ä¸€åŒ–çš„æ–¹å¼ä½¿å¾—å…¶æ—¢èƒ½æ ¹æ®ç»™å®šä½œä¸šé€‰æ‹©æœ€é€‚åˆçš„é…ç½®ï¼Œåˆèƒ½æ ¹æ®ç»™å®šé…ç½®é€‰æ‹©æœ€é€‚åˆçš„ä½œä¸šã€‚</p><p>Sia ä¼šä¸€ç›´ç»´æŠ¤è¿™ä¸ªçŸ©é˜µï¼Œå½“æ–°çš„ä½œä¸šåˆ°æ¥æ—¶ï¼Œä¼šåœ¨çŸ©é˜µä¸­æ·»åŠ æ–°çš„ä¸€è¡Œã€‚æ—§çš„ä½œä¸šå®Œæˆæ—¶ï¼Œä¼šåˆ é™¤å…¶ç›¸åº”çš„è¡Œã€‚ä½¿å¾— goodput çŸ©é˜µä¸€ç›´ä¿æŒåœ¨æœ€æ–°çŠ¶æ€ï¼Œä»…é€‚ç”¨äºæ´»åŠ¨ä¸­çš„ä½œä¸šã€‚</p><h3 id="æ•´æ•°çº¿æ€§è§„åˆ’ï¼ˆILPï¼‰"><a href="#æ•´æ•°çº¿æ€§è§„åˆ’ï¼ˆILPï¼‰" class="headerlink" title="æ•´æ•°çº¿æ€§è§„åˆ’ï¼ˆILPï¼‰"></a>æ•´æ•°çº¿æ€§è§„åˆ’ï¼ˆILPï¼‰</h3><p><img src="/posts_img/Sia/9.png"></p><ul><li><strong>åŠ¨æ€æ€§</strong>: çŸ©é˜µ G å®æ—¶æ›´æ–°ï¼Œéšç€ä½œä¸šçš„ç»Ÿè®¡æ•ˆç‡å˜åŒ–æˆ–æ¨¡å‹æ”¹è¿›ä¸æ–­ä¼˜åŒ–åˆ†é…å†³ç­–ã€‚</li><li><strong>èµ„æºé«˜æ•ˆåˆ©ç”¨</strong>: ä¼˜åŒ–ç›®æ ‡ç»“åˆ goodput å’Œä½œä¸šç­‰å¾…æƒ©ç½šï¼Œç¡®ä¿èµ„æºé«˜æ•ˆåˆ†é…ã€‚</li><li><strong>æ‰©å±•æ€§</strong>: ä½¿ç”¨ ILP æ±‚è§£ï¼Œèƒ½å¤Ÿå¿«é€Ÿè®¡ç®—å¤§è§„æ¨¡é›†ç¾¤çš„ä¼˜åŒ–åˆ†é…æ–¹æ¡ˆã€‚</li></ul><p>åŸºäºè¿™ä¸ªILPï¼Œè®ºæ–‡ä¸­è¿˜æåˆ°äº†è®¸å¤šä¼˜åŒ–æ–¹æ¡ˆï¼š</p><ul><li>é‡å¯å› å­ (Restart Factor)</li><li>å…¬å¹³æ€§è°ƒèŠ‚ (Balancing Goodput and Fairness)</li><li>æ··åˆå¹¶è¡Œè®­ç»ƒ (Hybrid-parallel training)</li><li>æŠ¢å å’Œé¢„ç•™æœºåˆ¶ (Preemption and reservation)</li><li>å…¶ä»–éGPUå·¥ä½œè´Ÿè½½çš„è°ƒåº¦ (Other types of workloads)</li><li>â€¦</li></ul><h1 id="å®éªŒä¸åˆ†æ"><a href="#å®éªŒä¸åˆ†æ" class="headerlink" title="å®éªŒä¸åˆ†æ"></a>å®éªŒä¸åˆ†æ</h1><h2 id="è°ƒåº¦ä¸­çš„è‡ªé€‚åº”è¡¨ç°"><a href="#è°ƒåº¦ä¸­çš„è‡ªé€‚åº”è¡¨ç°" class="headerlink" title="è°ƒåº¦ä¸­çš„è‡ªé€‚åº”è¡¨ç°"></a>è°ƒåº¦ä¸­çš„è‡ªé€‚åº”è¡¨ç°</h2><p><img src="/posts_img/Sia/10.png"></p><ul><li>Siaå…·æœ‰è‰¯å¥½çš„è‡ªé€‚åº”æ€§ï¼Œèƒ½å¤ŸåŠ¨æ€è°ƒæ•´åˆ†é…ç»™æ¯ä¸ªä½œä¸šçš„GPUæ•°é‡å’Œç±»å‹ã€‚</li><li>Bootstrappingç¡®å®èƒ½å¤Ÿå¿«é€Ÿåœ°ä¸ºä½œä¸šåŒ¹é…GPUç±»å‹ã€‚</li></ul><p>çŸ©å½¢ä¹‹é—´çš„ç©ºæ ¼æ˜¯Siaè°ƒåº¦çš„å»¶è¿Ÿ</p><h2 id="è°ƒåº¦æ€§èƒ½å®éªŒ"><a href="#è°ƒåº¦æ€§èƒ½å®éªŒ" class="headerlink" title="è°ƒåº¦æ€§èƒ½å®éªŒ"></a>è°ƒåº¦æ€§èƒ½å®éªŒ</h2><h3 id="å®éªŒè®¾ç½®"><a href="#å®éªŒè®¾ç½®" class="headerlink" title="å®éªŒè®¾ç½®"></a>å®éªŒè®¾ç½®</h3><h4 id="é›†ç¾¤é…ç½®"><a href="#é›†ç¾¤é…ç½®" class="headerlink" title="é›†ç¾¤é…ç½®"></a>é›†ç¾¤é…ç½®</h4><ul><li>å¼‚æ„ GPU é›†ç¾¤ï¼ŒåŒ…æ‹¬ T4ã€V100 å’Œ A100 ç­‰ä¸åŒ GPU ç±»å‹ã€‚</li><li>é›†ç¾¤è§„æ¨¡ä»å‡ åä¸ªåˆ°ä¸Šåƒä¸ª GPU èŠ‚ç‚¹ã€‚</li></ul><h4 id="å·¥ä½œè´Ÿè½½"><a href="#å·¥ä½œè´Ÿè½½" class="headerlink" title="å·¥ä½œè´Ÿè½½"></a>å·¥ä½œè´Ÿè½½</h4><p>ä½¿ç”¨çœŸå®ç”Ÿäº§é›†ç¾¤å·¥ä½œè´Ÿè½½ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li><strong>Philly</strong>ï¼šå¾®è½¯ GPU é›†ç¾¤çš„æ·±åº¦å­¦ä¹ å·¥ä½œè´Ÿè½½ã€‚</li><li><strong>Helios</strong>ï¼šåŸºäºå¤§è§„æ¨¡é«˜è´Ÿè½½ç¯å¢ƒçš„ä»¿çœŸå·¥ä½œè´Ÿè½½ã€‚</li><li><strong>newTrace</strong>ï¼šå®é™…æ·±åº¦å­¦ä¹ è®­ç»ƒä»»åŠ¡çš„åŠ¨æ€å·¥ä½œè´Ÿè½½ã€‚</li></ul><h4 id="å¯¹æ¯”è°ƒåº¦å™¨"><a href="#å¯¹æ¯”è°ƒåº¦å™¨" class="headerlink" title="å¯¹æ¯”è°ƒåº¦å™¨"></a>å¯¹æ¯”è°ƒåº¦å™¨</h4><ul><li><strong>Pollux</strong>ï¼šä¸“æ³¨äºä½œä¸šå¼¹æ€§æ‰©å±•çš„è°ƒåº¦å™¨ã€‚</li><li><strong>Gavel</strong>ï¼šä¼˜åŒ–å¼‚æ„èµ„æºåˆ†é…çš„è°ƒåº¦å™¨ã€‚</li></ul><p><img src="/posts_img/Sia/11.png"></p><p><strong>å¹³å‡ JCT æ”¹å–„</strong></p><ul><li>åœ¨ Philly æ•°æ®é›†ä¸­ï¼Œå¹³å‡ JCT æ¯” Pollux å’Œ Gavel åˆ†åˆ«å‡å°‘ 30%-93%ã€‚</li><li>åœ¨ Helios æ•°æ®é›†ä¸­ï¼Œ99 åˆ†ä½æ•° JCT å‡å°‘äº† 50%-80%ã€‚</li></ul><p><img src="/posts_img/Sia/12.png"></p><p><strong>GPU å°æ—¶æ•°èŠ‚çœ</strong></p><ul><li>åœ¨ Helios å·¥ä½œè´Ÿè½½ä¸­ï¼ŒGPU å°æ—¶æ•°å‡å°‘ 12%-60%ã€‚</li></ul><h2 id="ç®—æ³•æ•ˆç‡å®éªŒ"><a href="#ç®—æ³•æ•ˆç‡å®éªŒ" class="headerlink" title="ç®—æ³•æ•ˆç‡å®éªŒ"></a>ç®—æ³•æ•ˆç‡å®éªŒ</h2><p><img src="/posts_img/Sia/13.png"></p><p>Siaå…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ï¼ŒPolluxçš„é—ä¼ ç®—æ³•è¿è¡Œé€Ÿåº¦æ˜æ˜¾è¾ƒæ…¢ï¼ˆæ¯”Siaçš„ILPå…¬å¼æ…¢100å€ï¼‰ï¼ŒGavelè¦å¿«å¾—å¤šï¼Œå› ä¸ºå®ƒæ²¡æœ‰è€ƒè™‘å·¥ä½œé€‚åº”ã€‚</p><h1 id="æ€»ç»“ä¸å±•æœ›"><a href="#æ€»ç»“ä¸å±•æœ›" class="headerlink" title="æ€»ç»“ä¸å±•æœ›"></a>æ€»ç»“ä¸å±•æœ›</h1><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li><p><strong>è”åˆä¼˜åŒ–å¼‚æ„æ€§ä¸ä½œä¸šå¼¹æ€§</strong></p><p>æ”¯æŒå¼¹æ€§æ‰©å±•å’Œå¼‚æ„ GPU æ··åˆè°ƒåº¦ã€‚</p></li><li><p><strong>åŠ¨æ€ååé‡å»ºæ¨¡</strong></p><p>å¼•å…¥è½»é‡çº§çš„åœ¨çº¿å­¦ä¹ æœºåˆ¶ï¼Œé€šè¿‡å°‘é‡é…ç½®æ ·æœ¬å¿«é€Ÿé¢„æµ‹ä½œä¸šæ€§èƒ½ã€‚å¿«é€Ÿé€‚åº”ä½œä¸šéœ€æ±‚å’Œèµ„æºéœ€æ±‚ï¼Œæœ‰æ•ˆæ”¯æŒå¼‚æ„ GPU ç±»å‹å’ŒåŠ¨æ€è´Ÿè½½ã€‚</p></li><li><p><strong>é«˜æ•ˆé›†ç¾¤ã€æ‰©å±•æ€§ä¸é€‚é…æ€§</strong></p><p>æ”¯æŒå¤§è§„æ¨¡é›†ç¾¤ï¼ˆä¸Šåƒ GPUï¼‰çš„é«˜æ•ˆè°ƒåº¦ï¼Œæ”¯æŒå¤šç§ä»»åŠ¡ç±»å‹ï¼Œä»»åŠ¡å¹¶è¡Œæ–¹å¼ã€å¹³è¡¡å…¬å¹³æ€§ä¸æ•ˆç‡ã€‚</p></li></ol><h2 id="å±•æœ›"><a href="#å±•æœ›" class="headerlink" title="å±•æœ›"></a>å±•æœ›</h2><ol><li>æ”¯æŒæ›´å¤æ‚çš„æ··åˆå¹¶è¡Œä»»åŠ¡è°ƒåº¦ï¼ˆå¦‚æµæ°´çº¿å¹¶è¡Œä¸æ•°æ®å¹¶è¡Œç»“åˆï¼‰ã€‚</li><li>åœ¨è¶…å¤§è§„æ¨¡é›†ç¾¤ï¼ˆ2000+ GPUï¼‰ä¸­è¿›ä¸€æ­¥éªŒè¯æ€§èƒ½ã€‚</li><li>ä¼˜åŒ–å¯¹å…¶ä»–ç±»å‹å·¥ä½œè´Ÿè½½ï¼ˆå¦‚å®æ—¶æ¨ç†ä»»åŠ¡ï¼‰çš„æ”¯æŒã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> Paper Report </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DL </tag>
            
            <tag> Train </tag>
            
            <tag> SOSP 2023 </tag>
            
            <tag> Mlsys </tag>
            
            <tag> Heterogeneity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Alpa-è‡ªåŠ¨ç”ŸæˆDL/LLMæ¨¡å‹å¹¶è¡Œç­–ç•¥</title>
      <link href="/2024/09/19/Alpa/"/>
      <url>/2024/09/19/Alpa/</url>
      
        <content type="html"><![CDATA[<p>åªè¦è¾“å…¥DLæ¨¡å‹ computation graph å’Œ device clusterï¼ŒAlpa é€šè¿‡ç”Ÿæˆç»Ÿä¸€<strong>æ•°æ®</strong>ã€<strong>è¿ç®—</strong>å’Œ<strong>æµæ°´çº¿</strong>å¹¶è¡Œæ€§çš„æ‰§è¡Œè®¡åˆ’ï¼Œåœ¨<strong>å¯æ¥å—</strong>çš„æ—¶é—´å†…<strong>è‡ªåŠ¨åŒ–</strong>äº†å¤§å‹æ·±åº¦å­¦ä¹ ï¼ˆDLï¼‰æ¨¡å‹çš„æ¨¡å‹å¹¶è¡Œè®­ç»ƒã€‚</p><p>ç°æœ‰çš„æ¨¡å‹å¹¶è¡Œè®­ç»ƒç³»ç»Ÿè¦ä¹ˆè¦æ±‚ç”¨æˆ·æ‰‹åŠ¨åˆ›å»ºå¹¶è¡ŒåŒ–è®¡åˆ’ï¼Œè¦ä¹ˆä»æœ‰é™çš„æ¨¡å‹å¹¶è¡Œé…ç½®ç©ºé—´ä¸­è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªã€‚å®ƒä»¬ä¸è¶³ä»¥åœ¨åˆ†å¸ƒå¼è®¡ç®—è®¾å¤‡ä¸Šæ‰©å±•å¤æ‚çš„DLæ¨¡å‹ã€‚Alpaé€šè¿‡å°†å¹¶è¡Œæ€§è§†ä¸ºä¸¤ä¸ªå±‚æ¬¡æ¥åˆ†é…å¤§å‹DLæ¨¡å‹çš„è®­ç»ƒï¼š**è¿ç®—å†…å¹¶è¡Œæ€§(inter-operator)<strong>å’Œ</strong>è¿ç®—é—´å¹¶è¡Œæ€§(intra-operator)**ã€‚</p><p>åŸºäºæ­¤ï¼ŒAlpaä¸ºå¤§è§„æ¨¡æ¨¡å‹å¹¶è¡Œæ‰§è¡Œè®¡åˆ’æ„å»ºäº†ä¸€ä¸ªæ–°çš„å±‚æ¬¡ç©ºé—´ã€‚Alpaè®¾è®¡äº†è®¸å¤šç¼–è¯‘è¿‡ç¨‹ï¼Œä»¥åœ¨æ¯ä¸ªå¹¶è¡Œçº§åˆ«è‡ªåŠ¨å¯¼å‡ºé«˜æ•ˆçš„å¹¶è¡Œæ‰§è¡Œè®¡åˆ’ã€‚Alpaå®ç°äº†é«˜æ•ˆçš„è¿è¡Œæ—¶ï¼Œä»¥åè°ƒåˆ†å¸ƒå¼è®¡ç®—è®¾å¤‡ä¸Šçš„ä¸¤çº§å¹¶è¡Œæ‰§è¡Œã€‚è¯„ä¼°è¡¨æ˜ï¼ŒAlpaç”Ÿæˆçš„å¹¶è¡ŒåŒ–è®¡åˆ’ä¸æ‰‹åŠ¨è°ƒä¼˜çš„æ¨¡å‹å¹¶è¡Œè®­ç»ƒç³»ç»Ÿç›¸åŒ¹é…æˆ–ä¼˜äºåè€…ï¼Œå³ä½¿åœ¨å®ƒä»¬è®¾è®¡çš„æ¨¡å‹ä¸Šä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä¸ä¸“ç”¨ç³»ç»Ÿä¸åŒï¼ŒAlpaè¿˜å¯ä»¥æ¨å¹¿åˆ°å…·æœ‰å¼‚æ„æ¶æ„çš„æ¨¡å‹å’Œæ²¡æœ‰æ‰‹åŠ¨è®¾è®¡è®¡åˆ’çš„æ¨¡å‹ã€‚</p><p>è®ºæ–‡ï¼š(OSDI 2022)<a href="https://www.usenix.org/system/files/osdi23-li-zhuohan.pdf">Alpa: Automating Inter- and Intra-Operator Parallelism for Distributed Deep Learning</a></p><p>æºä»£ç ï¼š<a href="https://github.com/alpa-projects/alpa">https://github.com/alpa-projects/alpa</a>.</p><p>æ–‡ç« å‚è€ƒè‡ªï¼š</p><ol><li><a href="https://zhuanlan.zhihu.com/p/487588274">https://zhuanlan.zhihu.com/p/487588274</a></li><li><a href="https://research.google/blog/alpa-automated-model-parallel-deep-learning/">https://research.google/blog/alpa-automated-model-parallel-deep-learning/</a></li></ol><h1 id="Alpaæ¦‚å¿µ"><a href="#Alpaæ¦‚å¿µ" class="headerlink" title="Alpaæ¦‚å¿µ"></a>Alpaæ¦‚å¿µ</h1><p>ä½œè€…é¦–å…ˆå°†ç°æœ‰çš„æœºå™¨å­¦ä¹ å¹¶è¡ŒåŒ–ç­–ç•¥åˆ†ä¸ºä¸¤ç±»ï¼š</p><ol><li>è¿ç®—å†…å¹¶è¡Œ-Intra-Operator Parallelismï¼šå°†TensoræŒ‰æŸäº›ç»´åº¦åˆ‡è£‚ï¼Œæ”¾åˆ°ä¸åŒDeviceä¸Šè®¡ç®—çš„å¹¶è¡Œæ–¹å¼ã€‚å¦‚å¼ é‡å¹¶è¡Œï¼ˆå¦‚Megatron-LMï¼‰ã€æ•°æ®å¹¶è¡Œï¼ˆå¦‚Deepspeed Zeroï¼‰ã€ä¸“å®¶å¹¶è¡Œï¼ˆå¦‚GShard MoEï¼‰ã€‚</li><li>è¿ç®—é—´å¹¶è¡Œ-Inter-Operator Parallelismï¼šå³æµæ°´çº¿å¹¶è¡Œ</li></ol><p>ä¸¤ç±»å¹¶è¡Œæ–¹å¼çš„ç‰¹ç‚¹ï¼š</p><ol><li>Intra-op Parallelismï¼šé€šè®¯é‡è¾ƒå¤§ï¼Œå¯å……åˆ†åˆ©ç”¨å¸¦å®½ï¼Œåˆ‡åˆ†å¸¦æ¥çš„é€šä¿¡åŸºæœ¬å±äºé«˜æ•ˆçš„é›†åˆé€šä¿¡ã€‚</li><li>Inter-op Parallelismï¼šåªåœ¨ä¸¤ä¸ªè®¾å¤‡é—´ä¼ è¾“æ•°æ®ï¼Œé€šè®¯é‡è¾ƒå°ï¼Œè‹¥åˆ‡ç‚¹å¯»æ‰¾çš„åˆé€‚ï¼Œåˆ™é€šä¿¡è¾ƒå°ï¼Œä½†åŒæ­¥ç‰ˆæœ¬çš„ç­–ç•¥æ— å¯é¿å…çš„ä¼šå¼•æ¥Bubbleã€‚</li></ol><p>å¯ä»¥åˆ©ç”¨clusterçš„éå¯¹ç§°ç‰¹æ€§ï¼Œå°†Intra-op Parallelismæ˜ å°„åˆ°é«˜å¸¦å®½äº’è”çš„devicesä¸Šï¼›å°†Inter-op Parallelismæ˜ å°„åˆ°ä½å¸¦å®½äº’è”çš„devicesä¸Šã€‚å¦‚æ­¤ç»„åˆï¼Œå°±èƒ½é‡Šæ”¾æ›´å¤§çš„ç®—åŠ›ã€‚Alpaä¼šè‡ªåŠ¨æ¢ç´¢è¿™äº›ç­–ç•¥åŠç»„åˆæƒ…å†µã€‚</p><p>åœ¨GPUé›†ç¾¤ä¸­ï¼ŒèŠ‚ç‚¹å†…çš„GPUå…·æœ‰æ›´é«˜çš„é€šä¿¡å¸¦å®½ï¼Œå¯ä»¥é€‚åº”è¿ç®—å†…çš„å¹¶è¡Œæ€§ã€‚ç„¶è€Œï¼Œä¸åŒèŠ‚ç‚¹ä¸Šçš„GPUé€šå¸¸ä»¥è¾ƒä½çš„å¸¦å®½è¿æ¥ï¼ˆä¾‹å¦‚ä»¥å¤ªç½‘ï¼‰ï¼Œå› æ­¤é¦–é€‰è¿ç®—é—´å¹¶è¡Œã€‚</p><p>ä¹‹æ‰€ä»¥è¦åšè¿™ä¸¤ç§åŒºåˆ†ï¼Œç›®çš„æ˜¯ä¸ºäº†åœ¨ä¸åŒçš„levelä¸Šåšç­–ç•¥æœç´¢ï¼Œç„¶åå°†äºŒè€…ç»„åˆèµ·æ¥ï¼Œç”Ÿæˆå¤§ä¸€ç»Ÿçš„å¹¶è¡Œæ–¹å¼çš„æ‰§è¡Œè®¡åˆ’ã€‚æ€»ç»“èµ·æ¥å°±æ˜¯ä»¥ä¸‹ä¸¤ä¸ªç‚¹ï¼š</p><p>å°†å¹¶è¡Œåº¦è§†ä¸ºä¸¤çº§ï¼šintra-operatorå’Œinter-operatorï¼Œæ„å»ºåˆ†çº§çš„è§£ç©ºé—´<br>åœ¨ä¸¤çº§ç©ºé—´ä¸­<strong>åˆ†åˆ«</strong>æ¢ç´¢æœ€ä¼˜è§£ï¼Œç„¶åæä¾›é«˜æ•ˆçš„Runtimeå°†äºŒè€…ç¼–æ’èµ·æ¥ï¼ˆæ€»ä½“ä¸Šä¸èƒ½ä¿è¯å…¨å±€æœ€ä¼˜ï¼Œä½†æ˜¯å®è·µè¯æ˜åœ¨å¤§æ¨¡å‹ä¸Šæœ‰å¾ˆå¼ºçš„æ€§èƒ½æå‡ï¼‰ã€‚</p><h1 id="Alpaçš„Workflow"><a href="#Alpaçš„Workflow" class="headerlink" title="Alpaçš„Workflow"></a>Alpaçš„Workflow</h1><p>Alpaå·¥ä½œåœ¨DLç¼–è¯‘å±‚ï¼ˆåŸºäºXLAï¼Œåœ¨HLOä¸Šè¿›è¡Œç­–ç•¥æ¢ç´¢ï¼‰ï¼Œæ‰€ä»¥æ–‡ä¸­ä¹Ÿç§°ä¹‹ä¸ºâ€”â€”è‡ªåŠ¨ç”Ÿæˆåˆ†å¸ƒå¼ç­–ç•¥çš„DLç¼–è¯‘å™¨ã€‚å½“ç”¨æˆ·ç»™å‡ºæ¨¡å‹è®¡ç®—å›¾å’Œè®¾å¤‡é›†ç¾¤æ—¶ï¼Œå®ƒä¼šè¿›è¡Œå„ç§æ“ä½œæµã€‚</p><ol><li>è¿ç®—é—´å¹¶è¡Œæ“ä½œæµ-Intra-Operator Passï¼šä¼ é€’å°†è®¡ç®—å›¾åˆ‡åˆ†ä¸ºå­å›¾ï¼Œå°†è®¾å¤‡é›†ç¾¤åˆ‡ç‰‡ä¸ºå­è¡¨ï¼ˆå³åˆ†åŒºè®¾å¤‡é›†ç¾¤ï¼‰ï¼Œå¹¶ç¡®å®šå°†å­å›¾ä¸å­è¡¨çš„æœ€ä½³é…å¯¹æ–¹å¼ã€‚</li><li>è¿ç®—å†…å¹¶è¡Œæ“ä½œæµ-Inter-Operator Passï¼šä¸ºè¿ç®—é—´å¹¶è¡Œçš„æ¯ä¸ªæµæ°´çº¿é˜¶æ®µæ‰¾åˆ°æœ€ä½³çš„è¿ç®—å†…å¹¶è¡Œè®¡åˆ’ã€‚</li><li>è¿è¡Œæ—¶ç¼–æ’æ“ä½œæµ-Runtime Orchestration passï¼šç”Ÿæˆä¸€ä¸ªé™æ€è®¡åˆ’ï¼Œå¯¹è®¡ç®—å’Œé€šä¿¡è¿›è¡Œæ’åºï¼Œå¹¶åœ¨å®é™…è®¾å¤‡é›†ç¾¤ä¸Šæ‰§è¡Œåˆ†å¸ƒå¼è®¡ç®—å›¾ï¼ˆåšruntimeç¼åˆçš„äº‹æƒ…ã€‚æ¯”å¦‚stageè°ƒåº¦ï¼Œé€šä¿¡ä¼˜åŒ–ç­‰ï¼Œæ˜¾ç„¶è¿™ä¸ªpasså’Œç­–ç•¥æœç´¢æ²¡ä»€ä¹ˆå…³ç³»ï¼‰ã€‚</li></ol><p>åœ¨å®è§‚ä¸ŠåšDPï¼Œå¾®è§‚ä¸ŠILPï¼ŒInter-opå’ŒIntra-opä¸¤ä¸ªpassä¸æ–­è¿­ä»£æœ€ç»ˆè·å¾—æœ€ä½³æ–¹æ¡ˆã€‚</p><p>ä¸‹å›¾ä¸­ï¼Œåœ¨åˆ‡ç‰‡å­å›¾ä¸­ï¼Œçº¢è‰²å’Œè“è‰²è¡¨ç¤ºè¿ç®—çš„åˆ’åˆ†æ–¹å¼ï¼Œç°è‰²è¡¨ç¤ºå¤åˆ¶çš„è¿ç®—ï¼Œç»¿è‰²ä»£è¡¨å®é™…è®¾å¤‡ï¼ˆä¾‹å¦‚GPUï¼‰ï¼š</p><p><img src="/posts_img/Alpa/1.gif" alt="Alpaæ¦‚è¿°ã€‚åœ¨åˆ‡ç‰‡å­å›¾ä¸­ï¼Œçº¢è‰²å’Œè“è‰²è¡¨ç¤ºè¿ç®—çš„åˆ’åˆ†æ–¹å¼ï¼Œç°è‰²è¡¨ç¤ºå¤åˆ¶çš„è¿ç®—ï¼Œç»¿è‰²ä»£è¡¨å®é™…è®¾å¤‡ï¼ˆä¾‹å¦‚GPUï¼‰ã€‚"></p><h2 id="è¿ç®—å†…å¹¶è¡Œæ“ä½œæµï¼ˆIntra-Operator-Passï¼‰"><a href="#è¿ç®—å†…å¹¶è¡Œæ“ä½œæµï¼ˆIntra-Operator-Passï¼‰" class="headerlink" title="è¿ç®—å†…å¹¶è¡Œæ“ä½œæµï¼ˆIntra-Operator Passï¼‰"></a>è¿ç®—å†…å¹¶è¡Œæ“ä½œæµï¼ˆIntra-Operator Passï¼‰</h2><p>ä¸ä¹‹å‰çš„ç ”ç©¶ï¼ˆä¾‹å¦‚Mesh TensorFlowå’ŒGSPMDï¼‰ç±»ä¼¼ï¼Œè¿ç®—å†…å¹¶è¡Œæ€§åœ¨è®¾å¤‡ç½‘æ ¼ä¸Šåˆ’åˆ†å¼ é‡ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†Transformeræ¨¡å‹ä¸­å…·æœ‰ç»™å®šæ‰¹æ¬¡ã€åºåˆ—å’Œéšè—ç»´åº¦çš„å…¸å‹3Då¼ é‡ã€‚æ‰¹å¤„ç†ç»´åº¦æ²¿ç€è®¾å¤‡ç½‘æ ¼ç»´åº¦0ï¼ˆmesh0ï¼‰è¿›è¡Œåˆ’åˆ†ï¼Œéšè—ç»´åº¦æ²¿ç€ç½‘æ ¼ç»´åº¦1ï¼ˆmesh1ï¼‰è¿›è¡Œåˆ†åŒºï¼Œåºåˆ—ç»´åº¦è¢«å¤åˆ¶åˆ°æ¯ä¸ªå¤„ç†å™¨ã€‚</p><p>åœ¨2Dè®¾å¤‡ç½‘æ ¼ä¸Šåˆ’åˆ†çš„3Då¼ é‡ï¼š<br><img src="/posts_img/Alpa/2.png" alt="åœ¨2Dè®¾å¤‡ç½‘æ ¼ä¸Šåˆ’åˆ†çš„3Då¼ é‡"></p><p>é€šè¿‡Alpaä¸­å¼ é‡çš„åˆ’åˆ†ï¼Œè¿›ä¸€æ­¥ä¸ºè®¡ç®—å›¾ä¸­çš„æ¯ä¸ªç‹¬ç«‹è¿ç®—å®šä¹‰äº†ä¸€ç»„å¹¶è¡ŒåŒ–ç­–ç•¥ã€‚åœ¨ä¸‹å›¾ä¸­å±•ç¤ºäº†çŸ©é˜µä¹˜æ³•çš„å¹¶è¡ŒåŒ–ç­–ç•¥ç¤ºä¾‹ã€‚åœ¨è¿ç®—ç¬¦ä¸Šå®šä¹‰å¹¶è¡ŒåŒ–ç­–ç•¥å¯èƒ½ä¼šå¯¼è‡´å¼ é‡åˆ†åŒºä¸Šçš„å†²çªï¼Œå› ä¸ºä¸€ä¸ªå¼ é‡æ—¢å¯ä»¥æ˜¯ä¸€ä¸ªè¿ç®—ç¬¦çš„è¾“å‡ºï¼Œä¹Ÿå¯ä»¥æ˜¯å¦ä¸€ä¸ªè¿ç®—çš„è¾“å…¥ã€‚è‹¥åˆ†åŒºæ–¹å¼ä¸åŒ¹é…ï¼Œä¸¤ä¸ªè¿ç®—ä¹‹é—´éœ€è¦é‡æ–°åˆ†åŒºï¼Œè¿™ä¼šäº§ç”Ÿé¢å¤–çš„é€šä¿¡æˆæœ¬ã€‚</p><p>çŸ©é˜µä¹˜æ³•çš„å¹¶è¡ŒåŒ–ç­–ç•¥ï¼š<br><img src="/posts_img/Alpa/3.png" alt="çŸ©é˜µä¹˜æ³•çš„å¹¶è¡ŒåŒ–ç­–ç•¥"></p><p>ç»™å®šæ¯ä¸ªè¿ç®—å’Œre-partitionæˆæœ¬ï¼Œä½œè€…å°†è¿ç®—å†…æ“ä½œæµè¡¨ç¤ºä¸ºæ•´æ•°çº¿æ€§è§„åˆ’ï¼ˆILPï¼‰é—®é¢˜ã€‚å¯¹äºæ¯ä¸ªè¿ç®—ï¼Œå®šä¹‰ä¸€ä¸ªone-hotå‘é‡æ¥æšä¸¾åˆ†åŒºç­–ç•¥ã€‚ILPçš„ç›®æ ‡æ˜¯æœ€å°åŒ–è®¡ç®—å’Œé€šä¿¡æˆæœ¬ï¼ˆèŠ‚ç‚¹æˆæœ¬ï¼‰å’Œé‡æ–°åˆ’åˆ†é€šä¿¡æˆæœ¬ï¼ˆè¾¹æˆæœ¬ï¼‰çš„æ€»å’Œã€‚ILPçš„è§£å†³æ–¹æ¡ˆè½¬åŒ–ä¸ºä¸€ç§ç‰¹å®šçš„æ–¹æ³•æ¥åˆ†å‰²åŸå§‹è®¡ç®—å›¾ã€‚</p><p><img src="/posts_img/Alpa/4.png"></p><h2 id="è¿ç®—é—´å¹¶è¡Œæ“ä½œæµï¼ˆInter-Operator-Passï¼‰"><a href="#è¿ç®—é—´å¹¶è¡Œæ“ä½œæµï¼ˆInter-Operator-Passï¼‰" class="headerlink" title="è¿ç®—é—´å¹¶è¡Œæ“ä½œæµï¼ˆInter-Operator Passï¼‰"></a>è¿ç®—é—´å¹¶è¡Œæ“ä½œæµï¼ˆInter-Operator Passï¼‰</h2><p>è¿ç®—é—´ä¼ é€’å¯¹è®¡ç®—å›¾å’Œè®¾å¤‡é›†ç¾¤è¿›è¡Œåˆ‡ç‰‡ï¼Œä»¥å®ç°æµæ°´çº¿å¹¶è¡Œæ€§ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ–¹æ¡†è¡¨ç¤ºè¾“å…¥çš„å¾®æ‰¹ï¼Œæµæ°´çº¿é˜¶æ®µè¡¨ç¤ºæ‰§è¡Œå­å›¾çš„å­ç½‘æ ¼ã€‚æ°´å¹³ç»´åº¦è¡¨ç¤ºæ—¶é—´ï¼Œå¹¶æ˜¾ç¤ºæ‰§è¡Œå¾®æ‰¹å¤„ç†çš„ä¼ é€’é˜¶æ®µã€‚è¿ç®—é—´ä¼ é€’çš„ç›®æ ‡æ˜¯æœ€å¤§é™åº¦åœ°å‡å°‘æ€»æ‰§è¡Œå»¶è¿Ÿï¼Œå³è®¾å¤‡ä¸Šæ•´ä¸ªå·¥ä½œè´Ÿè½½æ‰§è¡Œçš„æ€»å’Œã€‚Alpaä½¿ç”¨åŠ¨æ€è§„åˆ’ï¼ˆDPï¼‰ç®—æ³•æ¥æœ€å°åŒ–æ€»å»¶è¿Ÿã€‚è®¡ç®—å›¾é¦–å…ˆè¢«å±•å¹³ï¼Œç„¶åæ‰§è¡ŒIntra-Operator Passï¼Œå¯¹è®¾å¤‡é›†ç¾¤åˆ°å­è¡¨çš„æ‰€æœ‰å¯èƒ½åˆ†åŒºçš„æ€§èƒ½è¿›è¡Œåˆ†æã€‚</p><p>å¯¹äºç»™å®šçš„æ—¶é—´ï¼Œæ­¤å›¾æ˜¾ç¤ºäº†åˆ†åŒºè®¾å¤‡é›†ç¾¤å’Œè®¡ç®—å›¾åˆ‡ç‰‡ï¼ˆä¾‹å¦‚ï¼Œé˜¶æ®µ1ã€2ã€3ï¼‰æ­£åœ¨å¤„ç†çš„å¾®æ‰¹ï¼ˆå½©è‰²æ¡†ï¼‰ï¼š<br><img src="/posts_img/Alpa/6.png" alt="æµæ°´çº¿å¹¶è¡Œã€‚å¯¹äºç»™å®šçš„æ—¶é—´ï¼Œæ­¤å›¾æ˜¾ç¤ºäº†åˆ†åŒºè®¾å¤‡é›†ç¾¤å’Œè®¡ç®—å›¾åˆ‡ç‰‡ï¼ˆä¾‹å¦‚ï¼Œé˜¶æ®µ1ã€2ã€3ï¼‰æ­£åœ¨å¤„ç†çš„å¾®æ‰¹ï¼ˆå½©è‰²æ¡†ï¼‰ã€‚"></p><h1 id="è¯„ä¼°"><a href="#è¯„ä¼°" class="headerlink" title="è¯„ä¼°"></a>è¯„ä¼°</h1><p>ä½¿ç”¨8ä¸ªAWS p3.16xlargeå®ä¾‹æµ‹è¯•Alpaï¼Œæ¯ä¸ªå®ä¾‹æœ‰8ä¸ª16GB V100 GPUï¼Œæ€»å…±64ä¸ªGPUã€‚ç ”ç©¶äº†åœ¨å¢åŠ GPUæ•°é‡çš„åŒæ—¶å¢åŠ æ¨¡å‹å¤§å°çš„å¼±ç¼©æ”¾ç»“æœã€‚æˆ‘ä»¬è¯„ä¼°äº†ä¸‰ç§æ¨¡å‹ï¼š</p><ol><li>æ ‡å‡†Transformeræ¨¡å‹ï¼ˆGPTï¼‰ï¼›</li><li>GShard MoEæ¨¡å‹ï¼Œä¸€ç§æ··åˆäº†ä¸“å®¶å±‚çš„Transformerï¼›</li><li>Wide ResNetï¼Œä¸€ä¸ªæ˜æ˜¾ä¸åŒçš„æ¨¡å‹ï¼Œæ²¡æœ‰ç°æœ‰çš„ä¸“å®¶è®¾è®¡çš„æ¨¡å‹å¹¶è¡ŒåŒ–ç­–ç•¥ã€‚æ€§èƒ½æ˜¯é€šè¿‡é›†ç¾¤ä¸Šæ¯ç§’å®ç°çš„petaæµ®ç‚¹è¿ç®—ï¼ˆPFLOPSï¼‰æ¥è¡¡é‡çš„ã€‚</li></ol><p>ä½œè€…è¯æ˜ï¼Œå¯¹äºGPTï¼ŒAlpaè¾“å‡ºçš„å¹¶è¡ŒåŒ–ç­–ç•¥ä¸ç°æœ‰æœ€ä½³æ¡†æ¶Megatron MLè®¡ç®—çš„ç­–ç•¥éå¸¸ç›¸ä¼¼ï¼Œå¹¶ä¸å…¶æ€§èƒ½ç›¸åŒ¹é…ã€‚å¯¹äºGShard MoEæ¥è¯´ï¼ŒAlpaåœ¨GPUï¼ˆå³Deepspeedï¼‰ä¸Šçš„è¡¨ç°æ¯”ä¸“å®¶è®¾è®¡çš„æœ€ä½³åŸºçº¿é«˜å‡º8å€ã€‚Wide ResNetçš„ç»“æœè¡¨æ˜ï¼ŒAlpaå¯ä»¥ä¸ºä¸“å®¶å°šæœªç ”ç©¶çš„æ¨¡å‹ç”Ÿæˆæœ€ä½³å¹¶è¡ŒåŒ–ç­–ç•¥ã€‚æœ¬æ–‡è¿˜å±•ç¤ºäº†çº¿æ€§ç¼©æ”¾æ•°ä»¥ä¾›å‚è€ƒã€‚</p><p><img src="/posts_img/Alpa/7.png"></p><p>åœ¨16ä¸ªGPUä¸Šï¼ŒAlpaå°†æ¨¡å‹åˆ†ä¸º3ä¸ªé˜¶æ®µï¼Œå¹¶åˆ†åˆ«ä¸ºç¬¬1ã€2ã€3é˜¶æ®µåˆ†é…4ã€4ã€8ä¸ªGPUã€‚åœ¨å‰ä¸¤ä¸ªé˜¶æ®µï¼Œæ•°æ®å¹¶è¡Œæ€§æ˜¯é¦–é€‰ï¼Œå› ä¸ºæ¿€æ´»å¼ é‡å¤§äºæƒé‡å¼ é‡ã€‚åœ¨ç¬¬ä¸‰é˜¶æ®µï¼ŒILPæ±‚è§£å™¨æ‰¾åˆ°äº†ä¸€ç§åˆ’åˆ†å·ç§¯ç®—å­çš„éå¹³å‡¡æ–¹æ³•ã€‚ç»“æœè¡¨æ˜ï¼Œå¯¹äºåƒWide ResNetè¿™æ ·çš„å¼‚æ„æ¨¡å‹ï¼Œå³ä½¿å¯¹äºé¢†åŸŸä¸“å®¶æ¥è¯´ï¼Œæ‰‹åŠ¨åˆ›å»ºè¿™æ ·çš„ç­–ç•¥ä¹Ÿå¯èƒ½æ˜¯å›°éš¾çš„ã€‚</p><p>Alpaåœ¨16ä¸ªGPUä¸Šä¸ºWideResNetæ‰¾åˆ°çš„å¹¶è¡ŒåŒ–ç­–ç•¥ï¼š<br><img src="/posts_img/Alpa/8.png" alt="Alpaåœ¨16ä¸ªGPUä¸Šä¸ºWideResNetæ‰¾åˆ°çš„å¹¶è¡ŒåŒ–ç­–ç•¥"></p><h1 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h1><p>ä¸ºåˆ†å¸ƒå¼æ¨¡å‹å¹¶è¡Œæ·±åº¦å­¦ä¹ è®¾è®¡æœ‰æ•ˆçš„å¹¶è¡ŒåŒ–è®¡åˆ’çš„è¿‡ç¨‹å†æ¥æ˜¯ä¸€é¡¹å›°éš¾ä¸”åŠ³åŠ¨å¯†é›†å‹çš„ä»»åŠ¡ã€‚Alpaæ˜¯ä¸€ä¸ªæ–°çš„æ¡†æ¶ï¼Œå®ƒåˆ©ç”¨è¿ç®—å†…å’Œè¿ç®—é—´çš„å¹¶è¡Œæ€§è¿›è¡Œè‡ªåŠ¨åŒ–æ¨¡å‹å¹¶è¡Œåˆ†å¸ƒå¼è®­ç»ƒã€‚ç›¸ä¿¡Alpaå°†ä½¿åˆ†å¸ƒå¼æ¨¡å‹å¹¶è¡Œå­¦ä¹ è§„èŒƒåŒ–ï¼Œå¹¶åŠ é€Ÿå¤§å‹æ·±åº¦å­¦ä¹ æ¨¡å‹çš„å¼€å‘ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Paper Report </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OSDI 2022 </tag>
            
            <tag> LLM </tag>
            
            <tag> DL </tag>
            
            <tag> Train </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vLLM-é«˜æ•ˆç®¡ç†å†…å­˜çš„LLMæ¨ç†ç³»ç»Ÿ</title>
      <link href="/2024/09/14/vLLM/"/>
      <url>/2024/09/14/vLLM/</url>
      
        <content type="html"><![CDATA[<p>LLMåœ¨å¤„ç†å¤§é‡è¯·æ±‚æ—¶é¢ä¸´å†…å­˜ä½¿ç”¨æ•ˆç‡ä½ä¸‹çš„é—®é¢˜ï¼Œæ¯ä¸ªè¯·æ±‚éœ€å ç”¨å¤§é‡åŠ¨æ€å˜åŒ–çš„å†…å­˜ï¼Œå¯¼è‡´æµªè´¹å¹¶é™åˆ¶å¤„ç†èƒ½åŠ›ã€‚æœ¬æ–‡æå‡ºäº†PagedAttentionç®—æ³•ï¼Œå—æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜åˆ†é¡µæŠ€æœ¯å¯å‘ï¼Œå¼€å‘äº†vLLMæœåŠ¡ç³»ç»Ÿã€‚vLLMé€šè¿‡çµæ´»å…±äº«å†…å­˜ï¼Œå®ç°å‡ ä¹é›¶å†…å­˜æµªè´¹ï¼Œæ˜¾è‘—é™ä½äº†å†…å­˜éœ€æ±‚ã€‚æµ‹è¯•è¡¨æ˜ï¼ŒvLLMå¤„ç†ååé‡æ¯”FasterTransformerå’ŒOrcaæé«˜2åˆ°4å€ï¼Œä¸”å»¶è¿Ÿä¿æŒç›¸åŒï¼Œå°¤å…¶åœ¨å¤„ç†é•¿æ–‡æœ¬ã€å¤§æ¨¡å‹å’Œå¤æ‚è§£ç æ—¶è¡¨ç°çªå‡ºã€‚</p><p>è®ºæ–‡ï¼š(SOSP 2023)<img src="https://dl.acm.org/doi/pdf/10.1145/3600006.3613165" alt="Efficient Memory Management for Large Language Model Serving with PagedAttention"><br>ä»£ç ï¼š<a href="https://github.com/vllm-project/vllm">https://github.com/vllm-project/vllm</a><br>æ–‡ç« å‚è€ƒè‡ªï¼š<a href="https://mp.weixin.qq.com/s/whsGK2gfVrIDNXTtxUUSOw">https://mp.weixin.qq.com/s/whsGK2gfVrIDNXTtxUUSOw</a></p><h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>è®¸å¤šäº‘æœåŠ¡å…¬å¸æ­£åœ¨äº‰ç›¸æä¾›LLMåº”ç”¨ï¼Œä½†è¿è¡Œè¿™äº›åº”ç”¨çš„æˆæœ¬éå¸¸é«˜ï¼Œéœ€è¦å¤§é‡çš„ç¡¬ä»¶åŠ é€Ÿå™¨å¦‚GPUã€‚æ®ä¼°è®¡ï¼Œå¤„ç†ä¸€æ¬¡å¤§è¯­è¨€æ¨¡å‹çš„è¯·æ±‚ï¼Œæˆæœ¬æ˜¯ä¼ ç»Ÿå…³é”®è¯æŸ¥è¯¢çš„ <strong>10</strong> å€ã€‚ç”±äºæˆæœ¬å¦‚æ­¤ä¹‹é«˜ï¼Œæå‡å¤§è¯­è¨€æ¨¡å‹çš„å¤„ç†æ•ˆç‡ï¼Œä»è€Œé™ä½æ¯æ¬¡è¯·æ±‚çš„è´¹ç”¨ï¼Œå˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚</p><p>å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªè‡ªå›å½’çš„Transformeræ¨¡å‹ã€‚è¿™ä¸ªæ¨¡å‹æ ¹æ®è¾“å…¥çš„æç¤ºå’Œä¹‹å‰ç”Ÿæˆçš„è¯ï¼ˆæ ‡è®°ï¼‰ï¼Œä¸€ä¸ªä¸€ä¸ªåœ°ç”Ÿæˆæ–°çš„è¯ã€‚æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦é‡å¤è¿™ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œç›´åˆ°æ¨¡å‹è¾“å‡ºä¸€ä¸ªç»ˆæ­¢æ ‡è®°ã€‚è¿™ç§é€å­—ç”Ÿæˆçš„è¿‡ç¨‹éœ€è¦å¤§é‡å†…å­˜ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨GPUçš„è®¡ç®—èƒ½åŠ›ï¼Œé™åˆ¶äº†å¤„ç†è¯·æ±‚çš„æ•ˆç‡ã€‚ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå¯ä»¥å°†å¤šä¸ªè¯·æ±‚æ‰¹é‡å¤„ç†ã€‚ä½†è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œéœ€è¦æœ‰æ•ˆç®¡ç†æ¯ä¸ªè¯·æ±‚çš„å†…å­˜ç©ºé—´ã€‚</p><p><img src="/posts_img/vLLM/1.png"></p><p><strong>å†…å­˜éœ€æ±‚è®¡ç®—å…¬å¼</strong></p><ul><li><p>æ¨¡å‹å‚æ•°</p><p>13Bå‚æ•° ~ 13G ä¸ªå‚æ•° * Â 4ä¸ªå­—èŠ‚ï¼ˆFP 32ï¼‰ æˆ–è€… 2ä¸ªbytes ï¼ˆFP16ï¼Œç”Ÿäº§ç¯å¢ƒä¸€èˆ¬ç”¨FP16ï¼‰</p></li><li><p>KV Cache</p><p>2 (key and value vectors) * hidden_size Â * layer_num * Â head_num * batch_size * seq_len * å‚æ•°ç²¾åº¦ï¼ˆ4&#x2F;2å­—èŠ‚ï¼‰</p></li></ul><p>å¯¹äºæ›´å¤§çš„æ¨¡å‹ï¼Œå’Œæ›´é•¿çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼ŒKV Cacheçš„å­˜å‚¨éœ€æ±‚ä¼šæ˜¾è‘—å¢åŠ ã€‚ç”±äºæ¨¡å‹çš„å‚æ•°æ˜¯å›ºå®šçš„ï¼Œè€Œæ¿€æ´»å ç”¨çš„å†…å­˜å¾ˆå°‘ï¼ŒKVç¼“å­˜çš„ç®¡ç†æ–¹å¼å†³å®šäº†æœ€å¤§çš„æ‰¹å¤„ç†å¤§å°ã€‚å¦‚æœç®¡ç†ä¸å½“ï¼ŒKVç¼“å­˜ä¼šæ˜¾è‘—é™åˆ¶æ‰¹å¤„ç†çš„å¤§å°ï¼Œä»è€Œå½±å“LLMçš„å¤„ç†æ•ˆç‡ã€‚</p><p>ä½œè€…å‘ç°ç°æœ‰çš„LLMæœåŠ¡ç³»ç»Ÿåœ¨ç®¡ç†KVç¼“å­˜å†…å­˜æ–¹é¢æ•ˆç‡ä¸é«˜ã€‚ä¸»è¦å› ä¸ºï¼š</p><ul><li><p><strong>å†…å­˜ç¢ç‰‡åŒ–</strong></p><p>KV Cacheéšç€æ¨¡å‹ç”Ÿæˆæ–°è¯è€Œ <strong>åŠ¨æ€å¢é•¿å’Œæ”¶ç¼©</strong>ï¼Œå¹¶ä¸”å®ƒçš„ç”Ÿå‘½å‘¨æœŸå’Œé•¿åº¦æ˜¯æœªçŸ¥çš„ã€‚ç°æœ‰ç³»ç»Ÿä¸ºäº†åœ¨è¿ç»­ç©ºé—´ä¸­å­˜å‚¨è¯·æ±‚çš„KVç¼“å­˜ï¼Œå®ƒä»¬ä¼š <strong>é¢„å…ˆåˆ†é…</strong> ä¸€å¤§å—å†…å­˜ï¼ŒæŒ‰ç…§è¯·æ±‚çš„æœ€å¤§é•¿åº¦ï¼ˆæ¯”å¦‚2048ä¸ªè¯ï¼‰æ¥åˆ†é…ï¼Œä½†è¯·æ±‚çš„å®é™…é•¿åº¦å¾€å¾€æ¯”æœ€å¤§é•¿åº¦çŸ­å¾ˆå¤šï¼Œä¸”ä¸èƒ½è¢«å…¶ä»–çŸ­è¯·æ±‚å ç”¨ï¼Œå¯¼è‡´ä¸¥é‡çš„å†…éƒ¨ç¢ç‰‡åŒ–ã€‚è€Œä¸”ï¼Œä¸åŒè¯·æ±‚çš„é¢„åˆ†é…å¤§å°ä¸åŒï¼Œè¿˜ä¼šå¯¼è‡´ <strong>å¤–éƒ¨å†…å­˜ç¢ç‰‡åŒ–</strong> ã€‚</p><p><img src="/posts_img/vLLM/3.png"></p><p>å›¾ä¸­æ˜¾ç¤ºäº†ä¸¤ä¸ªè¯·æ±‚ï¼šæœ€å¤§å¯èƒ½åºåˆ—é•¿åº¦ä¸º2048çš„è¯·æ±‚Aå’Œæœ€å¤§åºåˆ—é•¿åº¦ä¸º512çš„è¯·æ±‚Bã€‚ä¸‰ä¸ªä¸»è¦çš„å†…å­˜æµªè´¹æ¥æºï¼š</p><ul><li>ä¸ºæœªæ¥ä»¤ç‰Œé¢„ç•™çš„æ’æ§½</li><li>è¿‡åº¦é…ç½®æœ€å¤§åºåˆ—é•¿åº¦è€Œå¯¼è‡´çš„å†…éƒ¨ç¢ç‰‡</li><li>æ¥è‡ªå†…å­˜åˆ†é…å™¨ï¼ˆå¦‚ä¼™ä¼´åˆ†é…å™¨ï¼‰çš„å¤–éƒ¨ç¢ç‰‡</li></ul><p>ä½œè€…çš„åˆ†æç»“æœæ˜¾ç¤ºï¼Œç°æœ‰ç³»ç»Ÿä¸­åªæœ‰20.4%-38.2%çš„KVç¼“å­˜å†…å­˜å®é™…ç”¨äºå­˜å‚¨æ ‡è®°çŠ¶æ€ã€‚</p></li><li><p><strong>æ— æ³•åˆ©ç”¨å†…å­˜å…±äº«</strong></p><p>LLMæœåŠ¡å¸¸å¸¸ä½¿ç”¨é«˜çº§è§£ç ç®—æ³•ï¼Œæ¯”å¦‚å¹¶è¡Œé‡‡æ ·å’ŒæŸæœç´¢ï¼Œè¿™äº›ç®—æ³•ä¼šä¸ºæ¯ä¸ªè¯·æ±‚ç”Ÿæˆå¤šä¸ªè¾“å‡ºã€‚åœ¨è¿™äº›åœºæ™¯ä¸­ï¼Œè¯·æ±‚åŒ…å«çš„å¤šä¸ªåºåˆ—å¯ä»¥éƒ¨åˆ†å…±äº«å…¶KVç¼“å­˜ã€‚ä½†ç°æœ‰ç³»ç»Ÿä¸­KV Cacheå­˜å‚¨åœ¨ä¸åŒçš„è¿ç»­ç©ºé—´ä¸­ï¼Œæ— æ³•å®ç°å†…å­˜å…±äº«ã€‚</p></li></ul><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä½œè€…å— <strong>æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜åˆ†é¡µ</strong> å¯å‘ï¼Œæå‡ºäº†PagedAttentionï¼Œå°†è¯·æ±‚çš„KVç¼“å­˜åˆ†æˆå¤šä¸ªå°å—ï¼Œæ¯ä¸ªå°å—åŒ…å«å›ºå®šæ•°é‡çš„æ³¨æ„åŠ›é”®å’Œå€¼ã€‚è¿™äº›å°å—ä¸éœ€è¦å­˜å‚¨åœ¨è¿ç»­çš„ç©ºé—´ä¸­ï¼Œå› æ­¤å¯ä»¥åƒæ“ä½œç³»ç»Ÿç®¡ç†è™šæ‹Ÿå†…å­˜é‚£æ ·çµæ´»åœ°ç®¡ç†KVç¼“å­˜ã€‚é€šè¿‡ä½¿ç”¨ç›¸å¯¹è¾ƒå°çš„å°å—å¹¶æŒ‰éœ€åˆ†é…ï¼ŒPagedAttentionç¼“è§£äº†å†…éƒ¨ç¢ç‰‡åŒ–é—®é¢˜ã€‚æ­¤å¤–ï¼Œç”±äºæ‰€æœ‰å°å—å¤§å°ç›¸åŒï¼Œå®ƒè¿˜æ¶ˆé™¤äº†å¤–éƒ¨ç¢ç‰‡åŒ–é—®é¢˜ã€‚å®ƒå®ç°äº†å†…å­˜å…±äº«ï¼Œä½¿åŒä¸€è¯·æ±‚çš„ä¸åŒåºåˆ—ç”šè‡³ä¸åŒè¯·æ±‚ä¹‹é—´å¯ä»¥åœ¨å°å—çº§åˆ«å…±äº«å†…å­˜ã€‚</p><p>ä½œè€…åŸºäºPagedAttentionæ„å»ºäº†ä¸€ä¸ªé«˜ååé‡çš„åˆ†å¸ƒå¼LLMæœåŠ¡å¼•æ“vLLMï¼Œè¯¥å¼•æ“å®ç°äº†KVç¼“å­˜å†…å­˜çš„è¿‘ä¹é›¶æµªè´¹ï¼Œæ”¯æŒå„ç§æµè¡Œçš„å¤§è¯­è¨€æ¨¡å‹ï¼Œå¦‚GPTã€OPTå’ŒLLaMAï¼Œå¹¶ä¸”æ”¯æŒè¶…è¿‡å•ä¸ªGPUå†…å­˜å®¹é‡çš„æ¨¡å‹ã€‚è¯„ä¼°ç»“æœæ˜¾ç¤ºï¼ŒvLLMåœ¨å„ç§æ¨¡å‹å’Œå·¥ä½œè´Ÿè½½ä¸‹ï¼Œç›¸æ¯”æœ€å…ˆè¿›çš„ç³»ç»Ÿï¼Œå…¶LLMæœåŠ¡ååé‡æé«˜äº†2-4å€ã€‚ä¸”è¿™ç§æ”¹è¿›åœ¨å¤„ç†è¾ƒé•¿åºåˆ—ã€è¾ƒå¤§æ¨¡å‹å’Œæ›´å¤æ‚çš„è§£ç ç®—æ³•æ—¶æ›´åŠ æ˜¾è‘—ã€‚</p><p><img src="/posts_img/vLLM/2.png"></p><h1 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h1><h2 id="PageAttentionç®—æ³•"><a href="#PageAttentionç®—æ³•" class="headerlink" title="PageAttentionç®—æ³•"></a>PageAttentionç®—æ³•</h2><p>PagedAttentionå°†æ¯ä¸ªåºåˆ—çš„é”®å€¼ï¼ˆKVï¼‰ç¼“å­˜åˆ’åˆ†ä¸ºKVå—ã€‚æ¯ä¸ªå—åŒ…å«ä¸€å®šæ•°é‡çš„ä»¤ç‰Œçš„é”®å’Œå€¼å‘é‡ã€‚ä¾‹å¦‚ï¼Œé”®å—ğ¾ğ‘—åŒ…å«çš„æ˜¯ç¬¬ğ‘—ä¸ªå—ä¸­çš„é”®å‘é‡ï¼Œè€Œå€¼å—ğ‘‰ğ‘—åŒ…å«çš„æ˜¯ç¬¬ğ‘—ä¸ªå—ä¸­çš„å€¼å‘é‡ã€‚åœ¨æ³¨æ„åŠ›è®¡ç®—è¿‡ç¨‹ä¸­ï¼ŒPagedAttentionå†…æ ¸åˆ†åˆ«è¯†åˆ«å’Œè·å–ä¸åŒçš„KVå—ã€‚</p><p><img src="/posts_img/vLLM/5.png"></p><p>ä¾‹å¦‚ï¼Œå½“å¤„ç†æŸ¥è¯¢æ ‡è®°ä¸ºâ€œforthâ€æ—¶ï¼Œå†…æ ¸å°†æŸ¥è¯¢å‘é‡ğ‘ğ‘–ä¸æ¯ä¸ªå—ä¸­çš„é”®å‘é‡ğ¾ğ‘—ç›¸ä¹˜ï¼Œä»¥è®¡ç®—æ³¨æ„åŠ›å¾—åˆ†ğ´ğ‘–ğ‘—ã€‚ç„¶åï¼Œå®ƒå°†è¿™äº›å¾—åˆ†ä¸æ¯ä¸ªå—ä¸­çš„å€¼å‘é‡ğ‘‰ğ‘—ç›¸ä¹˜ï¼Œå¾—å‡ºæœ€ç»ˆçš„æ³¨æ„åŠ›è¾“å‡ºã€‚</p><p><img src="/posts_img/vLLM/g1.png"></p><h2 id="KV-Cacheç®¡ç†å™¨"><a href="#KV-Cacheç®¡ç†å™¨" class="headerlink" title="KV Cacheç®¡ç†å™¨"></a>KV Cacheç®¡ç†å™¨</h2><p>KV Cacheç®¡ç†å™¨å°†KVç¼“å­˜ç»„ç»‡æˆå›ºå®šå¤§å°çš„KVå—ï¼Œç±»ä¼¼äºè™šæ‹Ÿå†…å­˜ä¸­çš„é¡µé¢ã€‚ä¸€ä¸ªè¯·æ±‚çš„KVç¼“å­˜è¢«è¡¨ç¤ºä¸ºä¸€ç³»åˆ—é€»è¾‘KVå—ï¼Œå½“æ–°çš„ä»¤ç‰ŒåŠå…¶KVç¼“å­˜ç”Ÿæˆæ—¶ï¼Œä»å·¦åˆ°å³å¡«å……ã€‚æœ€åä¸€ä¸ªKVå—çš„æœªå¡«å……ä½ç½®ä¿ç•™ä¾›å°†æ¥ä½¿ç”¨ã€‚</p><p>åœ¨GPUå·¥ä½œå™¨ä¸Šï¼Œblock engineåˆ†é…ä¸€å—è¿ç»­çš„GPU DRAMï¼Œå¹¶å°†å…¶åˆ’åˆ†ä¸ºç‰©ç†KVå—ã€‚KVå—ç®¡ç†å™¨è¿˜ç»´æŠ¤å—è¡¨â€”â€”æ¯ä¸ªè¯·æ±‚çš„é€»è¾‘å’Œç‰©ç†KVå—ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚æ¯ä¸ªå—è¡¨æ¡ç›®è®°å½•äº†é€»è¾‘å—çš„ç›¸åº”ç‰©ç†å—åŠå…¶å¡«å……ä½ç½®çš„æ•°é‡ã€‚å°†é€»è¾‘å’Œç‰©ç†KVå—åˆ†å¼€ä½¿å¾—vLLMå¯ä»¥åŠ¨æ€å¢é•¿KVç¼“å­˜å†…å­˜ï¼Œè€Œæ— éœ€æå‰ä¸ºæ‰€æœ‰ä½ç½®é¢„ç•™ç©ºé—´ï¼Œè¿™æ¶ˆé™¤äº†ç°æœ‰ç³»ç»Ÿä¸­å¤§éƒ¨åˆ†çš„å†…å­˜æµªè´¹ã€‚</p><h2 id="åŸºæœ¬çš„æ¨ç†åœºæ™¯"><a href="#åŸºæœ¬çš„æ¨ç†åœºæ™¯" class="headerlink" title="åŸºæœ¬çš„æ¨ç†åœºæ™¯"></a>åŸºæœ¬çš„æ¨ç†åœºæ™¯</h2><p><img src="/posts_img/vLLM/6.png"></p><p>æœ¬ä¾‹ä¸­ï¼Œæç¤ºæœ‰7ä¸ªæ ‡è®°ï¼Œå› æ­¤vLLMå°†å‰ä¸¤ä¸ªé€»è¾‘KVå—ï¼ˆ0å’Œ1ï¼‰æ˜ å°„åˆ°ä¸¤ä¸ªç‰©ç†KVå—ï¼ˆ7å’Œ1ï¼‰ã€‚</p><p>åœ¨prefillæ­¥éª¤ä¸­ï¼ŒvLLMä½¿ç”¨ä¼ ç»Ÿçš„è‡ªæ³¨æ„åŠ›ç®—æ³•ç”ŸæˆKVç¼“å­˜å’Œç¬¬ä¸€ä¸ªtokenã€‚ç„¶åï¼ŒvLLMå°†å‰4ä¸ªæ ‡è®°çš„KVç¼“å­˜å­˜å‚¨åœ¨é€»è¾‘å—0ä¸­ï¼Œåç»­3ä¸ªæ ‡è®°å­˜å‚¨åœ¨é€»è¾‘å—1ä¸­ã€‚å‰©ä½™çš„ä½ç½®ç•™å¾…åç»­è‡ªå›å½’ç”Ÿæˆé˜¶æ®µä½¿ç”¨ã€‚</p><p>åœ¨ç¬¬1ä¸ªdecodeæ­¥éª¤ä¸­ï¼ŒvLLMä½¿ç”¨PagedAttentionç®—æ³•åœ¨ç‰©ç†å—7å’Œ1ä¸Šç”Ÿæˆæ–°çš„æ ‡è®°ã€‚ç”±äºæœ€åä¸€ä¸ªé€»è¾‘å—ä¸­è¿˜æœ‰ä¸€ä¸ªç©ºä½ï¼Œæ–°ç”Ÿæˆçš„KVç¼“å­˜è¢«å­˜å‚¨åœ¨é‚£é‡Œï¼Œå¹¶ä¸”æ›´æ–°äº†å—è¡¨ä¸­çš„å·²å¡«å……è®°å½•ã€‚</p><p>åœ¨ç¬¬2ä¸ªdecodeæ­¥éª¤ä¸­ï¼Œç”±äºæœ€åä¸€ä¸ªé€»è¾‘å—å·²æ»¡ï¼ŒvLLMå°†æ–°ç”Ÿæˆçš„KVç¼“å­˜å­˜å‚¨åœ¨ä¸€ä¸ªæ–°çš„é€»è¾‘å—ä¸­ï¼›vLLMä¸ºå…¶åˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†å—ï¼ˆç‰©ç†å—3ï¼‰å¹¶å°†æ­¤æ˜ å°„å­˜å‚¨åœ¨å—è¡¨ä¸­ã€‚</p><p>å¯¹äºæ¯ä¸ªdecodeè¿­ä»£ï¼ŒvLLMé¦–å…ˆé€‰æ‹©ä¸€ç»„å€™é€‰åºåˆ—è¿›è¡Œæ‰¹å¤„ç†(åŸç†åŒOrcaé€‰æ‹©æ€§æ‰¹å¤„ç†)ï¼Œå¹¶ä¸ºæ–°éœ€æ±‚çš„é€»è¾‘å—åˆ†é…ç‰©ç†å—ã€‚vLLMåŠ¨æ€åœ°ä¸ºé€»è¾‘å—åˆ†é…æ–°çš„ç‰©ç†å—ï¼Œå°†è¯·æ±‚çš„æ‰€æœ‰å†…å­˜æµªè´¹é™åˆ¶åœ¨ä¸€ä¸ªå—å†…ï¼Œå› æ­¤å¯ä»¥æœ‰æ•ˆåœ°åˆ©ç”¨æ‰€æœ‰å†…å­˜ï¼Œ</p><p><img src="/posts_img/vLLM/7.png"></p><p>è¿™ä¸¤ä¸ªåºåˆ—çš„é€»è¾‘å—è¢«æ˜ å°„åˆ°GPUå·¥ä½œå™¨ä¸­å—å¼•æ“é¢„ç•™çš„ä¸åŒç‰©ç†å—ä¸­ã€‚è¿™ä¸¤ä¸ªåºåˆ—çš„ç›¸é‚»é€»è¾‘å—åœ¨ç‰©ç†GPUå†…å­˜ä¸­ä¸éœ€è¦è¿ç»­ï¼Œç‰©ç†å—çš„ç©ºé—´å¯ä»¥è¢«ä¸¤ä¸ªåºåˆ—æœ‰æ•ˆåœ°åˆ©ç”¨ã€‚</p><h2 id="ä¸åŒçš„æ¨ç†åœºæ™¯"><a href="#ä¸åŒçš„æ¨ç†åœºæ™¯" class="headerlink" title="ä¸åŒçš„æ¨ç†åœºæ™¯"></a>ä¸åŒçš„æ¨ç†åœºæ™¯</h2><h3 id="Parallel-samplingï¼ˆå¹¶è¡Œé‡‡æ ·ï¼‰"><a href="#Parallel-samplingï¼ˆå¹¶è¡Œé‡‡æ ·ï¼‰" class="headerlink" title="Parallel samplingï¼ˆå¹¶è¡Œé‡‡æ ·ï¼‰"></a>Parallel samplingï¼ˆå¹¶è¡Œé‡‡æ ·ï¼‰</h3><p>åœ¨ LLM åº”ç”¨ä¸­ï¼Œä¸€ä¸ªè¾“å…¥æç¤ºå¯èƒ½ç”Ÿæˆå¤šä¸ªè¾“å‡ºï¼Œç”¨æˆ·å¯ä»¥ä»å¤šä¸ªå€™é€‰é¡¹ä¸­é€‰æ‹©æœ€å–œæ¬¢çš„ç»“æœã€‚ä¸€ä¸ªè¯·æ±‚åŒ…å«å¤šä¸ªå…±äº«ç›¸åŒè¾“å…¥æç¤ºçš„æ ·æœ¬ï¼Œå› æ­¤æç¤ºçš„KVç¼“å­˜ä¹Ÿå¯ä»¥å…±äº«ã€‚</p><p><img src="/posts_img/vLLM/8.png"></p><p>å›¾ä¸­å±•ç¤ºäº†ä¸¤ä¸ªè¾“å‡ºçš„å¹¶è¡Œè§£ç ç¤ºä¾‹ã€‚ä¸ºäº†ç®¡ç†å…±äº«ï¼ŒvLLMä¸ºæ¯ä¸ªç‰©ç†å—å¼•å…¥äº†å¼•ç”¨è®¡æ•°ï¼Œç‰©ç†å—7å’Œ1çš„å¼•ç”¨è®¡æ•°éƒ½æ˜¯2ã€‚åœ¨ç”Ÿæˆé˜¶æ®µï¼Œè¿™ä¸¤ä¸ªè¾“å‡ºç”Ÿæˆä¸åŒçš„è¾“å‡ºæ ‡è®°ï¼Œå› æ­¤éœ€è¦å•ç‹¬çš„KVç¼“å­˜å­˜å‚¨ã€‚</p><p>vLLMå¯¹éœ€è¦è¢«å¤šä¸ªåºåˆ—ä¿®æ”¹çš„ç‰©ç†å—å®ç°äº†å—çº§çš„copy-on-writeæœºåˆ¶ï¼ˆç±»ä¼¼äºæ“ä½œç³»ç»Ÿä¸­çš„å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼‰ã€‚å½“æ ·æœ¬A1éœ€è¦å†™å…¥å…¶æœ€åä¸€ä¸ªé€»è¾‘å—ï¼ˆé€»è¾‘å—1ï¼‰æ—¶ï¼ŒvLLMæ£€æµ‹åˆ°ç›¸åº”çš„ç‰©ç†å—ï¼ˆç‰©ç†å—1ï¼‰çš„å¼•ç”¨è®¡æ•°å¤§äº1ï¼Œäºæ˜¯åˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†å—ï¼ˆç‰©ç†å—3ï¼‰ï¼Œå¹¶æŒ‡ç¤ºå—å¼•æ“å°†ä¿¡æ¯ä»ç‰©ç†å—1å¤åˆ¶è¿‡å»ï¼ŒåŒæ—¶å°†å¼•ç”¨è®¡æ•°å‡ä¸º1ã€‚æ¥ä¸‹æ¥ï¼Œå½“æ ·æœ¬A2å†™å…¥ç‰©ç†å—1æ—¶ï¼Œå¼•ç”¨è®¡æ•°å·²ç»å‡å°‘åˆ°1ï¼Œå› æ­¤A2å¯ä»¥ç›´æ¥å°†æ–°ç”Ÿæˆçš„KVç¼“å­˜å†™å…¥ç‰©ç†å—1ã€‚</p><h3 id="Beam-searchï¼ˆæŸçŠ¶æœç´¢ï¼‰"><a href="#Beam-searchï¼ˆæŸçŠ¶æœç´¢ï¼‰" class="headerlink" title="Beam searchï¼ˆæŸçŠ¶æœç´¢ï¼‰"></a>Beam searchï¼ˆæŸçŠ¶æœç´¢ï¼‰</h3><p>åœ¨LLMï¼ˆå¤§å‹è¯­è¨€æ¨¡å‹ï¼‰ä»»åŠ¡å¦‚æœºå™¨ç¿»è¯‘ä¸­ï¼Œç”¨æˆ·é€šå¸¸æœŸæœ›å¾—åˆ°æœ€åˆé€‚çš„å‰ğ‘˜ä¸ªç¿»è¯‘ç»“æœã€‚Beam searchæ˜¯ä¸€ç§å¸¸ç”¨çš„è§£ç ç®—æ³•ï¼Œç”¨äºä»LLMä¸­ç”Ÿæˆæœ€å¯èƒ½çš„è¾“å‡ºåºåˆ—ã€‚ç®—æ³•ä¾èµ–äºä¸€ä¸ªå‚æ•°ğ‘˜ï¼Œè¯¥å‚æ•°å†³å®šæ¯ä¸€æ­¥ä¿ç•™çš„æœ€é¡¶å°–çš„å€™é€‰åºåˆ—æ•°é‡ã€‚åœ¨è§£ç è¿‡ç¨‹ä¸­ï¼ŒBeam searchä¼šæ‰©å±•æ¯ä¸ªå€™é€‰åºåˆ—ï¼Œè€ƒè™‘æ‰€æœ‰å¯èƒ½çš„æ ‡è®°ï¼Œè®¡ç®—å®ƒä»¬å„è‡ªçš„æ¦‚ç‡ï¼Œå¹¶ä»ğ‘˜ Â· |ğ‘‰|ä¸ªå€™é€‰ä¸­ä¿ç•™å‰ğ‘˜ä¸ªæœ€å¯èƒ½çš„åºåˆ—ï¼Œå…¶ä¸­|ğ‘‰|æ˜¯è¯æ±‡è¡¨çš„å¤§å°ã€‚</p><p><img src="/posts_img/vLLM/9.png"></p><p>ä¸å¹¶è¡Œè§£ç ä¸åŒï¼ŒBeam searchä¸ä»…å¯ä»¥å…±äº«åˆå§‹æç¤ºå—ï¼Œè¿˜å¯ä»¥åœ¨ä¸åŒçš„å€™é€‰åºåˆ—ä¹‹é—´å…±äº«å…¶ä»–å—ï¼Œå¹¶ä¸”è¿™äº›å…±äº«æ¨¡å¼ä¼šéšç€è§£ç è¿‡ç¨‹çš„æ¨è¿›åŠ¨æ€å˜åŒ–ï¼Œç±»ä¼¼äºæ“ä½œç³»ç»Ÿä¸­ç”±å¤åˆåˆ†å‰åˆ›å»ºçš„è¿›ç¨‹æ ‘ã€‚</p><p>å›¾ä¸­å±•ç¤ºäº†vLLMå¦‚ä½•ç®¡ç†ä¸€ä¸ªğ‘˜&#x3D;4çš„Beam searchç¤ºä¾‹ä¸­çš„KVå—ã€‚åœ¨å›¾ä¸­è™šçº¿ä¹‹å‰ï¼Œæ¯ä¸ªå€™é€‰åºåˆ—å·²ç»ä½¿ç”¨äº†4ä¸ªå®Œæ•´çš„é€»è¾‘å—ã€‚æ‰€æœ‰Beamå€™é€‰å…±äº«ç¬¬ä¸€ä¸ªå—0ï¼ˆå³æç¤ºï¼‰ã€‚å€™é€‰3ä»ç¬¬äºŒå—å¼€å§‹ä¸å…¶ä»–å€™é€‰åˆ†å¼€ã€‚å€™é€‰0-2å…±äº«å‰ä¸‰ä¸ªå—ï¼Œå¹¶åœ¨ç¬¬å››å—åˆ†å¼€ã€‚åœ¨éšåçš„è¿­ä»£ä¸­ï¼Œæœ€å¯èƒ½çš„å‰4ä¸ªå€™é€‰éƒ½æºè‡ªå€™é€‰1å’Œ2ã€‚ç”±äºåŸå§‹å€™é€‰0å’Œ3ä¸å†æ˜¯é¡¶å°–å€™é€‰ï¼Œå®ƒä»¬çš„é€»è¾‘å—è¢«é‡Šæ”¾ï¼Œå¯¹åº”çš„ç‰©ç†å—å¼•ç”¨è®¡æ•°å‡å°‘ã€‚vLLMé‡Šæ”¾æ‰€æœ‰å¼•ç”¨è®¡æ•°ä¸º0çš„ç‰©ç†å—ï¼ˆå—2ã€4ã€5ã€8ï¼‰ã€‚ç„¶åï¼ŒvLLMåˆ†é…æ–°çš„ç‰©ç†å—ï¼ˆå—9-12ï¼‰ä»¥å­˜å‚¨æ–°å€™é€‰ç”Ÿæˆçš„KVç¼“å­˜ã€‚</p><p>ç°åœ¨ï¼Œæ‰€æœ‰å€™é€‰å…±äº«å—0ã€1ã€3ï¼›å€™é€‰0å’Œ1å…±äº«å—6ï¼Œå€™é€‰2å’Œ3è¿›ä¸€æ­¥å…±äº«å—7ã€‚ä»¥å‰çš„LLMæœåŠ¡ç³»ç»Ÿéœ€è¦åœ¨Beamå€™é€‰ä¹‹é—´é¢‘ç¹å¤åˆ¶KVç¼“å­˜ï¼Œè¿™ä¼šå¸¦æ¥å¾ˆå¤§çš„å†…å­˜å¤åˆ¶å¼€é”€ã€‚ä¾‹å¦‚ï¼Œåœ¨å›¾æ‰€ç¤ºçš„æƒ…å†µä¸‹ï¼Œè™šçº¿ä¹‹åï¼Œå€™é€‰3éœ€è¦å¤åˆ¶å€™é€‰2çš„å¤§éƒ¨åˆ†KVç¼“å­˜ä»¥ç»§ç»­ç”Ÿæˆã€‚vLLMé€šè¿‡ç‰©ç†å—å…±äº«æ˜¾è‘—å‡å°‘äº†è¿™ç§é¢‘ç¹çš„å†…å­˜å¤åˆ¶å¼€é”€ã€‚åœ¨vLLMä¸­ï¼Œä¸åŒBeamå€™é€‰çš„å¤§å¤šæ•°å—å¯ä»¥å…±äº«ã€‚åªæœ‰å½“æ–°ç”Ÿæˆçš„æ ‡è®°ä½äºæ—§çš„å…±äº«å—å†…æ—¶ï¼Œæ‰ä¼šåº”ç”¨å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼Œè¿™ä»…æ¶‰åŠå¤åˆ¶ä¸€ä¸ªå—çš„æ•°æ®ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼ŒvLLMé€šè¿‡æœ‰æ•ˆçš„ç‰©ç†å—å…±äº«å’Œå†™æ—¶å¤åˆ¶æœºåˆ¶ï¼Œå¤§å¤§æé«˜äº†Beam searchè§£ç è¿‡ç¨‹ä¸­çš„å†…å­˜åˆ©ç”¨æ•ˆç‡ï¼Œå‡å°‘äº†å†…å­˜å¤åˆ¶å¼€é”€ã€‚</p><h3 id="Shared-prefixï¼ˆå…±äº«å‰ç¼€ï¼‰"><a href="#Shared-prefixï¼ˆå…±äº«å‰ç¼€ï¼‰" class="headerlink" title="Shared prefixï¼ˆå…±äº«å‰ç¼€ï¼‰"></a>Shared prefixï¼ˆå…±äº«å‰ç¼€ï¼‰</h3><p>è®¸å¤šç”¨æˆ·æç¤ºå¯èƒ½å…±äº«ä¸€ä¸ªå‰ç¼€ï¼Œå› æ­¤LLMæœåŠ¡æä¾›è€…å¯ä»¥æå‰å­˜å‚¨è¿™ä¸ªå‰ç¼€çš„KVç¼“å­˜ï¼Œä»¥å‡å°‘åœ¨å‰ç¼€ä¸Šçš„é‡å¤è®¡ç®—ã€‚åœ¨vLLMä¸­ï¼Œå¯ä»¥é€šè¿‡ä¸ºä¸€ç»„é¢„å®šä¹‰çš„å…±äº«å‰ç¼€ä¿ç•™ä¸€ç»„ç‰©ç†å—æ¥æ–¹ä¾¿åœ°å®ç°è¿™ä¸€ç‚¹ï¼Œå°±åƒæ“ä½œç³»ç»Ÿå¤„ç†è·¨è¿›ç¨‹å…±äº«åº“ä¸€æ ·ã€‚</p><p><img src="/posts_img/vLLM/10.png"></p><h3 id="æ··åˆè§£ç "><a href="#æ··åˆè§£ç " class="headerlink" title="æ··åˆè§£ç "></a>æ··åˆè§£ç </h3><p>åŸºäºä¸Šé¢çš„å†…å­˜ç®¡ç†æ–¹æ³•ï¼ŒvLLMèƒ½å¤ŸåŒæ—¶å¤„ç†å…·æœ‰ä¸åŒç”šè‡³æ˜¯æ··åˆè§£ç åå¥½çš„è¯·æ±‚ï¼Œè¿™æ˜¯ç°æœ‰ç³»ç»Ÿæ— æ³•é«˜æ•ˆå®Œæˆçš„ã€‚è¿™æ˜¯å› ä¸ºvLLMé€šè¿‡ä¸€ä¸ªå…¬å…±æ˜ å°„å±‚éšè—äº†ä¸åŒåºåˆ—ä¹‹é—´å¤æ‚çš„å†…å­˜å…±äº«ï¼Œè¯¥æ˜ å°„å±‚å°†é€»è¾‘å—è½¬æ¢ä¸ºç‰©ç†å—ã€‚</p><p>LLMåŠå…¶æ‰§è¡Œå†…æ ¸åªéœ€çœ‹åˆ°æ¯ä¸ªåºåˆ—çš„ä¸€ç»„ç‰©ç†å—IDï¼Œè€Œä¸éœ€è¦å¤„ç†è·¨åºåˆ—çš„å…±äº«æ¨¡å¼ã€‚ä¸ç°æœ‰ç³»ç»Ÿç›¸æ¯”ï¼Œè¿™ç§æ–¹æ³•æ‹“å®½äº†å…·æœ‰ä¸åŒé‡‡æ ·éœ€æ±‚çš„è¯·æ±‚çš„æ‰¹å¤„ç†æœºä¼šï¼Œä»è€Œæœ€ç»ˆæé«˜äº†ç³»ç»Ÿçš„æ•´ä½“ååé‡ã€‚</p><h2 id="è°ƒåº¦ä¸æŠ¢å "><a href="#è°ƒåº¦ä¸æŠ¢å " class="headerlink" title="è°ƒåº¦ä¸æŠ¢å "></a>è°ƒåº¦ä¸æŠ¢å </h2><p>å½“è¯·æ±‚æµé‡è¶…è¿‡ç³»ç»Ÿå®¹é‡æ—¶ï¼Œé‡‡ç”¨å…ˆåˆ°å…ˆæœåŠ¡ï¼ˆFCFSï¼‰è°ƒåº¦ç­–ç•¥ï¼Œç¡®ä¿å…¬å¹³æ€§å¹¶é˜²æ­¢é¥¥é¥¿ã€‚</p><ol><li><p>é©±é€<br>é€šå¸¸ï¼Œé©±é€ç­–ç•¥ä½¿ç”¨å¯å‘å¼æ–¹æ³•æ¥é¢„æµ‹å“ªä¸ªå—å°†æ¥è®¿é—®çš„æœ€è¿œï¼Œå¹¶é©±é€è¯¥å—ã€‚ç”±äºä¸€ä¸ªåºåˆ—çš„æ‰€æœ‰å—éƒ½æ˜¯ä¸€èµ·è®¿é—®çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å®æ–½äº†ä¸€ç§å…¨æœ‰æˆ–å…¨æ— çš„é©±é€ç­–ç•¥ï¼Œå³è¦ä¹ˆé©±é€åºåˆ—çš„æ‰€æœ‰å—ï¼Œè¦ä¹ˆä¸€ä¸ªä¹Ÿä¸é©±é€ã€‚</p></li><li><p>æ¢å¤<br><strong>äº¤æ¢</strong>ï¼šå°†è¢«é©±é€çš„å—å¤åˆ¶åˆ° CPU å†…å­˜ä¸­ã€‚å½“ vLLM ä¸ºæ–°ä»¤ç‰Œè€—å°½è‡ªç”±ç‰©ç†å—æ—¶ï¼Œå®ƒé€‰æ‹©ä¸€ç»„åºåˆ—è¿›è¡Œé©±é€ï¼Œå¹¶å°†å®ƒä»¬çš„ KV ç¼“å­˜ä¼ è¾“åˆ° CPUã€‚ä¸€æ—¦æŠ¢å äº†ä¸€ä¸ªåºåˆ—å¹¶é©±é€äº†å®ƒçš„å—ï¼ŒvLLM å°±åœæ­¢æ¥å—æ–°è¯·æ±‚ï¼Œç›´åˆ°æ‰€æœ‰æŠ¢å çš„åºåˆ—å®Œæˆä¸ºæ­¢ã€‚ä¸€æ—¦ä¸€ä¸ªè¯·æ±‚å®Œæˆï¼Œå…¶å—å°±ä¼šä»å†…å­˜ä¸­é‡Šæ”¾ï¼ŒæŠ¢å çš„åºåˆ—çš„å—å°±ä¼šè¢«é‡æ–°å¼•å…¥ä»¥ç»§ç»­å¤„ç†è¯¥åºåˆ—ã€‚<br><strong>é‡æ–°è®¡ç®—</strong>ï¼šé‡æ–°è®¡ç®—çš„å»¶è¿Ÿå¯èƒ½ä½äºäº¤æ¢å»¶è¿Ÿï¼Œæ€§èƒ½å–å†³äº CPU RAM å’Œ GPU å†…å­˜ä¹‹é—´çš„å¸¦å®½ä»¥åŠ GPU çš„è®¡ç®—èƒ½åŠ›ã€‚ä¸ºäº†äº†è§£ä¸¤ç§æ–¹æ³•ä¹‹é—´çš„æƒè¡¡ï¼Œä½œè€…è¯„ä¼°äº†å®ƒä»¬çš„ç«¯åˆ°ç«¯æ€§èƒ½ï¼Œå¹¶å¯¹å®ƒä»¬çš„å¼€é”€è¿›è¡Œå¾®åŸºå‡†æµ‹è¯•ã€‚ç»“æœæ˜¾ç¤ºï¼Œäº¤æ¢åœ¨å°å—è¾ƒå°æ—¶äº§ç”Ÿäº†è¿‡å¤šçš„å¼€é”€ã€‚è¿™æ˜¯å› ä¸ºå°å—é€šå¸¸å¯¼è‡´CPUå’ŒGPUä¹‹é—´å¤§é‡çš„å°æ•°æ®ä¼ è¾“ï¼Œä»è€Œé™åˆ¶äº†æœ‰æ•ˆçš„PCIeå¸¦å®½ã€‚</p></li></ol><p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œé‡æ–°è®¡ç®—çš„å¼€é”€åœ¨ä¸åŒçš„å—å¤§å°ä¸‹ä¿æŒä¸å˜ï¼Œå› ä¸ºé‡æ–°è®¡ç®—ä¸åˆ©ç”¨KVå—ã€‚å› æ­¤ï¼Œå½“å—å¤§å°è¾ƒå°æ—¶ï¼Œé‡æ–°è®¡ç®—æ›´æœ‰æ•ˆç‡ï¼Œè€Œå½“å—å¤§å°è¾ƒå¤§æ—¶ï¼Œäº¤æ¢æ›´æœ‰æ•ˆç‡ï¼Œå°½ç®¡é‡æ–°è®¡ç®—çš„å¼€é”€ä»æœªé«˜äºäº¤æ¢çš„å»¶è¿Ÿçš„20%ã€‚å¯¹äºä»16åˆ°64çš„ä¸­ç­‰å—å¤§å°ï¼Œè¿™ä¸¤ç§æ–¹æ³•è¡¨ç°å‡ºç›¸å½“çš„ç«¯åˆ°ç«¯æ€§èƒ½ã€‚</p><p><img src="/posts_img/vLLM/11.png"></p><h2 id="åˆ†å¸ƒå¼æ‰§è¡Œ"><a href="#åˆ†å¸ƒå¼æ‰§è¡Œ" class="headerlink" title="åˆ†å¸ƒå¼æ‰§è¡Œ"></a>åˆ†å¸ƒå¼æ‰§è¡Œ</h2><p><img src="/posts_img/vLLM/4.png"></p><p>vLLMä½¿ç”¨çš„Megatron-LMå¼ é‡å¹¶è¡Œç­–ç•¥ã€‚æ¯ä¸ªæ¨¡å‹åˆ†ç‰‡å¤„ç†ç›¸åŒçš„è¾“å…¥ï¼Œå› æ­¤éœ€è¦ç›¸åŒä½ç½®çš„KVç¼“å­˜ã€‚å› æ­¤ï¼ŒvLLMåœ¨é›†ä¸­å¼è°ƒåº¦å™¨ä¸­å…·æœ‰ä¸€ä¸ªå•ä¸€çš„KVç¼“å­˜ç®¡ç†å™¨ã€‚ä¸åŒçš„GPUå·¥ä½œèŠ‚ç‚¹å…±äº«è¯¥ç®¡ç†å™¨ï¼Œä»¥åŠé€»è¾‘å—åˆ°ç‰©ç†å—çš„æ˜ å°„ã€‚</p><h1 id="ç³»ç»Ÿå®ç°"><a href="#ç³»ç»Ÿå®ç°" class="headerlink" title="ç³»ç»Ÿå®ç°"></a>ç³»ç»Ÿå®ç°</h1><p>vLLMåŸºäºFastAPIçš„å‰ç«¯å’ŒåŸºäºGPUçš„æ¨ç†å¼•æ“ã€‚å‰ç«¯æ‰©å±•äº†OpenAI APIæ¥å£ã€‚</p><p>vLLMå¼•æ“ç”±8.5Kè¡ŒPythonä»£ç å’Œ2Kè¡ŒC++&#x2F;CUDAä»£ç ç¼–å†™è€Œæˆã€‚ä½¿ç”¨Pythonå¼€å‘äº†è°ƒåº¦å™¨å’Œå—ç®¡ç†å™¨ç­‰æ§åˆ¶ç›¸å…³ç»„ä»¶ï¼ŒåŒæ—¶ä¸ºPagedAttentionç­‰å…³é”®æ“ä½œå¼€å‘äº†è‡ªå®šä¹‰CUDAæ ¸å¿ƒã€‚åœ¨åˆ†å¸ƒå¼GPUå·¥ä½œèŠ‚ç‚¹ä¹‹é—´çš„å¼ é‡é€šä¿¡ä¸­ï¼Œä½¿ç”¨NCCLã€‚</p><h2 id="æ ¸å¿ƒçº§ä¼˜åŒ–"><a href="#æ ¸å¿ƒçº§ä¼˜åŒ–" class="headerlink" title="æ ¸å¿ƒçº§ä¼˜åŒ–"></a>æ ¸å¿ƒçº§ä¼˜åŒ–</h2><p>ç”±äºPagedAttentionå¼•å…¥äº†ç°æœ‰ç³»ç»Ÿä¸é«˜æ•ˆæ”¯æŒçš„å†…å­˜è®¿é—®æ¨¡å¼ï¼Œå¼€å‘äº†å‡ ä¸ªGPU Kernelè¿›è¡Œä¼˜åŒ–ã€‚</p><ul><li>èåˆé‡å¡‘å’Œå—å†™å…¥ï¼šåœ¨æ¯ä¸ªTransformerå±‚ä¸­ï¼Œå°†æ–°çš„KVç¼“å­˜åˆ†å‰²æˆå—ï¼Œé‡å¡‘ä¸ºé’ˆå¯¹å—è¯»å–è¿›è¡Œä¼˜åŒ–çš„å†…å­˜å¸ƒå±€ï¼Œç„¶åä¿å­˜åœ¨ç”±å—è¡¨æŒ‡å®šçš„ä½ç½®ã€‚ä¸ºäº†æœ€å°åŒ–æ ¸å¿ƒå¯åŠ¨å¼€é”€ï¼Œå°†å®ƒä»¬èåˆæˆå•ä¸ªæ ¸å¿ƒã€‚</li><li>èåˆå—è¯»å–å’Œæ³¨æ„åŠ›ï¼šè°ƒæ•´äº†FasterTransformerä¸­çš„æ³¨æ„åŠ›æ ¸å¿ƒï¼Œæ ¹æ®å—è¡¨è¯»å–KVç¼“å­˜å¹¶å®æ—¶æ‰§è¡Œæ³¨æ„åŠ›æ“ä½œã€‚ä¸ºäº†ç¡®ä¿åˆå¹¶å†…å­˜è®¿é—®ï¼Œä¸ºæ¯ä¸ªå—åˆ†é…äº†ä¸€ä¸ªGPUçº¿ç¨‹æŸã€‚æ­¤å¤–ï¼Œå¢åŠ äº†å¯¹è¯·æ±‚æ‰¹å¤„ç†ä¸­å¯å˜åºåˆ—é•¿åº¦çš„æ”¯æŒã€‚</li><li>èåˆå—å¤åˆ¶ï¼šé€šè¿‡å†™æ—¶å¤åˆ¶æœºåˆ¶å‘å‡ºçš„å—å¤åˆ¶æ“ä½œå¯èƒ½åœ¨ä¸è¿ç»­çš„å—ä¸Šæ“ä½œã€‚å¦‚æœä½¿ç”¨cudaMemcpyAsync APIï¼Œè¿™å¯èƒ½å¯¼è‡´å¤§é‡å°æ•°æ®ç§»åŠ¨çš„è°ƒç”¨ã€‚ä¸ºäº†å‡è½»å¼€é”€ï¼Œå®ç°äº†å°†ä¸åŒå—çš„å¤åˆ¶æ“ä½œæ‰¹å¤„ç†åˆ°å•ä¸ªæ ¸å¿ƒå¯åŠ¨ä¸­ã€‚</li></ul><h1 id="è®¨è®º"><a href="#è®¨è®º" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h1><p>è™šæ‹Ÿå†…å­˜å’Œåˆ†é¡µæŠ€æœ¯åœ¨å…¶ä»–GPUå·¥ä½œè´Ÿè½½ä¸­çš„åº”ç”¨ï¼š</p><p>è™šæ‹Ÿå†…å­˜å’Œåˆ†é¡µåœ¨LLMï¼ˆå¤§å‹è¯­è¨€æ¨¡å‹ï¼‰æ¨ç†ä¸­çš„æœ‰æ•ˆæ€§æºäºå…¶åŠ¨æ€å†…å­˜åˆ†é…éœ€æ±‚ï¼ˆå› ä¸ºè¾“å‡ºé•¿åº¦ä¸å¯é¢„çŸ¥ï¼‰åŠå…¶å¯¹GPUå†…å­˜å®¹é‡çš„ä¾èµ–ã€‚ç„¶è€Œï¼Œè¿™å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰GPUå·¥ä½œè´Ÿè½½ã€‚ä¾‹å¦‚ï¼Œåœ¨DNNï¼ˆæ·±åº¦ç¥ç»ç½‘ç»œï¼‰è®­ç»ƒä¸­ï¼Œå¼ é‡å½¢çŠ¶é€šå¸¸æ˜¯é™æ€çš„ï¼Œå› æ­¤å¯ä»¥é¢„å…ˆä¼˜åŒ–å†…å­˜åˆ†é…ã€‚åœ¨éLLMçš„DNNæ¨ç†ä¸­ï¼Œå†…å­˜æ•ˆç‡çš„æå‡å¯èƒ½ä¸ä¼šå¸¦æ¥æ€§èƒ½æå‡ï¼Œå› ä¸ºæ€§èƒ½ä¸»è¦å—è®¡ç®—èƒ½åŠ›é™åˆ¶ã€‚åœ¨è¿™äº›åœºæ™¯ä¸­ï¼ŒvLLMæŠ€æœ¯å¯èƒ½åè€Œä¼šå› ä¸ºå†…å­˜é‡å®šå‘å’Œéè¿ç»­å†…å­˜å—å¸¦æ¥çš„é¢å¤–å¼€é”€è€Œé™ä½æ€§èƒ½ã€‚</p><p>ç„¶è€Œï¼Œå¯¹äºå…·æœ‰ä¸LLMæ¨ç†ç±»ä¼¼ç‰¹æ€§çš„å…¶ä»–å·¥ä½œè´Ÿè½½ï¼ŒvLLMæŠ€æœ¯çš„åº”ç”¨ä»å…·æœ‰æ½œåŠ›ã€‚</p><h1 id="ç›¸å…³å·¥ä½œ"><a href="#ç›¸å…³å·¥ä½œ" class="headerlink" title="ç›¸å…³å·¥ä½œ"></a>ç›¸å…³å·¥ä½œ</h1><h2 id="é€šç”¨æ¨¡å‹æœåŠ¡ç³»ç»Ÿ"><a href="#é€šç”¨æ¨¡å‹æœåŠ¡ç³»ç»Ÿ" class="headerlink" title="é€šç”¨æ¨¡å‹æœåŠ¡ç³»ç»Ÿ"></a>é€šç”¨æ¨¡å‹æœåŠ¡ç³»ç»Ÿ</h2><p>Clipper[11]ã€TensorFlow Serving[33]ã€Nexus[45]ã€InferLine[10]å’ŒClockwork[20]æ˜¯ä¸€äº›æ—©æœŸçš„é€šç”¨æ¨¡å‹æœåŠ¡ç³»ç»Ÿã€‚ä»–ä»¬ç ”ç©¶ä¸ºå•ä¸ªæˆ–å¤šä¸ªæ¨¡å‹æä¾›æœåŠ¡çš„æ‰¹å¤„ç†ã€ç¼“å­˜ã€æ”¾ç½®å’Œè°ƒåº¦ã€‚æœ€è¿‘ï¼ŒDVABatch[12]å¼•å…¥äº†å¤šå…¥å£å¤šå‡ºå£æ‰¹å¤„ç†ã€‚REEF[21]å’ŒShepherd[61]å»ºè®®ä¼˜å…ˆæŠ¢å ã€‚AlpaServe[28]åˆ©ç”¨æ¨¡å‹å¹¶è¡Œæ€§è¿›è¡Œç»Ÿè®¡å¤ç”¨ã€‚ç„¶è€Œï¼Œè¿™äº›é€šç”¨ç³»ç»Ÿæœªèƒ½è€ƒè™‘LLMæ¨ç†çš„è‡ªå›å½’ç‰¹æ€§å’Œä»¤ç‰ŒçŠ¶æ€ï¼Œå¯¼è‡´é”™è¿‡äº†ä¼˜åŒ–æœºä¼šã€‚</p><h2 id="Transformerä¸“ç”¨æ¨ç†æœåŠ¡ç³»ç»Ÿ"><a href="#Transformerä¸“ç”¨æ¨ç†æœåŠ¡ç³»ç»Ÿ" class="headerlink" title="Transformerä¸“ç”¨æ¨ç†æœåŠ¡ç³»ç»Ÿ"></a>Transformerä¸“ç”¨æ¨ç†æœåŠ¡ç³»ç»Ÿ</h2><p>è¿™äº›ç³»ç»Ÿåˆ©ç”¨GPUå†…æ ¸ä¼˜åŒ–[1,29,31,56]ã€é«˜çº§æ‰¹å¤„ç†æœºåˆ¶[14,60]ã€æ¨¡å‹å¹¶è¡Œ[1,41,60]å’Œå‚æ•°å…±äº«[64]æ¥å®ç°é«˜æ•ˆæœåŠ¡ã€‚å…¶ä¸­ï¼ŒOrca[60]ä¸æœ¬æ–‡çš„æ–¹æ³•æœ€ç›¸å…³ã€‚ä¸Orcaç›¸æ¯”ã€‚Orca[60]ä¸­çš„è¿­ä»£çº§è°ƒåº¦å’ŒvLLMä¸­çš„PagedAttentionæ˜¯äº’è¡¥çš„æŠ€æœ¯ï¼šè™½ç„¶è¿™ä¸¤ä¸ªç³»ç»Ÿéƒ½æ—¨åœ¨æé«˜GPUåˆ©ç”¨ç‡ï¼Œä»è€Œæé«˜LLMæœåŠ¡çš„ååé‡ï¼Œä½†Orcaæ˜¯é€šè¿‡è°ƒåº¦å’Œäº¤ç»‡è¯·æ±‚æ¥å®ç°çš„ï¼Œè¿™æ ·å¯ä»¥å¹¶è¡Œå¤„ç†æ›´å¤šè¯·æ±‚ï¼Œè€ŒvLLMæ˜¯é€šè¿‡æé«˜å†…å­˜åˆ©ç”¨ç‡æ¥å®ç°çš„ã€‚é€šè¿‡å‡å°‘å†…å­˜ç¢ç‰‡å’Œå¯ç”¨å…±äº«ï¼ŒvLLMå¹¶è¡Œæ‰¹å¤„ç†æ›´å¤šè¯·æ±‚ï¼Œä¸Orcaç›¸æ¯”ï¼Œé€Ÿåº¦æé«˜äº†2-4å€ã€‚äº‹å®ä¸Šï¼ŒOrcaä¸­è¯·æ±‚çš„ç»†ç²’åº¦è°ƒåº¦å’Œäº¤ç»‡ä½¿å†…å­˜ç®¡ç†æ›´å…·æŒ‘æˆ˜æ€§ï¼Œä½¿vLLMä¸­æå‡ºçš„æŠ€æœ¯å˜å¾—æ›´åŠ å…³é”®ã€‚</p><h2 id="å†…å­˜ä¼˜åŒ–"><a href="#å†…å­˜ä¼˜åŒ–" class="headerlink" title="å†…å­˜ä¼˜åŒ–"></a>å†…å­˜ä¼˜åŒ–</h2><p>GPUçš„è®¡ç®—èƒ½åŠ›å’Œå†…å­˜å®¹é‡ä¹‹é—´çš„å·®è·è¶Šæ¥è¶Šå¤§ï¼Œå¯¼è‡´å†…å­˜æˆä¸ºè®­ç»ƒå’Œæ¨ç†çš„ç“¶é¢ˆã€‚äº¤æ¢[23,42,55]ã€é‡æ–°è®¡ç®—[7,24]åŠå…¶ç»„åˆ[40]å·²è¢«ç”¨äºå‡å°‘è®­ç»ƒçš„å³°å€¼å†…å­˜ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒFlexGen[46]ç ”ç©¶äº†åœ¨GPUå†…å­˜æœ‰é™æƒ…å†µä¸‹å¦‚ä½•é€šè¿‡äº¤æ¢LLMæ¨ç†çš„æƒé‡å’Œä»¤ç‰ŒçŠ¶æ€ï¼Œä½†å®ƒä¸é’ˆå¯¹åœ¨çº¿æœåŠ¡è®¾ç½®ã€‚OLLA[48]ä¼˜åŒ–äº†å¼ é‡çš„ç”Ÿå­˜æœŸå’Œä½ç½®ä»¥å‡å°‘ç¢ç‰‡åŒ–ï¼Œä½†å®ƒä¸è¿›è¡Œç»†ç²’åº¦å—çº§ç®¡ç†æˆ–åœ¨çº¿æœåŠ¡ã€‚FlashAttention[13]åº”ç”¨å¹³é“ºå’Œå†…æ ¸ä¼˜åŒ–æ¥å‡å°‘æ³¨æ„åŠ›è®¡ç®—çš„å³°å€¼å†…å­˜å¹¶é™ä½I&#x2F;Oæˆæœ¬ã€‚æœ¬æ–‡ä»‹ç»äº†ä¸€ç§åœ¨çº¿æœåŠ¡ç¯å¢ƒä¸‹å—çº§å†…å­˜ç®¡ç†çš„æ–°æ€è·¯ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ–‡æå‡ºäº†ä¸€ç§æ–°çš„æ³¨æ„åŠ›ç®—æ³•PagedAttentionï¼Œè¯¥ç®—æ³•å…è®¸åœ¨éè¿ç»­çš„åˆ†é¡µå†…å­˜ä¸­å­˜å‚¨æ³¨æ„åŠ›é”®å’Œå€¼ï¼Œå¹¶ä»‹ç»äº†vLLMï¼Œä¸€ç§é€šè¿‡PagedAttentionå®ç°é«˜æ•ˆå†…å­˜ç®¡ç†çš„é«˜ååé‡å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æœåŠ¡ç³»ç»Ÿã€‚å—æ“ä½œç³»ç»Ÿçš„å¯å‘ï¼Œå±•ç¤ºäº†å¦‚ä½•æ”¹ç¼–è¯¸å¦‚è™šæ‹Ÿå†…å­˜å’Œå†™æ—¶å¤åˆ¶ç­‰æˆç†ŸæŠ€æœ¯ï¼Œä»¥é«˜æ•ˆç®¡ç†KVç¼“å­˜å¹¶å¤„ç†LLMæœåŠ¡ä¸­çš„å„ç§è§£ç ç®—æ³•ã€‚å®éªŒç»“æœè¡¨æ˜ï¼ŒvLLMç›¸æ¯”ç°æœ‰çš„æœ€å…ˆè¿›ç³»ç»Ÿå®ç°äº†2-4å€çš„ååé‡æå‡ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Paper Report </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLM </tag>
            
            <tag> Inference </tag>
            
            <tag> SOSP 2023 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Orca-å¤§æ¨¡å‹æ¨ç†ç³»ç»Ÿå¼€å±±ä¹‹ä½œ</title>
      <link href="/2024/09/14/Orca/"/>
      <url>/2024/09/14/Orca/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡æå‡ºäº†ä¸€ç§æ–°çš„åˆ†å¸ƒå¼æœåŠ¡ç³»ç»Ÿ ORCAï¼Œé’ˆå¯¹å¤§è§„æ¨¡ Transformer æ¨¡å‹çš„è‡ªå›å½’ç”Ÿæˆä»»åŠ¡ï¼Œè§£å†³äº†ç°æœ‰æ¨ç†æœåŠ¡ç³»ç»Ÿåœ¨å¤šè¿­ä»£ç‰¹æ€§ä»»åŠ¡ä¸Šè¡¨ç°ä¸ä½³çš„é—®é¢˜ã€‚ORCA é€šè¿‡å¼•å…¥ <strong>è¿­ä»£çº§è°ƒåº¦</strong> å’Œ <strong>é€‰æ‹©æ€§æ‰¹å¤„ç†</strong> ä¸¤é¡¹æŠ€æœ¯ï¼Œå®ç°äº†æ›´çµæ´»é«˜æ•ˆçš„è°ƒåº¦ã€‚å®éªŒç»“æœè¡¨æ˜ï¼Œåœ¨å¤„ç† GPT-3 175B æ¨¡å‹æ—¶ï¼ŒORCA åœ¨ä¿æŒç›¸åŒå»¶è¿Ÿçš„æƒ…å†µä¸‹ï¼Œååé‡è¾ƒ NVIDIA FasterTransformer æå‡äº† 36.9 å€ã€‚</p><p>è®ºæ–‡ï¼š(OSDI 2022)<a href="https://www.usenix.org/conference/osdi22/presentation/yu">ORCA: A Distributed Serving System for Transformer-Based Generative Models</a></p><h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>æœ¬æ–‡è®¨è®ºäº†åœ¨æœåŠ¡å¤§è§„æ¨¡ Transformer æ¨¡å‹æ—¶é¢ä¸´çš„æŒ‘æˆ˜ï¼Œç‰¹åˆ«æ˜¯ç”¨äºç”Ÿæˆä»»åŠ¡çš„æ¨¡å‹ï¼Œå¦‚è¯­è¨€ç”Ÿæˆã€ä»£ç ç”Ÿæˆç­‰ã€‚å…¸å‹çš„ä¾‹å­åŒ…æ‹¬ GPT-3 è¿™æ ·çš„æ¨¡å‹ã€‚éšç€å¯¹æ¨¡å‹éœ€æ±‚çš„ä¸æ–­å¢é•¿ï¼Œä½å»¶è¿Ÿå’Œé«˜ååé‡æˆä¸ºæ¨ç†ç³»ç»Ÿçš„ç›®æ ‡ï¼Œæ—©æœŸé€šè¿‡ä½¿ç”¨å¦‚Tritonå’ŒFasterTransformerçš„ç»„åˆæ¥éƒ¨ç½²æœåŠ¡ï¼ŒTritonä¸»è¦è´Ÿè´£å°†å¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚åˆ†ç»„åˆ°ä¸€ä¸ªæ‰¹ä¸­ï¼Œè€ŒFasterTransformerä½œä¸ºæ¨¡å‹æ¨ç†è¿›è¡Œä¼˜åŒ–çš„æ‰§è¡Œå¼•æ“ä»Tritonæ¥æ”¶è¯¥æ‰¹ï¼Œå¹¶ä»¥æ‰¹å¤„ç†çš„æ–¹å¼è¿›è¡Œæ¨ç†è¿‡ç¨‹ã€‚è¿™äº›æ¨¡å‹é€šè¿‡ä¸€ç§å¤šæ¬¡è¿­ä»£çš„è‡ªå›å½’æ–¹å¼å¤„ç†æ–‡æœ¬ï¼ˆå³æ¯æ¬¡ç”Ÿæˆä¸€ä¸ªè¯å…ƒï¼‰ï¼Œè¿™ç»™ç°æœ‰ç³»ç»Ÿå¸¦æ¥äº†ç‰¹å®šçš„æŒ‘æˆ˜ã€‚</p><!-- <p align="center">  <img src="posts_img/Orca/1.png" alt="Description of image" width="700" /></p> --><p><img src="/posts_img/Orca/1.png?50"></p><h1 id="é—®é¢˜é™ˆè¿°"><a href="#é—®é¢˜é™ˆè¿°" class="headerlink" title="é—®é¢˜é™ˆè¿°"></a>é—®é¢˜é™ˆè¿°</h1><p>ç°æœ‰çš„æœåŠ¡åŸºäº Transformer çš„ç”Ÿæˆæ¨¡å‹çš„ç³»ç»Ÿå­˜åœ¨ä»¥ä¸‹å‡ ä¸ªå…³é”®ä½æ•ˆä¹‹å¤„ï¼š</p><ul><li>æ‰¹è°ƒåº¦ï¼šä¸€ä¸ªæ‰¹æ¬¡ä¸­å·²å®Œæˆçš„è¯·æ±‚å¿…é¡»ç­‰å¾…æ•´ä¸ªæ‰¹æ¬¡å®Œæˆï¼Œå¯¼è‡´å»¶è¿Ÿå¢åŠ ã€‚</li><li>æ’é˜Ÿå»¶è¿Ÿï¼šæ–°è¯·æ±‚åœ¨å½“å‰æ‰¹æ¬¡å®Œæˆä¹‹å‰æ— æ³•å¤„ç†ã€‚</li><li>å¤šæ¬¡è¿­ä»£å¼€é”€ï¼šç”±äºæ¯ä¸ªåºåˆ—ä¸­çš„è¯å…ƒå¿…é¡»é€šè¿‡è¿­ä»£å¤„ç†ï¼ŒåŒä¸€æ¨¡å‹éœ€è¦å¤šæ¬¡è°ƒç”¨æ¥å®Œæˆå•ä¸ªæ¨ç†è¯·æ±‚ï¼Œè¿™å½±å“äº†ååé‡ã€‚</li></ul><p><img src="/posts_img/Orca/2.png?50"></p><p>æ³¨æ„ï¼Œåœ¨è¯­è¨€æ¨¡å‹çš„è®­ç»ƒä¸­ä¸ä¼šå‡ºç°æå‰å®Œæˆå’Œå»¶è¿ŸåŠ å…¥è¯·æ±‚çš„é—®é¢˜ï¼›è®­ç»ƒè¿‡ç¨‹é€šè¿‡ä½¿ç”¨teacher forcing techniqueåœ¨ä¸€æ¬¡è¿­ä»£ä¸­å®Œæˆå¯¹æ•´ä¸ªæ‰¹æ¬¡çš„å¤„ç†ã€‚</p><h1 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h1><p>ä½œè€…æå‡ºäº† ORCAï¼Œä¸€ä¸ªä¼˜åŒ–å¤§è§„æ¨¡ Transformer æ¨¡å‹çš„åˆ†å¸ƒå¼æœåŠ¡ç³»ç»Ÿã€‚ORCA å¼•å…¥äº†ä¸¤ä¸ªå…³é”®æŠ€æœ¯ï¼š</p><h2 id="è¿­ä»£çº§è°ƒåº¦"><a href="#è¿­ä»£çº§è°ƒåº¦" class="headerlink" title="è¿­ä»£çº§è°ƒåº¦"></a>è¿­ä»£çº§è°ƒåº¦</h2><p>ä¸å…¶å¯¹æ•´ä¸ªè¯·æ±‚è¿›è¡Œæ‰¹å¤„ç†ï¼ŒORCA å¯¹æ¯æ¬¡è¿­ä»£è¿›è¡Œè°ƒåº¦ï¼š</p><p><img src="/posts_img/Orca/3.png?50"></p><ul><li>æ›´å¿«è¿”å›å·²å®Œæˆçš„è¯·æ±‚ï¼Œå‡å°‘å»¶è¿Ÿã€‚</li><li>åœ¨å½“å‰è¿­ä»£åç«‹å³å¤„ç†æ–°åˆ°çš„è¯·æ±‚ï¼Œå…è®¸æ›´å¿«çš„å“åº”ã€‚</li></ul><h2 id="é€‰æ‹©æ€§æ‰¹å¤„ç†"><a href="#é€‰æ‹©æ€§æ‰¹å¤„ç†" class="headerlink" title="é€‰æ‹©æ€§æ‰¹å¤„ç†"></a>é€‰æ‹©æ€§æ‰¹å¤„ç†</h2><p>é’ˆå¯¹ä¸Šè¿°æ‰€æåˆ°çš„è¿­ä»£çº§è°ƒåº¦çš„æ–¹æ³•ï¼Œåœ¨ä¸€ä¸ªæ‰¹ä¸­çš„è¯·æ±‚æœ‰ä»¥ä¸‹æƒ…å†µï¼š(1) æ‰€å¤„é˜¶æ®µä¸åŒï¼Œprefill &#x2F; decodeã€‚ï¼ˆ2ï¼‰åºåˆ—é•¿åº¦ä¸åŒã€‚è°ƒåº¦å™¨å¸Œæœ›åŒæ—¶å­˜åœ¨è¿™ä¸¤ä¸ªç¬¦åˆæ‰¹å¤„ç†æ¡ä»¶çš„è¯·æ±‚æ‰èƒ½æ‰§è¡Œæ‰¹å¤„ç†ï¼Œéšç€æ‰¹å¤„ç†å¤§å°çš„å¢åŠ ï¼Œè¿™ç§å¯èƒ½æ€§è¿›ä¸€æ­¥å‘ˆæŒ‡æ•°çº§ä¸‹é™ï¼Œå› æ­¤ä½¿ç”¨å¤§æ‰¹å¤„ç†å¤§å°æ¥æé«˜ååé‡è€Œä¸å½±å“å»¶è¿Ÿæ˜¯å›°éš¾çš„ã€‚</p><p><img src="/posts_img/Orca/4.png?100x"></p><p>é’ˆå¯¹æ­¤é—®é¢˜ï¼Œä½œè€…æå‡ºçš„é€‰æ‹©æ€§æ‰¹å¤„ç†æ–¹æ³•ä»…å°†æ‰¹å¤„ç†åº”ç”¨äºç‰¹å®šæ“ä½œï¼ˆä¾‹å¦‚çŸ©é˜µä¹˜æ³•ï¼‰ï¼Œè€Œå¯¹äºæ— æ³•æ‰¹å¤„ç†çš„æ“ä½œï¼ˆå¦‚æ³¨æ„åŠ›æœºåˆ¶ï¼Œè¾“å…¥å¼ é‡å¤§å°å¯å˜çš„æ“ä½œï¼‰åˆ™å•ç‹¬å¤„ç†ï¼Œè¿™ç§é€‰æ‹©æ€§æ–¹æ³•æå‡äº†æ•ˆç‡ï¼Œè€Œä¸ä¼šå¢åŠ é¢å¤–çš„è®¡ç®—æˆæœ¬ã€‚</p><h1 id="è°ƒåº¦ç­–ç•¥"><a href="#è°ƒåº¦ç­–ç•¥" class="headerlink" title="è°ƒåº¦ç­–ç•¥"></a>è°ƒåº¦ç­–ç•¥</h1><p>æœ¬æ–‡ä¸­è°ƒåº¦ç®—æ³•è€ƒè™‘çš„å› ç´ ï¼š</p><ul><li>FCFS</li><li>åœ¨å†…å­˜é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œå°½å¯èƒ½åœ°å¢å¤§batch_sizeä»¥å¢å¤§ååé‡</li></ul><p><img src="/posts_img/Orca/7.png?50"></p><p>é€šè¿‡æµæ°´çº¿å¹¶è¡Œï¼Œè¿­ä»£çº§è°ƒåº¦å¯ä»¥æ¶ˆé™¤bubbleçš„å½±å“</p><p><img src="/posts_img/Orca/8.png?50"></p><h1 id="ç³»ç»Ÿæ¶æ„"><a href="#ç³»ç»Ÿæ¶æ„" class="headerlink" title="ç³»ç»Ÿæ¶æ„"></a>ç³»ç»Ÿæ¶æ„</h1><p>ORCA ä½¿ç”¨äº† <strong>å±‚å†…å¹¶è¡Œ</strong> å’Œ <strong>å±‚é—´å¹¶è¡Œ</strong> æ¨¡å‹æ¥å°†å¤§è§„æ¨¡æ¨¡å‹åˆ†å¸ƒåœ¨å¤šä¸ª GPU ä¸Šã€‚é€šè¿‡é‡‡ç”¨ GPU åˆ†åŒºï¼Œè¯¥ç³»ç»Ÿå¯ä»¥æ‰©å±•åˆ°æ‹¥æœ‰æ•°ç™¾äº¿å‚æ•°çš„ Transformer æ¨¡å‹ï¼ˆå¦‚ GPT-3 175B åŠæ›´å¤§ï¼‰ã€‚</p><table><thead><tr><th align="center"><img src="/posts_img/Orca/5.png" alt="Image 1"></th><th align="center"><img src="/posts_img/Orca/6.png" alt="Image 2"></th></tr></thead></table><p>è¯¥æ¶æ„ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li><strong>è°ƒåº¦å™¨</strong>ï¼šæ ¹æ®è°ƒåº¦ç®—æ³•é€‰æ‹©æ‰¹ã€‚</li><li><strong>å¼•æ“ä¸»æ§</strong>ï¼šç®¡ç†è¿­ä»£çº§è°ƒåº¦ï¼Œå¹¶å°†ä»»åŠ¡åˆ†å‘åˆ° GPUã€‚</li><li><strong>å·¥ä½œå•å…ƒ</strong>ï¼šæ¯ä¸ªå·¥ä½œå•å…ƒè´Ÿè´£æ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥åœ¨å¤šä¸ª GPU ä¹‹é—´å¤„ç†è¯·æ±‚ã€‚</li><li><strong>æ³¨æ„åŠ› K&#x2F;V ç®¡ç†å™¨</strong>ï¼šç®¡ç†å’Œç»´æŠ¤è·¨è¿­ä»£çš„æ³¨æ„åŠ›é”®å€¼å¯¹ï¼Œå…è®¸å…¶ä»–æ“ä½œè¿›è¡Œé€‰æ‹©æ€§æ‰¹å¤„ç†ã€‚</li></ul><h1 id="è¯„ä¼°"><a href="#è¯„ä¼°" class="headerlink" title="è¯„ä¼°"></a>è¯„ä¼°</h1><h2 id="åŸºå‡†æµ‹è¯•"><a href="#åŸºå‡†æµ‹è¯•" class="headerlink" title="åŸºå‡†æµ‹è¯•"></a>åŸºå‡†æµ‹è¯•</h2><p>ORCA ä¸ NVIDIA çš„ FasterTransformer è¿›è¡Œäº†å¯¹æ¯”æµ‹è¯•ï¼Œæµ‹è¯•çš„æ¨¡å‹è§„æ¨¡è¾¾åˆ°äº† 3410 äº¿å‚æ•°ï¼ˆå¦‚ GPT-3ï¼‰ã€‚å®éªŒç»“æœæ˜¾ç¤ºï¼š</p><ul><li>ååé‡æå‡ <strong>36.9</strong> å€ï¼Œå¹¶ä¸”å»¶è¿Ÿä¿æŒç›¸åŒã€‚</li><li>ç”±äºè¿­ä»£çº§è°ƒåº¦ï¼Œ<strong>æ’é˜Ÿæ—¶é—´</strong> æ˜¾è‘—å‡å°‘ï¼Œä»è€ŒåŠ å¿«å“åº”é€Ÿåº¦ã€‚</li><li>åœ¨ä¸åŒçš„æ‰¹å¤„ç†è§„æ¨¡å’Œå·¥ä½œè´Ÿè½½ä¸‹ï¼ŒORCA æ˜¾è‘—ä¼˜äºä¼ ç»Ÿç³»ç»Ÿã€‚</li></ul><p><img src="/posts_img/Orca/9.png?50"></p><h1 id="å…ˆå‰å·¥ä½œå’Œè®¨è®º"><a href="#å…ˆå‰å·¥ä½œå’Œè®¨è®º" class="headerlink" title="å…ˆå‰å·¥ä½œå’Œè®¨è®º"></a>å…ˆå‰å·¥ä½œå’Œè®¨è®º</h1><h2 id="BatchMaker-ç³»ç»Ÿ"><a href="#BatchMaker-ç³»ç»Ÿ" class="headerlink" title="BatchMaker ç³»ç»Ÿ"></a>BatchMaker ç³»ç»Ÿ</h2><p>BatchMaker æ˜¯ä¸€ä¸ªç”¨äº RNNï¼ˆå¾ªç¯ç¥ç»ç½‘ç»œï¼‰çš„æœåŠ¡ç³»ç»Ÿï¼Œèƒ½å¤Ÿä»¥ RNN å•å…ƒçš„ç²’åº¦è¿›è¡Œè°ƒåº¦å’Œæ‰¹å¤„ç†ã€‚ç”±äº RNN æ¯ä¸ªå•å…ƒæ‰§è¡Œç›¸åŒçš„è®¡ç®—ï¼Œå› æ­¤å¯ä»¥å°†ç›¸åŒçš„å•å…ƒè¿›è¡Œæ‰¹å¤„ç†ï¼Œå³ä½¿å®ƒä»¬å¤„äºä¸åŒçš„ä½ç½®ï¼ˆå³ä¸åŒçš„è¯å…ƒç´¢å¼•ï¼‰ã€‚è¿™ç§çµæ´»æ€§å…è®¸æ–°åˆ°è¾¾çš„è¯·æ±‚åŠ å…¥å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ‰¹æ¬¡ï¼Œè€Œä¸éœ€è¦ç­‰å¾…æ•´ä¸ªæ‰¹æ¬¡å®Œæˆã€‚</p><p>ç„¶è€Œï¼ŒBatchMaker æ— æ³•å¯¹ Transformer æ¨¡å‹è¿›è¡ŒåŒæ ·çš„æ‰¹å¤„ç†ï¼Œå› ä¸º Transformer ä¸­æ¯ä¸ªå•å…ƒï¼ˆå¦‚æ³¨æ„åŠ›æœºåˆ¶ä¸­çš„é”®å€¼å¯¹ï¼‰éšè¯å…ƒç´¢å¼•å˜åŒ–è€Œä¸åŒã€‚å› æ­¤ï¼ŒBatchMaker åœ¨å¤„ç†ä¸åŒè¯å…ƒæ—¶æ— æ³•å®ç°æ‰¹å¤„ç†ï¼Œå¯¼è‡´å¤„ç†å¤§å¤šæ˜¯ä¸²è¡Œçš„ï¼Œå¹¶ä¸”æ— æ³•æ”¯æŒå¤§è§„æ¨¡æ¨¡å‹çš„å¹¶è¡Œè®­ç»ƒã€‚</p><h2 id="ORCA-çš„æ”¹è¿›"><a href="#ORCA-çš„æ”¹è¿›" class="headerlink" title="ORCA çš„æ”¹è¿›"></a>ORCA çš„æ”¹è¿›</h2><p>ç›¸æ¯”äº BatchMakerï¼ŒORCA çš„è®¾è®¡åŸºäºæœ€å¤§åŒ–æ¯æ¬¡æ¨¡å‹å‚æ•°è¯»å–æ—¶çš„è®¡ç®—æ•ˆç‡ã€‚è¿™æ˜¯å› ä¸ºå¯¹äºå¤§æ¨¡å‹æ¥è¯´ï¼Œä» GPU å…¨å±€å†…å­˜è¯»å–å‚æ•°æ˜¯å½±å“æ•´ä½“æ‰§è¡Œæ—¶é—´çš„ä¸»è¦ç“¶é¢ˆã€‚ORCA é€šè¿‡è¿­ä»£çº§è°ƒåº¦å’Œé€‰æ‹©æ€§æ‰¹å¤„ç†æ¥å¤„ç†æ‰€æœ‰å·²å‡†å¤‡å¥½çš„è¯å…ƒï¼Œæ— è®ºå®ƒä»¬æ˜¯å¦å¯ä»¥è¢«æ‰¹å¤„ç†ï¼ˆå¦‚ Attention æ“ä½œä¸èƒ½è¢«æ‰¹å¤„ç†ï¼‰ã€‚</p><h2 id="é’ˆå¯¹-Transformer-æ¨¡å‹çš„ä¸“ç”¨æ¨ç†å¼•æ“"><a href="#é’ˆå¯¹-Transformer-æ¨¡å‹çš„ä¸“ç”¨æ¨ç†å¼•æ“" class="headerlink" title="é’ˆå¯¹ Transformer æ¨¡å‹çš„ä¸“ç”¨æ¨ç†å¼•æ“"></a>é’ˆå¯¹ Transformer æ¨¡å‹çš„ä¸“ç”¨æ¨ç†å¼•æ“</h2><p>Transformer æ¨¡å‹çš„æ€§èƒ½ä¿ƒä½¿äº†ä¸“é—¨çš„æ¨ç†ç³»ç»Ÿçš„å‘å±•ï¼Œå¦‚ FasterTransformerã€LightSeqã€TurboTransformers ç­‰ã€‚è¿™äº›ç³»ç»Ÿä¸»è¦ä½œä¸ºç°æœ‰æœåŠ¡ç³»ç»Ÿï¼ˆå¦‚ Triton æˆ– TensorFlow Servingï¼‰çš„åç«¯æ¨ç†å¼•æ“ï¼Œä»é‡‡ç”¨ä¼ ç»Ÿçš„è¯·æ±‚çº§è°ƒåº¦ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒORCA é€šè¿‡å¼•å…¥æ›´ç»†ç²’åº¦çš„è°ƒåº¦æœºåˆ¶æ¥æå‡æ•ˆç‡ã€‚</p><h2 id="æœåŠ¡ç³»ç»Ÿä¸æ¨ç†å¼•æ“çš„æ¥å£"><a href="#æœåŠ¡ç³»ç»Ÿä¸æ¨ç†å¼•æ“çš„æ¥å£" class="headerlink" title="æœåŠ¡ç³»ç»Ÿä¸æ¨ç†å¼•æ“çš„æ¥å£"></a>æœåŠ¡ç³»ç»Ÿä¸æ¨ç†å¼•æ“çš„æ¥å£</h2><p>å½“å‰çš„é€šç”¨æœåŠ¡ç³»ç»Ÿå¦‚ Triton å’Œ Clipper æä¾›äº†æŠ½è±¡å±‚æ¥å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¹¶è°ƒåº¦åº•å±‚çš„æ¨ç†å¼•æ“ã€‚è™½ç„¶è¿™ç§è®¾è®¡åˆ†ç¦»äº†æœåŠ¡å±‚å’Œæ‰§è¡Œå±‚çš„å®ç°ï¼Œä½†åœ¨å¤„ç†åƒ GPT è¿™ç§å¤šè¿­ä»£ç‰¹æ€§çš„æ¨¡å‹æ—¶å­˜åœ¨å±€é™æ€§ã€‚ORCA é€šè¿‡ç´§å¯†é›†æˆè°ƒåº¦å™¨ä¸å¼•æ“ï¼Œç®€åŒ–äº†è¿­ä»£çº§è°ƒåº¦å’Œé€‰æ‹©æ€§æ‰¹å¤„ç†çš„åº”ç”¨ã€‚</p><h1 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h1><p>ORCA åœ¨å¤„ç† Transformer æ¨¡å‹çš„å¤šæ¬¡è¿­ä»£å’Œè‡ªå›å½’ç‰¹æ€§æ–¹é¢æ˜¾ç¤ºå‡ºæ˜¾è‘—çš„æ”¹è¿›ã€‚<strong>è¿­ä»£çº§è°ƒåº¦</strong> å’Œ <strong>é€‰æ‹©æ€§æ‰¹å¤„ç†</strong> ç­–ç•¥ä½¿ ORCA èƒ½å¤Ÿé«˜æ•ˆå¤„ç†å¤§è§„æ¨¡ç”Ÿæˆæ¨¡å‹ï¼Œæå‡äº†ç³»ç»Ÿçš„æ€§èƒ½å’Œå“åº”é€Ÿåº¦ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Paper Report </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OSDI 2022 </tag>
            
            <tag> LLM </tag>
            
            <tag> Inference </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MOEåŸºç¡€ä»‹ç»</title>
      <link href="/2024/09/13/MOE-Intro/"/>
      <url>/2024/09/13/MOE-Intro/</url>
      
        <content type="html"><![CDATA[<p>MOEé‡è¦æ€§ï¼šåŠé—´ä¸€ç›´æµä¼ GPT-4æ˜¯MoEæ¨¡å‹<br>æœ¬æ–‡ä¸»è¦å‚è€ƒè‡ªï¼š<a href="https://huggingface.co/blog/zh/moe">https://huggingface.co/blog/zh/moe</a></p><h1 id="ä»€ä¹ˆæ˜¯MOE"><a href="#ä»€ä¹ˆæ˜¯MOE" class="headerlink" title="ä»€ä¹ˆæ˜¯MOE"></a>ä»€ä¹ˆæ˜¯MOE</h1><p>åŸºäº Transformer æ¶æ„çš„æ¨¡å‹ï¼Œæ··åˆä¸“å®¶æ¨¡å‹ä¸»è¦ç”±ä¸¤ä¸ªå…³é”®éƒ¨åˆ†ç»„æˆ:</p><p>â— <strong>ç¨€ç– MoE å±‚</strong>: è¿™äº›å±‚ä»£æ›¿äº†ä¼ ç»Ÿ Transformer æ¨¡å‹ä¸­çš„å‰é¦ˆç½‘ç»œ (FFN) å±‚ã€‚MoE å±‚åŒ…å«è‹¥å¹²â€œä¸“å®¶â€(ä¾‹å¦‚ 8 ä¸ª)ï¼Œæ¯ä¸ªä¸“å®¶æœ¬èº«æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç¥ç»ç½‘ç»œã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™äº›ä¸“å®¶é€šå¸¸æ˜¯å‰é¦ˆç½‘ç»œ (FFN)ï¼Œä½†å®ƒä»¬ä¹Ÿå¯ä»¥æ˜¯æ›´å¤æ‚çš„ç½‘ç»œç»“æ„ï¼Œç”šè‡³å¯ä»¥æ˜¯ MoE å±‚æœ¬èº«ï¼Œä»è€Œå½¢æˆå±‚çº§å¼çš„ MoE ç»“æ„ã€‚</p><p>â— <strong>é—¨æ§ç½‘ç»œæˆ–è·¯ç”±</strong>: è¿™ä¸ªéƒ¨åˆ†ç”¨äºå†³å®šå“ªäº›ä»¤ç‰Œ (token) è¢«å‘é€åˆ°å“ªä¸ªä¸“å®¶ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸‹å›¾ä¸­ï¼Œâ€œMoreâ€è¿™ä¸ªä»¤ç‰Œå¯èƒ½è¢«å‘é€åˆ°ç¬¬äºŒä¸ªä¸“å®¶ï¼Œè€Œâ€œParametersâ€è¿™ä¸ªä»¤ç‰Œè¢«å‘é€åˆ°ç¬¬ä¸€ä¸ªä¸“å®¶ã€‚æœ‰æ—¶ï¼Œä¸€ä¸ªä»¤ç‰Œç”šè‡³å¯ä»¥è¢«å‘é€åˆ°å¤šä¸ªä¸“å®¶ã€‚ä»¤ç‰Œçš„è·¯ç”±æ–¹å¼æ˜¯ MoE ä½¿ç”¨ä¸­çš„ä¸€ä¸ªå…³é”®ç‚¹ï¼Œå› ä¸ºè·¯ç”±å™¨ç”±å­¦ä¹ çš„å‚æ•°ç»„æˆï¼Œå¹¶ä¸”ä¸ç½‘ç»œçš„å…¶ä»–éƒ¨åˆ†ä¸€åŒè¿›è¡Œé¢„è®­ç»ƒã€‚</p><p><img src="/posts_img/MOE-Intro/1.png"></p><div style="text-align: center;">  <a href="https://arxiv.org/pdf/1701.06538">Outrageously Large Neural Network è®ºæ–‡ä¸­çš„ MoE layer</a></div><p><img src="/posts_img/MOE-Intro/2.png"></p><div style="text-align: center;">  <a href="https://arxiv.org/pdf/2101.03961">Switch Transformers paper è®ºæ–‡ä¸­çš„ MoE layer</a></div><h1 id="æ··åˆä¸“å®¶æ¨¡å‹ï¼ˆMoEsï¼‰ç®€çŸ­æ€»ç»“"><a href="#æ··åˆä¸“å®¶æ¨¡å‹ï¼ˆMoEsï¼‰ç®€çŸ­æ€»ç»“" class="headerlink" title="æ··åˆä¸“å®¶æ¨¡å‹ï¼ˆMoEsï¼‰ç®€çŸ­æ€»ç»“"></a>æ··åˆä¸“å®¶æ¨¡å‹ï¼ˆMoEsï¼‰ç®€çŸ­æ€»ç»“</h1><h2 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h2><p>â— ä¸ç¨ å¯†æ¨¡å‹ç›¸æ¯”ï¼Œ<strong>é¢„è®­ç»ƒé€Ÿåº¦æ›´å¿«</strong><br>â— ä¸å…·æœ‰ç›¸åŒå‚æ•°æ•°é‡çš„æ¨¡å‹ç›¸æ¯”ï¼Œå…·æœ‰æ›´å¿«çš„Â <strong>æ¨ç†é€Ÿåº¦</strong><br>â— ä¸å…·æœ‰ç›¸åŒæ¿€æ´»å‚æ•°çš„ç¨ å¯†æ¨¡å‹æ¨¡å‹ç›¸æ¯”ï¼Œå…·æœ‰æ›´é«˜çš„ <strong>æ¨ç†ç²¾åº¦</strong></p><h2 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h2><p>â— éœ€è¦Â <strong>å¤§é‡æ˜¾å­˜</strong>ï¼Œå› ä¸ºæ‰€æœ‰ä¸“å®¶ç³»ç»Ÿéƒ½éœ€è¦åŠ è½½åˆ°å†…å­˜ä¸­ï¼ˆç°æœ‰offloadæŠ€æœ¯ï¼‰<br>â— åœ¨Â <strong>å¾®è°ƒæ–¹é¢</strong> å­˜åœ¨è¯¸å¤šæŒ‘æˆ˜ï¼Œä½†Â <a href="https://arxiv.org/pdf/2305.14705">è¿‘æœŸçš„ç ”ç©¶</a> è¡¨æ˜ï¼Œå¯¹æ··åˆä¸“å®¶æ¨¡å‹è¿›è¡ŒæŒ‡ä»¤è°ƒä¼˜å…·æœ‰å¾ˆå¤§çš„æ½œåŠ›<br>â— ä¸åŒçš„ä¸“å®¶å€¾å‘äºä¸“æ³¨äºä¸åŒçš„ <strong>è¯­ä¹‰</strong>ï¼Œè€Œä¸æ˜¯ç‰¹å®š <strong>é¢†åŸŸ</strong><br>â— ç”±äºè®¾å¤‡é—´éœ€è¦ä¼ é€’æ•°æ®ï¼Œç½‘ç»œå¸¦å®½å¸¸å¸¸æˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œåº”é‡‡å–é€‚å½“çš„å¹¶è¡ŒåŒ–ç­–ç•¥ï¼ˆ3Då¹¶è¡Œ+ä¸“å®¶å¹¶è¡Œï¼‰</p><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p>[1] Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer (2017)<br>[2] Switch Transformers: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity (Jan 2022)</p>]]></content>
      
      
      <categories>
          
          <category> Intro </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLM </tag>
            
            <tag> MOE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MOEåˆ©ç”¨Offloadè¿›è¡Œé«˜æ•ˆæ¨ç†</title>
      <link href="/2024/09/12/MOE-Offloading/"/>
      <url>/2024/09/12/MOE-Offloading/</url>
      
        <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« æå‡ºäº†å¦‚ä½•åœ¨èµ„æºå—é™çš„æ¶ˆè´¹çº§ç¡¬ä»¶ä¸Šé«˜æ•ˆåœ°è¿è¡Œç¨€ç–ä¸“å®¶æ··åˆï¼ˆMoEï¼‰è¯­è¨€æ¨¡å‹çš„æ–¹æ³•ã€‚å°†Mixtral-8x7Bè¿™ä¸ªéœ€è¦100Gä»¥ä¸Šç®—åŠ›æ‰èƒ½éƒ¨ç½²çš„æ¨¡å‹åœ¨12Gæ˜¾å­˜+11Gå†…å­˜çš„ç»„åˆä¸‹è·‘å‡ºæ¥ã€‚<br>è®ºæ–‡ï¼š<a href="https://arxiv.org/abs/2312.17238">https://arxiv.org/abs/2312.17238</a><br>Colabä»£ç ï¼š<a href="https://colab.research.google.com/drive/1ZkC0k487oBEF19R8_9nq2MSHFyQ6OspG?usp=drive_link">https://colab.research.google.com/drive/1ZkC0k487oBEF19R8_9nq2MSHFyQ6OspG?usp=drive_link</a></p><h1 id="å¼•è¨€ä¸èƒŒæ™¯"><a href="#å¼•è¨€ä¸èƒŒæ™¯" class="headerlink" title="å¼•è¨€ä¸èƒŒæ™¯"></a>å¼•è¨€ä¸èƒŒæ™¯</h1><p>è®ºæ–‡çš„å¼•è¨€éƒ¨åˆ†ä»‹ç»äº†å¤§è§„æ¨¡é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰åœ¨è‡ªç„¶è¯­è¨€å¤„ç†é¢†åŸŸçš„é‡è¦æ€§ã€‚è¿™äº›æ¨¡å‹å¦‚GPT-3ã€GPT-4ä»¥åŠå…¶ä»–å¼€æ”¾è®¿é—®çš„LLMsï¼ˆå¦‚LLaMAã€Falconã€BLOOMç­‰ï¼‰æ¨åŠ¨äº†è¯­è¨€æŠ€æœ¯çš„è¿…çŒ›å‘å±•ã€‚ç„¶è€Œï¼ŒLLMs çš„åºå¤§å‚æ•°é‡ä½¿å¾—å®ƒä»¬çš„æ¨ç†æˆæœ¬æé«˜ï¼Œé€šå¸¸éœ€è¦é«˜ç«¯çš„GPUè®¾å¤‡æ‰èƒ½è¿è¡Œï¼Œé™åˆ¶äº†å®ƒä»¬åœ¨æ™®é€šç¡¬ä»¶ä¸Šçš„ä½¿ç”¨ã€‚<br>ä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œç¨€ç–çš„ä¸“å®¶æ··åˆï¼ˆMoEï¼‰æ¨¡å‹è¢«æå‡ºã€‚MoEé€šè¿‡åªæ¿€æ´»æ¨¡å‹ä¸­çš„ä¸€éƒ¨åˆ†â€œä¸“å®¶â€æ¥è®¡ç®—æ¯ä¸ªè¾“å…¥ï¼Œä»è€Œæé«˜äº†è®¡ç®—æ•ˆç‡ã€‚ç„¶è€Œï¼ŒMoEæ¨¡å‹çš„è§„æ¨¡ä¾ç„¶åºå¤§ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦å¤šGPUçš„ç¯å¢ƒä¸‹ã€‚å› æ­¤ï¼Œå¦‚ä½•åœ¨æ¶ˆè´¹çº§ç¡¬ä»¶ä¸Šè¿è¡Œè¿™äº›æ¨¡å‹æ˜¯ä¸€ä¸ªé‡è¦çš„ç ”ç©¶é—®é¢˜ã€‚</p><h1 id="ä¸‰å¤§è§£å†³ç­–ç•¥"><a href="#ä¸‰å¤§è§£å†³ç­–ç•¥" class="headerlink" title="ä¸‰å¤§è§£å†³ç­–ç•¥"></a>ä¸‰å¤§è§£å†³ç­–ç•¥</h1><p>Mixtral-8x7Bæ¨¡å‹ä¸­çš„æ€»å‚æ•°ä¸º46.7äº¿ï¼Œä¸“å®¶æ„æˆ45.1äº¿ï¼ˆ96.6%ï¼‰ï¼Œåœ¨å†…å­˜å—é™çš„æƒ…å†µä¸‹ï¼Œå‡å°‘ä¸“å®¶åˆ‡æ¢æ—¶GPUä¸RAMä¹‹é—´çš„æ•°æ®ä¼ è¾“å¯¹MoEæ¨¡å‹è¿›è¡Œæ¨ç†å¾ˆå…³é”®ã€‚ä½œè€…ä¸»è¦æå‡ºé€šè¿‡LRUç¼“å­˜ï¼ˆLRU cachingï¼‰å’Œä¸“å®¶çš„æ¨æµ‹æ€§æå‰åŠ è½½ï¼ˆSpeculative Expert Loadingï¼‰æ¥å‡å°‘GPUä¸RAMä¹‹é—´çš„æ•°æ®ä¼ è¾“ï¼Œä»è€ŒåŠ é€Ÿæ¨ç†è¿‡ç¨‹ã€‚å…³é”®åˆ›æ–°ç‚¹åŒ…æ‹¬ï¼š</p><ol><li><p>LRUç¼“å­˜ä¸“å®¶é‡ç”¨æ¨¡å¼ï¼šMoEæ¨¡å‹åœ¨å¤„ç†è¿ç»­çš„tokenæ—¶ï¼ŒæŸäº›ä¸“å®¶ä¼šè¢«é¢‘ç¹åœ°é‡ç”¨ã€‚å› æ­¤ï¼Œä½œè€…è®¾è®¡äº†ä¸€ç§LRUç¼“å­˜æœºåˆ¶ï¼Œåˆ©ç”¨è¿™ç§ä¸“å®¶é‡ç”¨çš„è§„å¾‹æ¥å‡å°‘GPU-RAMä¹‹é—´çš„é€šä¿¡å¼€é”€ã€‚<br><img src="/posts_img/MOE-Offloading/1.png"></p></li><li><p>æ¨æµ‹æ€§ä¸“å®¶åŠ è½½ï¼šç”±äºæ¨ç†è¿‡ç¨‹ä¸­æ— æ³•æå‰ç¡®å®šä¸‹ä¸€å±‚éœ€è¦åŠ è½½çš„ä¸“å®¶ï¼Œå› æ­¤ä½œè€…æå‡ºäº†ä¸€ç§åŸºäºæ¨æµ‹çš„åŠ è½½æœºåˆ¶ï¼Œé€šè¿‡å¯¹å‰ä¸€å±‚çš„éšè—çŠ¶æ€åº”ç”¨ä¸‹ä¸€å±‚çš„é—¨æ§å‡½æ•°æ¥çŒœæµ‹å³å°†éœ€è¦çš„ä¸“å®¶ï¼ˆå¯èƒ½æ˜¯å› ä¸ºæœ‰residualçš„åŸå› ï¼‰ã€‚è¿™ç§æœºåˆ¶åœ¨æ¨æµ‹æ­£ç¡®æ—¶ï¼Œä¸‹ä¸€å±‚çš„è®¡ç®—å¯ä»¥ç«‹å³å¼€å§‹ï¼Œæ˜¾è‘—å‡å°‘äº†æ¨ç†å»¶è¿Ÿã€‚</p></li><li><p>æ··åˆé‡åŒ–æŠ€æœ¯ï¼šåœ¨æ¨¡å‹å‹ç¼©æ–¹é¢ï¼Œä½œè€…ä½¿ç”¨äº†ä¸€ç§åŠäºŒæ¬¡é‡åŒ–ï¼ˆHalf Quadratic Quantization, HQQï¼‰çš„æ–¹æ³•å¯¹ä¸“å®¶å±‚è¿›è¡Œæ›´é«˜çš„å‹ç¼©ï¼ŒåŒæ—¶ä¿æŒå…¶ä»–å±‚çš„è¾ƒé«˜ç²¾åº¦ã€‚è¿™ç§é‡åŒ–ç­–ç•¥æœ‰æ•ˆå‡å°‘äº†æ¨¡å‹å¤§å°ï¼Œå¹¶ä¿æŒäº†è¾ƒå¥½çš„æ¨ç†æ€§èƒ½ã€‚</p></li></ol><h1 id="å®éªŒä¸è¯„ä¼°"><a href="#å®éªŒä¸è¯„ä¼°" class="headerlink" title="å®éªŒä¸è¯„ä¼°"></a>å®éªŒä¸è¯„ä¼°</h1><h2 id="æ¨¡å‹"><a href="#æ¨¡å‹" class="headerlink" title="æ¨¡å‹"></a>æ¨¡å‹</h2><p>ç”¨åˆ°çš„æ¨¡å‹ï¼šMixtral 8x7B ï¼Œä¸€ä¸ªä¸»æµçš„MOEæ¨¡å‹ï¼Œåœ¨å¤§å¤šæ•°åŸºå‡†æµ‹è¯•ä¸­ä¼˜äºæˆ–ç­‰ä»·äºLlama2 70B, GPT3.5ï¼Œä¸”æ¨ç†é€Ÿåº¦æ¯”Llama2 70Bå¿«å…­å€ï¼<br>Mixtral 8x7B æ˜¯decoder-only model, å…¶ä¸­ FFN ä»8ä¸ªä¸åŒçš„å‚æ•°ç»„ï¼ˆä¸“å®¶ï¼‰ä¸­è¿›è¡ŒæŒ‘é€‰ï¼Œåœ¨æ¯ä¸€å±‚ï¼Œæ¯ä¸ªtoken, router network éƒ½ä¼šé€‰2ä¸ªç»„æ¥è¿›è¡Œç”Ÿæˆå¹¶è¿›è¡Œç»„åˆï¼š</p><ol><li>æ”¯æŒ32Kä¸Šä¸‹æ–‡</li><li>æ”¯æŒè‹±è¯­ï¼Œæ³•è¯­ï¼Œæ„å¤§åˆ©è¯­ï¼Œå¾·è¯­ï¼Œè¥¿ç­ç‰™è¯­ï¼ˆä¸­æ–‡æ”¯æŒå¾ˆå·®ï¼‰</li><li>åœ¨ä»£ç ç”Ÿæˆä¸Šå¾ˆå¼º</li><li>èƒ½è¢«å¾®è°ƒæˆä¸€ä¸ªé«˜åˆ†ï¼ˆMT-Benchï¼‰çš„ instruction-following model</li></ol><h2 id="è¯„ä¼°ç»“è®º"><a href="#è¯„ä¼°ç»“è®º" class="headerlink" title="è¯„ä¼°ç»“è®º"></a>è¯„ä¼°ç»“è®º</h2><p>è®ºæ–‡åœ¨ä¸åŒç¡¬ä»¶é…ç½®ï¼ˆå¦‚RTX 3060ã€T4ç­‰ï¼‰ä¸‹å¯¹æå‡ºçš„æ–¹æ³•è¿›è¡Œäº†è¯¦å°½çš„å®éªŒè¯„ä¼°ï¼Œå¾—å‡ºäº†ä»¥ä¸‹å‡ ä¸ªä¸»è¦ç»“è®ºï¼š</p><ol><li><p>ä¸“å®¶ç¼“å­˜ä¸æ¨æµ‹åŠ è½½çš„æœ‰æ•ˆæ€§ï¼šé€šè¿‡æµ‹è¯•ä¸åŒç¼“å­˜å¤§å°å’Œæå‰åŠ è½½çš„ä¸“å®¶æ•°é‡ï¼Œä½œè€…å‘ç°ç¼“å­˜å‘½ä¸­ç‡å’Œæ¨æµ‹åŠ è½½çš„å‡†ç¡®ç‡æ˜¾è‘—æé«˜äº†æ¨¡å‹çš„æ¨ç†é€Ÿåº¦ã€‚ä¾‹å¦‚ï¼Œåœ¨ç¼“å­˜å¤§å°ä¸º4æ—¶ï¼Œç¼“å­˜å‘½ä¸­ç‡å¯ä»¥è¾¾åˆ°çº¦0.8ï¼Œæ¨æµ‹åŠ è½½å¤§å°ä¸º2æ—¶ï¼Œæ¨æµ‹åŠ è½½çš„å‡†ç¡®ç‡åˆ™å¯è¾¾åˆ°0.9ä»¥ä¸Šã€‚<br><img src="/posts_img/MOE-Offloading/2.png"></p></li><li><p>é‡åŒ–å¯¹æ¨¡å‹æ€§èƒ½çš„å½±å“ï¼šé€šè¿‡å¯¹æ¨¡å‹è¿›è¡Œä¸åŒé‡åŒ–æ¯”ç‰¹çš„æµ‹è¯•ï¼Œä½œè€…éªŒè¯äº†åœ¨ä¿æŒè¾ƒå¥½å‡†ç¡®ç‡çš„åŒæ—¶ï¼Œé‡åŒ–å¯ä»¥æœ‰æ•ˆå‡å°‘æ¨¡å‹å¤§å°ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨2-bité‡åŒ–æ—¶ï¼Œæ¨¡å‹çš„æ¨ç†å»¶è¿Ÿæ˜¾è‘—é™ä½ï¼ŒåŒæ—¶åœ¨WikiText2å’ŒC4æ•°æ®é›†ä¸Šçš„å›°æƒ‘åº¦ä»…ç•¥æœ‰ä¸Šå‡ã€‚</p></li><li><p>å®é™…æ¨ç†æ€§èƒ½ï¼šåœ¨ä½¿ç”¨å®Œæ•´çš„ç®—æ³•æ—¶ï¼Œæ¶ˆè´¹çº§ç¡¬ä»¶ä¸Šå¦‚RTX 3060å’ŒT4å¯ä»¥è¾¾åˆ°æ¯ç§’ç”Ÿæˆ2-3ä¸ªtokençš„æ€§èƒ½ï¼Œè¿œè¿œä¼˜äºç›´æ¥åœ¨è®¾å¤‡å†…å­˜ä¸è¶³çš„æƒ…å†µä¸‹æ¨ç†æ—¶çš„æ€§èƒ½è¡¨ç°ã€‚<br><img src="/posts_img/MOE-Offloading/3.png"></p></li></ol><h1 id="ç»“è®ºä¸æœªæ¥å·¥ä½œ"><a href="#ç»“è®ºä¸æœªæ¥å·¥ä½œ" class="headerlink" title="ç»“è®ºä¸æœªæ¥å·¥ä½œ"></a>ç»“è®ºä¸æœªæ¥å·¥ä½œ</h1><p>è®ºæ–‡æ€»ç»“äº†è¯¥æ–¹æ³•åœ¨æ¨ç†é€Ÿåº¦ä¸Šç›¸è¾ƒäºä¼ ç»Ÿçš„åŠ è½½æ–¹å¼æœ‰æ˜¾è‘—æé«˜ï¼Œå°¤å…¶æ˜¯åœ¨æ¶ˆè´¹çº§ç¡¬ä»¶å’Œå…è´¹äº‘å¹³å°ï¼ˆå¦‚Google Colabï¼‰ä¸Šï¼Œä½¿å¾—å¤§è§„æ¨¡ç¨€ç–MoEæ¨¡å‹çš„ä½¿ç”¨æ›´åŠ å¹¿æ³›åŒ–ã€‚æœªæ¥çš„ç ”ç©¶æ–¹å‘å¯èƒ½åŒ…æ‹¬è¿›ä¸€æ­¥ä¼˜åŒ–ä¸“å®¶é¢„æµ‹åŠ è½½ç®—æ³•ï¼Œæ¢ç´¢å…¶ä»–çš„æ¨ç†åŠ é€Ÿæ–¹æ³•ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™ç¯‡è®ºæ–‡è§£å†³äº†å¤§è§„æ¨¡ç¨€ç–ä¸“å®¶æ¨¡å‹åœ¨æ¨ç†æ—¶çš„ç¡¬ä»¶ç“¶é¢ˆé—®é¢˜ï¼Œæå‡ºäº†ä¸€ç§é€šè¿‡ä¸“å®¶ç¼“å­˜ä¸é¢„æµ‹åŠ è½½æ¥ä¼˜åŒ–æ¨ç†é€Ÿåº¦çš„æ–¹æ¡ˆï¼Œå¹¶ä½¿ç”¨æ··åˆé‡åŒ–æŠ€æœ¯åœ¨ä¿è¯å‡†ç¡®ç‡çš„åŒæ—¶å¤§å¹…å‡å°‘äº†æ¨¡å‹å¤§å°å’Œæ¨ç†æ—¶é—´ã€‚å¯¹äºå¸Œæœ›åœ¨ä½ç«¯ç¡¬ä»¶ä¸Šä½¿ç”¨å¤§è§„æ¨¡è¯­è¨€æ¨¡å‹çš„ç ”ç©¶äººå‘˜æ¥è¯´ï¼Œæœ¬æ–‡çš„è´¡çŒ®æä¾›äº†ä¸€ä¸ªå…·æœ‰å®ç”¨ä»·å€¼çš„è§£å†³æ–¹æ¡ˆã€‚</p><h1 id="Ideas"><a href="#Ideas" class="headerlink" title="Ideas"></a>Ideas</h1><ol><li>â€œNote that out of 46.7B total parameters in the Mixtral-8x7B model, the experts constitute 45.1B (96.6%).â€ ä¸“å®¶å‚æ•°å äº†ä¸»å¯¼ä½ç½®ï¼Œè¿™ç§å¼‚æ„å‹èƒ½å¦ç”¨äºè¾¹ç¼˜-äº‘ç«¯è®¡ç®—ï¼Œéšç§ä¿æŠ¤ç­‰</li><li>å¯¹äºå¤šç”¨æˆ·å¤šå¯¹è¯çš„åœ¨çº¿æ¨ç†æœåŠ¡ç³»ç»Ÿï¼Œé‡‡å–æ‰¹é‡ã€å¹¶è¡Œçš„ç­–ç•¥åˆç†ä½¿ç”¨expertså‚æ•°ï¼Œå¢åŠ ååã€é™ä½å»¶è¿Ÿç­‰</li><li>å°†è¿™ç§offloadæ–¹æ³•å¼•å…¥åˆ°è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥æ˜¾è‘—æ‰©å¤§æ¨¡å‹æˆ–æ•°æ®é›†çš„è§„æ¨¡</li></ol>]]></content>
      
      
      <categories>
          
          <category> Paper Report </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLM </tag>
            
            <tag> Inference </tag>
            
            <tag> MOE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2024/09/12/hello-world/"/>
      <url>/2024/09/12/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><p>åšå®¢æ­å»ºå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/mjh1667002013/article/details/129290903">ã€Hexoã€‘Hexoæ­å»ºButterflyä¸»é¢˜å¹¶å¿«é€Ÿç¾åŒ–_hexo butterfly-CSDNåšå®¢</a></p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
